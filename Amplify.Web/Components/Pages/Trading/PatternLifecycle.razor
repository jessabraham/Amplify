@page "/pattern-lifecycle"
@rendermode InteractiveServer
@inject PatternScannerApiClient ScannerApi
@inject AuthStateProvider AuthState
@inject NavigationManager Nav
@using Amplify.Web.Services

<div class="page-container">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2 style="color: var(--text-heading); display: flex; align-items: center; gap: 8px;">
            <i class="ph-duotone ph-heartbeat" style="color: var(--accent-cyan);"></i>
            Pattern Lifecycle
        </h2>
        <button class="btn btn-secondary" @onclick="LoadData" disabled="@_loading">
            <i class="ph ph-arrow-clockwise"></i> Refresh
        </button>
    </div>

    @if (_data is not null)
    {
        <!-- Summary Stats -->
        <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 12px; margin-bottom: 24px;">
            <div class="stat-card" @onclick='() => SetFilter("Active")' style="cursor:pointer; @(GetFilterHighlight("Active"))">
                <div class="stat-label">🟢 ACTIVE</div>
                <div class="stat-value" style="color: var(--accent-green);">@SymbolFilteredPatterns.Count(p => p.Status == "Active")</div>
            </div>
            <div class="stat-card" @onclick='() => SetFilter("PlayingOut")' style="cursor:pointer; @(GetFilterHighlight("PlayingOut"))">
                <div class="stat-label">🔵 PLAYING OUT</div>
                <div class="stat-value" style="color: var(--accent-cyan);">@SymbolFilteredPatterns.Count(p => p.Status == "PlayingOut")</div>
            </div>
            <div class="stat-card" @onclick='() => SetFilter("HitTarget")' style="cursor:pointer; @(GetFilterHighlight("HitTarget"))">
                <div class="stat-label">✅ HIT TARGET</div>
                <div class="stat-value" style="color: var(--accent-green);">@SymbolFilteredPatterns.Count(p => p.Status == "HitTarget")</div>
            </div>
            <div class="stat-card" @onclick='() => SetFilter("HitStop")' style="cursor:pointer; @(GetFilterHighlight("HitStop"))">
                <div class="stat-label">❌ HIT STOP</div>
                <div class="stat-value" style="color: var(--accent-red);">@SymbolFilteredPatterns.Count(p => p.Status == "HitStop")</div>
            </div>
            <div class="stat-card" @onclick='() => SetFilter("Expired")' style="cursor:pointer; @(GetFilterHighlight("Expired"))">
                <div class="stat-label">⏰ EXPIRED</div>
                <div class="stat-value" style="color: var(--text-muted);">@SymbolFilteredPatterns.Count(p => p.Status == "Expired")</div>
            </div>
            <div class="stat-card" @onclick='() => SetFilter("Invalidated")' style="cursor:pointer; @(GetFilterHighlight("Invalidated"))">
                <div class="stat-label">🚫 INVALIDATED</div>
                <div class="stat-value" style="color: var(--text-muted);">@SymbolFilteredPatterns.Count(p => p.Status == "Invalidated")</div>
            </div>
            @{
                var resolved = SymbolFilteredPatterns.Where(p => p.WasCorrect.HasValue).ToList();
                var winRate = resolved.Any() ? Math.Round(resolved.Count(p => p.WasCorrect == true) * 100.0 / resolved.Count, 1) : 0;
            }
            <div class="stat-card" @onclick='() => SetFilter(null)' style="cursor:pointer; @(GetFilterHighlight(null))">
                <div class="stat-label">📊 WIN RATE</div>
                <div class="stat-value" style="color: @(winRate >= 50 ? "var(--accent-green)" : "var(--accent-red)");">@winRate%</div>
            </div>
        </div>

        <!-- Symbol filter -->
        <div style="display: flex; gap: 8px; margin-bottom: 12px; flex-wrap: wrap; align-items: center;">
            <span style="font-size: 0.75rem; color: var(--text-muted); font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em;">Symbol:</span>
            <button class="filter-tab @(_symbolFilter == null ? "active" : "")" @onclick='() => SetSymbolFilter(null)'>
                All
            </button>
            @foreach (var symbol in _data.Patterns.Select(p => p.Asset).Distinct().OrderBy(s => s))
            {
                var symCount = SymbolFilteredPatterns.Count(p => p.Asset == symbol);
                <button class="filter-tab @(_symbolFilter == symbol ? "active" : "")" @onclick="() => SetSymbolFilter(symbol)">
                    @symbol (@symCount)
                </button>
            }
        </div>

        <!-- Status filter tabs -->
        <div style="display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap;">
            <button class="filter-tab @(_statusFilter == null ? "active" : "")" @onclick='() => SetFilter(null)'>
                All (@SymbolFilteredPatterns.Count)
            </button>
            @foreach (var status in new[] { "Active", "PlayingOut", "HitTarget", "HitStop", "Expired", "Invalidated" })
            {
                var count = SymbolFilteredPatterns.Count(p => p.Status == status);
                if (count > 0)
                {
                    <button class="filter-tab @(_statusFilter == status ? "active" : "")" @onclick="() => SetFilter(status)">
                        @GetStatusIcon(status) @FormatStatus(status) (@count)
                    </button>
                }
            }
        </div>

        <!-- Pattern Cards -->
        @if (FilteredPatterns.Any())
        {
            <div style="display: flex; flex-direction: column; gap: 8px;">
                @foreach (var p in FilteredPatterns)
                {
                    <div class="pattern-row @GetStatusClass(p.Status)" @onclick="() => ToggleExpand(p.Id)">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <!-- Left: Symbol + Pattern info -->
                            <div style="display: flex; align-items: center; gap: 16px; min-width: 0;">
                                <span class="status-dot @GetStatusDotClass(p.Status)"></span>
                                <div>
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <span style="font-weight: 700; font-size: 1rem; color: var(--text-heading);">@p.Asset</span>
                                        <span class="direction-badge @(p.Direction == "Bullish" ? "bullish" : "bearish")">
                                            @(p.Direction == "Bullish" ? "▲ LONG" : "▼ SHORT")
                                        </span>
                                        <span class="timeframe-badge">@p.Timeframe</span>
                                        <span style="font-size: 0.8rem; color: var(--text-muted);">@p.PatternType</span>
                                    </div>
                                    <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 2px;">
                                        Detected @p.CreatedAt.ToLocalTime().ToString("MMM dd, h:mm tt") · Conf: @p.Confidence.ToString("F0")%
                                        @if (p.AIConfidence.HasValue)
                                        {
                                            <span> · AI: @p.AIConfidence.Value.ToString("F0")%</span>
                                        }
                                    </div>
                                </div>
                            </div>

                            <!-- Right: Price progress + status -->
                            <div style="display: flex; align-items: center; gap: 20px;">
                                @if (p.CurrentPrice.HasValue && p.SuggestedTarget > 0 && p.SuggestedStop > 0)
                                {
                                    var progress = CalculateProgress(p);
                                    <div style="min-width: 140px;">
                                        <div style="display: flex; justify-content: space-between; font-size: 0.7rem; color: var(--text-muted);">
                                            <span>Stop: @FormatPrice(p.SuggestedStop)</span>
                                            <span>Target: @FormatPrice(p.SuggestedTarget)</span>
                                        </div>
                                        <div class="progress-bar-container">
                                            <div class="progress-bar-fill" style="width: @(Math.Clamp(progress, 0, 100))%; background: @(progress > 50 ? "var(--accent-green)" : progress > 0 ? "var(--accent-cyan)" : "var(--accent-red)");"></div>
                                            <div class="progress-marker" style="left: @(Math.Clamp(progress, 0, 100))%;"></div>
                                        </div>
                                        <div style="text-align: center; font-size: 0.75rem; font-weight: 600; color: var(--text-heading);">
                                            @FormatPrice(p.CurrentPrice.Value)
                                        </div>
                                    </div>
                                }

                                <!-- Time remaining or outcome -->
                                @if (p.Status == "Active" || p.Status == "PlayingOut")
                                {
                                    var remaining = p.ExpiresAt - DateTime.UtcNow;
                                    <div style="min-width: 70px; text-align: right;">
                                        @if (remaining.TotalHours > 24)
                                        {
                                            <span style="font-size: 0.8rem; color: var(--text-muted);">@((int)remaining.TotalDays)d left</span>
                                        }
                                        else if (remaining.TotalHours > 0)
                                        {
                                            <span style="font-size: 0.8rem; color: var(--accent-amber);">@((int)remaining.TotalHours)h left</span>
                                        }
                                        else
                                        {
                                            <span style="font-size: 0.8rem; color: var(--accent-red);">Expiring</span>
                                        }
                                    </div>
                                }
                                else if (p.ActualPnLPercent.HasValue)
                                {
                                    <div style="min-width: 70px; text-align: right;">
                                        <span style="font-weight: 700; font-size: 0.9rem; color: @(p.ActualPnLPercent.Value >= 0 ? "var(--accent-green)" : "var(--accent-red)");">
                                            @(p.ActualPnLPercent.Value >= 0 ? "+" : "")@p.ActualPnLPercent.Value.ToString("F1")%
                                        </span>
                                    </div>
                                }

                                <div style="min-width: 90px; text-align: right;">
                                    <span class="status-badge @GetStatusBadgeClass(p.Status)">@FormatStatus(p.Status)</span>
                                </div>

                                <i class="ph @(_expandedId == p.Id ? "ph-caret-up" : "ph-caret-down")" style="color: var(--text-muted);"></i>
                            </div>
                        </div>

                        <!-- Expanded detail -->
                        @if (_expandedId == p.Id)
                        {
                            <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border);">
                                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; font-size: 0.8rem;">
                                    <div>
                                        <div style="color: var(--text-muted);">Entry</div>
                                        <div style="font-weight: 600;">@FormatPrice(p.SuggestedEntry)</div>
                                    </div>
                                    <div>
                                        <div style="color: var(--text-muted);">Stop</div>
                                        <div style="font-weight: 600; color: var(--accent-red);">@FormatPrice(p.SuggestedStop)</div>
                                    </div>
                                    <div>
                                        <div style="color: var(--text-muted);">Target</div>
                                        <div style="font-weight: 600; color: var(--accent-green);">@FormatPrice(p.SuggestedTarget)</div>
                                    </div>
                                    <div>
                                        <div style="color: var(--text-muted);">Detected At</div>
                                        <div style="font-weight: 600;">@FormatPrice(p.DetectedAtPrice)</div>
                                    </div>
                                </div>

                                @if (p.HighWaterMark.HasValue || p.LowWaterMark.HasValue)
                                {
                                    <div style="display: flex; gap: 20px; margin-top: 8px; font-size: 0.8rem;">
                                        @if (p.HighWaterMark.HasValue)
                                        {
                                            <span style="color: var(--accent-green);">High: @FormatPrice(p.HighWaterMark.Value)</span>
                                        }
                                        @if (p.LowWaterMark.HasValue)
                                        {
                                            <span style="color: var(--accent-red);">Low: @FormatPrice(p.LowWaterMark.Value)</span>
                                        }
                                    </div>
                                }

                                @if (!string.IsNullOrEmpty(p.AIAnalysis))
                                {
                                    <div style="margin-top: 8px; padding: 8px 12px; background: var(--bg-card-hover); border-radius: 6px; font-size: 0.8rem; color: var(--text-body);">
                                        <i class="ph ph-brain" style="color: var(--accent-purple); margin-right: 4px;"></i>
                                        @p.AIAnalysis
                                    </div>
                                }

                                @if (p.ResolvedAt.HasValue)
                                {
                                    <div style="margin-top: 8px; font-size: 0.8rem; color: var(--text-muted);">
                                        Resolved @p.ResolvedAt.Value.ToLocalTime().ToString("MMM dd, h:mm tt")
                                        @if (p.ResolutionPrice.HasValue)
                                        {
                                            <span> at @FormatPrice(p.ResolutionPrice.Value)</span>
                                        }
                                    </div>
                                }

                                @if (p.Status == "Active" || p.Status == "PlayingOut")
                                {
                                    <div style="margin-top: 10px;">
                                        <button class="btn btn-primary btn-sm" @onclick:stopPropagation="true"
                                                @onclick="() => OpenInPlanner(p)">
                                            <i class="ph ph-arrow-right"></i> Open in Trade Planner
                                        </button>
                                    </div>
                                }
                            </div>
                        }
                    </div>
                }
            </div>
        }
        else
        {
            <div class="card" style="text-align: center; padding: 48px;">
                <i class="ph-thin ph-magnifying-glass" style="font-size: 3rem; color: var(--text-muted);"></i>
                <p style="color: var(--text-muted); margin-top: 12px;">No patterns match this filter.</p>
            </div>
        }
    }
    else if (_loading)
    {
        <div class="card" style="text-align: center; padding: 48px;">
            <div class="spinner"></div>
            <p style="color: var(--text-muted); margin-top: 12px;">Loading pattern data...</p>
        </div>
    }
    else
    {
        <div class="card" style="text-align: center; padding: 48px;">
            <i class="ph-thin ph-heartbeat" style="font-size: 3rem; color: var(--text-muted);"></i>
            <p style="color: var(--text-muted); margin-top: 12px;">Run the scanner on your watchlist to start tracking pattern lifecycles.</p>
        </div>
    }
</div>

<style>
    .page-container {
        max-width: 1200px;
        margin: 0 auto;
    }

    .stat-card {
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 12px 16px;
        text-align: center;
    }

    .stat-label {
        font-size: 0.65rem;
        letter-spacing: 0.05em;
        color: var(--text-muted);
        margin-bottom: 4px;
    }

    .stat-value {
        font-size: 1.3rem;
        font-weight: 700;
    }

    .filter-tab {
        padding: 6px 14px;
        border-radius: 16px;
        border: 1px solid var(--border);
        background: var(--bg-card);
        color: var(--text-muted);
        font-size: 0.8rem;
        cursor: pointer;
    }

        .filter-tab:hover {
            border-color: var(--accent-cyan);
        }

        .filter-tab.active {
            background: var(--accent-cyan);
            color: white;
            border-color: var(--accent-cyan);
        }

    .pattern-row {
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 14px 18px;
        cursor: pointer;
        transition: border-color 0.15s;
    }

        .pattern-row:hover {
            border-color: var(--border-hover);
        }

        .pattern-row.resolved {
            opacity: 0.7;
        }

    .status-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        flex-shrink: 0;
    }

        .status-dot.active {
            background: var(--accent-green);
            box-shadow: 0 0 6px var(--accent-green);
        }

        .status-dot.playing-out {
            background: var(--accent-cyan);
            box-shadow: 0 0 6px var(--accent-cyan);
        }

        .status-dot.hit-target {
            background: var(--accent-green);
        }

        .status-dot.hit-stop {
            background: var(--accent-red);
        }

        .status-dot.expired {
            background: var(--text-muted);
        }

        .status-dot.invalidated {
            background: var(--text-muted);
        }

    .direction-badge {
        font-size: 0.65rem;
        font-weight: 700;
        padding: 2px 8px;
        border-radius: 10px;
        letter-spacing: 0.05em;
    }

        .direction-badge.bullish {
            background: rgba(16, 185, 129, 0.15);
            color: var(--accent-green);
        }

        .direction-badge.bearish {
            background: rgba(239, 68, 68, 0.15);
            color: var(--accent-red);
        }

    .timeframe-badge {
        font-size: 0.6rem;
        font-weight: 600;
        padding: 2px 6px;
        border-radius: 8px;
        background: rgba(99, 102, 241, 0.15);
        color: var(--accent-purple);
    }

    .progress-bar-container {
        width: 100%;
        height: 6px;
        background: var(--bg-card-hover);
        border-radius: 3px;
        margin: 4px 0;
        position: relative;
    }

    .progress-bar-fill {
        height: 100%;
        border-radius: 3px;
        transition: width 0.3s;
    }

    .progress-marker {
        position: absolute;
        top: -3px;
        width: 4px;
        height: 12px;
        background: white;
        border-radius: 2px;
        transform: translateX(-50%);
    }

    .status-badge {
        font-size: 0.7rem;
        font-weight: 600;
        padding: 3px 10px;
        border-radius: 10px;
    }

        .status-badge.active {
            background: rgba(16, 185, 129, 0.15);
            color: var(--accent-green);
        }

        .status-badge.playing-out {
            background: rgba(6, 182, 212, 0.15);
            color: var(--accent-cyan);
        }

        .status-badge.hit-target {
            background: rgba(16, 185, 129, 0.2);
            color: var(--accent-green);
        }

        .status-badge.hit-stop {
            background: rgba(239, 68, 68, 0.15);
            color: var(--accent-red);
        }

        .status-badge.expired {
            background: rgba(148, 163, 184, 0.15);
            color: var(--text-muted);
        }

        .status-badge.invalidated {
            background: rgba(148, 163, 184, 0.1);
            color: var(--text-muted);
        }

    .btn-sm {
        padding: 4px 12px;
        font-size: 0.8rem;
    }

    .spinner {
        width: 32px;
        height: 32px;
        border: 3px solid var(--border);
        border-top-color: var(--accent-cyan);
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
        margin: 0 auto;
    }

    @@keyframes spin {
        to {
            transform: rotate(360deg);
        }
    }
</style>

@code {
    private PatternLifecycleResponse? _data;
    private bool _loading;
    private bool _loaded;
    private string? _statusFilter;
    private string? _symbolFilter;
    private Guid? _expandedId;

    /// <summary>Patterns filtered by symbol only (used for status tab counts)</summary>
    private List<PatternHistoryDto> SymbolFilteredPatterns => _data?.Patterns
        .Where(p => _symbolFilter == null || p.Asset == _symbolFilter)
        .ToList() ?? new();

    /// <summary>Patterns filtered by both symbol and status</summary>
    private List<PatternHistoryDto> FilteredPatterns => _data?.Patterns
        .Where(p => _symbolFilter == null || p.Asset == _symbolFilter)
        .Where(p => _statusFilter == null || p.Status == _statusFilter)
        .ToList() ?? new();

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender || _loaded) return;
        _loaded = true;

        var state = await AuthState.GetAuthenticationStateAsync();
        if (!state.User.Identity?.IsAuthenticated ?? true) { Nav.NavigateTo("/login"); return; }

        await LoadData();
        StateHasChanged();
    }

    private async Task LoadData()
    {
        _loading = true;
        StateHasChanged();

        try
        {
            _data = await ScannerApi.GetLifecycleAsync();
        }
        catch { }

        _loading = false;
        StateHasChanged();
    }

    private void SetFilter(string? status)
    {
        _statusFilter = _statusFilter == status ? null : status;
    }

    private void SetSymbolFilter(string? symbol)
    {
        _symbolFilter = _symbolFilter == symbol ? null : symbol;
        _statusFilter = null; // Reset status filter when changing symbol
    }

    private void ToggleExpand(Guid id)
    {
        _expandedId = _expandedId == id ? null : id;
    }

    private void OpenInPlanner(PatternHistoryDto p)
    {
        var budget = 5000;
        Nav.NavigateTo($"/planner?symbol={p.Asset}&budget={budget}");
    }

    private static double CalculateProgress(PatternHistoryDto p)
    {
        if (!p.CurrentPrice.HasValue || p.SuggestedTarget == 0 || p.SuggestedStop == 0) return 50;

        var range = (double)(p.SuggestedTarget - p.SuggestedStop);
        if (range == 0) return 50;

        var pos = (double)(p.CurrentPrice.Value - p.SuggestedStop);
        return (pos / range) * 100;
    }

    private static string FormatPrice(decimal price)
    {
        if (price >= 1000) return price.ToString("N0");
        if (price >= 1) return price.ToString("N2");
        return price.ToString("N6");
    }

    private static string GetStatusIcon(string status) => status switch
    {
        "Active" => "🟢",
        "PlayingOut" => "🔵",
        "HitTarget" => "✅",
        "HitStop" => "❌",
        "Expired" => "⏰",
        "Invalidated" => "🚫",
        _ => "•"
    };

    private static string FormatStatus(string status) => status switch
    {
        "PlayingOut" => "Playing Out",
        "HitTarget" => "Hit Target",
        "HitStop" => "Hit Stop",
        _ => status
    };

    private static string GetStatusClass(string status) => status switch
    {
        "HitTarget" or "HitStop" or "Expired" or "Invalidated" => "resolved",
        _ => ""
    };

    private static string GetStatusDotClass(string status) => status switch
    {
        "Active" => "active",
        "PlayingOut" => "playing-out",
        "HitTarget" => "hit-target",
        "HitStop" => "hit-stop",
        "Expired" => "expired",
        "Invalidated" => "invalidated",
        _ => ""
    };

    private static string GetStatusBadgeClass(string status) => status switch
    {
        "Active" => "active",
        "PlayingOut" => "playing-out",
        "HitTarget" => "hit-target",
        "HitStop" => "hit-stop",
        "Expired" => "expired",
        "Invalidated" => "invalidated",
        _ => ""
    };

    private string GetFilterHighlight(string? status)
    {
        return _statusFilter == status ? "border-color: var(--accent-cyan);" : "";
    }
}
