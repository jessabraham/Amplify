@page "/portfolio-advisor"
@rendermode InteractiveServer
@inject PortfolioAdvisorApiClient AdvisorApi
@inject SettingsApiClient SettingsApi
@inject WatchlistApiClient WatchlistApi
@inject PortfolioApiClient PortfolioApi
@inject AuthStateProvider AuthState
@inject NavigationManager Nav
@using Amplify.Web.Services
@using Amplify.Application.Common.DTOs.Trading
@using System.Text.Json

<div class="fade-in">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
        <h1><i class="ph-duotone ph-chart-pie-slice" style="margin-right: 8px; color: var(--accent-cyan);"></i>Portfolio Advisor</h1>
        <button class="btn btn-primary" @onclick="RunAdvisor" disabled="@_loading">
            @if (_loading)
            {
                <i class="ph ph-circle-notch" style="animation: spin 1s linear infinite; margin-right: 6px;"></i>
                <span>Analyzing...</span>
            }
            else
            {
                <i class="ph-bold ph-brain" style="margin-right: 6px;"></i>
                <span>Get AI Allocation Advice</span>
            }
        </button>
    </div>

    <!-- Portfolio Summary Bar -->
    @if (_balance is not null)
    {
        <div class="stats-row" style="margin-bottom: 20px;">
            <div class="stat-card">
                <div class="stat-label"><i class="ph-light ph-bank" style="margin-right: 4px;"></i>Portfolio Value</div>
                <div class="stat-value">@_balance.PortfolioValue.ToString("C0")</div>
            </div>
            <div class="stat-card">
                <div class="stat-label"><i class="ph-light ph-coins" style="margin-right: 4px;"></i>Cash Available</div>
                <div class="stat-value" style="color: var(--accent-green);">@_balance.CashAvailable.ToString("C0")</div>
            </div>
            <div class="stat-card">
                <div class="stat-label"><i class="ph-light ph-chart-line-up" style="margin-right: 4px;"></i>Invested</div>
                <div class="stat-value">@_balance.TotalInvested.ToString("C0")</div>
            </div>
            <div class="stat-card">
                <div class="stat-label"><i class="ph-light ph-stack" style="margin-right: 4px;"></i>Open Positions</div>
                <div class="stat-value">@_balance.OpenPositionCount</div>
            </div>
            <div class="stat-card">
                <div class="stat-label"><i class="ph-light ph-binoculars" style="margin-right: 4px;"></i>Watchlist</div>
                <div class="stat-value">@_watchlistCount</div>
            </div>
        </div>
    }

    @if (!string.IsNullOrEmpty(_error))
    {
        <div class="card" style="border-left: 3px solid var(--accent-red); margin-bottom: 16px;">
            <span style="color: var(--accent-red);"><i class="ph-bold ph-warning" style="margin-right: 6px;"></i>@_error</span>
        </div>
    }

    @if (_loading)
    {
        <div class="card" style="text-align: center; padding: 60px;">
            <i class="ph ph-circle-notch" style="font-size: 2.5rem; color: var(--accent-cyan); animation: spin 1s linear infinite;"></i>
            <p style="color: var(--text-muted); margin-top: 16px; font-size: 1rem;">AI is analyzing your watchlist, positions, and market conditions...</p>
            <p style="color: var(--text-muted); font-size: 0.8rem;">This may take up to 60 seconds with local Ollama.</p>
        </div>
    }

    @if (_result is not null)
    {
        @if (_rehydratedFrom is not null)
        {
            var adviceAge = DateTime.UtcNow - _rehydratedFrom.Value;
            var freshnessColor = adviceAge.TotalHours < 6 ? "var(--accent-green)" : adviceAge.TotalHours < 24 ? "var(--accent-cyan)" : adviceAge.TotalDays < 3 ? "var(--accent-amber)" : "var(--accent-red)";
            var freshnessLabel = adviceAge.TotalHours < 6 ? "Fresh" : adviceAge.TotalHours < 24 ? "Recent" : adviceAge.TotalDays < 3 ? "Aging" : "Stale";
            <div class="card" style="border-left: 3px solid @freshnessColor; margin-bottom: 16px; display: flex; justify-content: space-between; align-items: center;">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <span style="font-size: 0.65rem; padding: 2px 8px; border-radius: 10px; background: @freshnessColor; color: white;">@freshnessLabel</span>
                    <span style="color: var(--text-body); font-size: 0.85rem;">
                        Advice from <strong>@_rehydratedFrom.Value.ToLocalTime().ToString("MMM dd, h:mm tt")</strong>
                        <span style="color: var(--text-muted); margin-left: 4px;">(@FormatAge(adviceAge) ago)</span>
                    </span>
                </div>
                <div style="display: flex; align-items: center; gap: 8px;">
                    @if (adviceAge.TotalHours >= 24)
                    {
                        <span style="font-size: 0.75rem; color: var(--accent-amber);"><i class="ph-light ph-warning" style="margin-right: 4px;"></i>Prices may have changed</span>
                    }
                    <button class="btn btn-secondary btn-sm" @onclick="DismissRehydrated">
                        <i class="ph ph-x" style="margin-right: 4px;"></i>Dismiss
                    </button>
                </div>
            </div>
        }
        <!-- AI Summary -->
        <div class="card" style="border-left: 3px solid var(--accent-cyan); margin-bottom: 20px;">
            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                <i class="ph-duotone ph-brain" style="font-size: 1.3rem; color: var(--accent-cyan);"></i>
                <span style="font-weight: 700; color: var(--text-heading); font-size: 1rem;">AI Portfolio Assessment</span>
                @if (!string.IsNullOrEmpty(_result.DiversificationScore))
                {
                    <span style="margin-left: auto; font-size: 0.75rem; padding: 3px 10px; border-radius: 20px; background: @GetDiverseColor(_result.DiversificationScore); color: white;">
                        Diversification: @_result.DiversificationScore
                    </span>
                }
            </div>
            <p style="color: var(--text-body); font-size: 0.9rem; line-height: 1.5;">@_result.Summary</p>

            @if (_result.Warnings.Any())
            {
                <div style="margin-top: 12px;">
                    @foreach (var warning in _result.Warnings)
                    {
                        <div style="font-size: 0.8rem; color: var(--accent-amber); margin-top: 4px;">
                            <i class="ph-bold ph-warning" style="margin-right: 4px;"></i>@warning
                        </div>
                    }
                </div>
            }

            @if (_result.TotalSuggestedAllocation > 0)
            {
                <div style="display: flex; gap: 20px; margin-top: 14px; padding-top: 12px; border-top: 1px solid var(--border); font-size: 0.8rem;">
                    <span style="color: var(--text-muted);">Suggested deployment: <strong style="color: var(--accent-cyan);">@_result.TotalSuggestedAllocation.ToString("C0")</strong></span>
                    <span style="color: var(--text-muted);">Cash retained: <strong style="color: var(--accent-green);">@_result.CashRetained.ToString("C0")</strong></span>
                </div>
            }
        </div>

        <!-- Allocation Cards -->
        @if (_result.Allocations.Any())
        {
            <div style="font-weight: 600; color: var(--text-heading); margin-bottom: 12px;">
                <i class="ph-duotone ph-chart-pie" style="margin-right: 6px; color: var(--accent-cyan);"></i>Recommended Allocations
            </div>

            <div class="signal-grid">
                @foreach (var alloc in _result.Allocations.OrderByDescending(a => a.SuggestedBudget))
                {
                    var isSkip = alloc.Skip;
                    var dirClass = alloc.Direction.ToLower() == "short" ? "short" : "long";
                    var confColor = alloc.Confidence switch
                    {
                                                        "High" => "var(--accent-green)",
                                                        "Low" => "var(--accent-red)",
                        _ => "var(--accent-amber)"
                    };

                    <div class="signal-card @dirClass" style="@(isSkip ? "opacity: 0.5;" : "")">
                        <div class="signal-card-header">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span class="signal-asset">@alloc.Symbol</span>
                                @if (!isSkip && _aiPositionSymbols.Contains(alloc.Symbol))
                                {
                                    <span style="font-size: 0.6rem; padding: 2px 8px; border-radius: 10px; background: rgba(99, 102, 241, 0.2); color: var(--accent-purple); font-weight: 600; display: flex; align-items: center; gap: 4px;">
                                        <i class="ph-bold ph-robot"></i> AI Executed
                                    </span>
                                }
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                @if (!isSkip)
                                {
                                    <span class="signal-type-badge @dirClass">
                                        @if (dirClass == "long")
                                        {
                                            <i class="ph-bold ph-trend-up" style="margin-right: 4px;"></i>
                                        }
                                        else
                                        {

                                            <i class="ph-bold ph-trend-down" style="margin-right: 4px;"></i>
                                        }
                                        @alloc.Direction
                                    </span>
                                }
                                <span style="font-size: 0.7rem; padding: 2px 8px; border-radius: 10px; background: @confColor; color: white;">@alloc.Confidence</span>
                            </div>
                        </div>

                        @if (isSkip)
                        {
                            <div style="padding: 12px 0; font-size: 0.85rem; color: var(--text-muted);">
                                <i class="ph-light ph-skip-forward" style="margin-right: 4px;"></i>@(alloc.SkipReason ?? "Skipped")
                            </div>
                        }
                        else
                        {
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin: 12px 0;">
                                <div>
                                    <div style="font-size: 0.7rem; color: var(--text-muted);">Suggested Budget</div>
                                    <div style="font-weight: 700; font-size: 1.2rem; color: var(--accent-cyan); font-family: 'JetBrains Mono', monospace;">@alloc.SuggestedBudget.ToString("C0")</div>
                                </div>
                                <div>
                                    <div style="font-size: 0.7rem; color: var(--text-muted);">% of Portfolio</div>
                                    <div style="font-weight: 600; font-size: 1.2rem; font-family: 'JetBrains Mono', monospace;">@alloc.PortfolioPercent.ToString("F1")%</div>
                                </div>
                            </div>

                            <div style="font-size: 0.8rem; color: var(--text-body); margin-bottom: 6px;">
                                <i class="ph-light ph-lightbulb" style="margin-right: 4px; color: var(--accent-cyan);"></i>@alloc.Rationale
                            </div>

                            @if (!string.IsNullOrEmpty(alloc.RiskNote))
                            {
                                <div style="font-size: 0.75rem; color: var(--accent-amber);">
                                    <i class="ph-light ph-warning" style="margin-right: 4px;"></i>@alloc.RiskNote
                                </div>
                            }

                            @if (!string.IsNullOrEmpty(alloc.PatternSummary) || alloc.PatternIds.Any())
                            {
                                <div style="margin-top: 6px; font-size: 0.7rem; display: flex; align-items: center; gap: 6px; flex-wrap: wrap;">
                                    <i class="ph-duotone ph-chart-line" style="color: var(--accent-purple);"></i>
                                    @if (!string.IsNullOrEmpty(alloc.PatternSummary))
                                    {
                                        <span style="color: var(--text-muted);">@alloc.PatternSummary</span>
                                    }
                                    @foreach (var pid in alloc.PatternIds.Take(3))
                                    {
                                        <a href="/pattern-lifecycle?highlight=@pid"
                                           @onclick:stopPropagation="true"
                                           style="font-size: 0.6rem; padding: 1px 6px; border-radius: 8px; background: rgba(99,102,241,0.15); color: var(--accent-purple); text-decoration: none; font-family: 'JetBrains Mono', monospace;">
                                            @pid[..Math.Min(8, pid.Length)]
                                        </a>
                                    }
                                </div>
                            }

                            <div style="margin-top: 12px; padding-top: 10px; border-top: 1px solid var(--border);">
                                <a href="/planner?symbol=@alloc.Symbol&budget=@((int)alloc.SuggestedBudget)" class="btn btn-primary" style="font-size: 0.8rem; width: 100%; text-align: center;">
                                    <i class="ph-bold ph-arrow-right" style="margin-right: 6px;"></i>Open in Trade Planner — @alloc.SuggestedBudget.ToString("C0")
                                </a>
                            </div>
                        }
                    </div>
                }
            </div>
        }
    }
    else if (!_loading && _hasRun)
    {
        <div class="card" style="text-align: center; padding: 48px;">
            <i class="ph-thin ph-chart-pie-slice" style="font-size: 3rem; color: var(--text-muted);"></i>
            <p style="color: var(--text-muted); font-size: 1.1rem; margin-top: 12px;">No allocation advice generated yet.</p>
        </div>
    }
    else if (!_loading)
    {
        <div class="card" style="text-align: center; padding: 48px;">
            <i class="ph-thin ph-chart-pie-slice" style="font-size: 3rem; color: var(--text-muted);"></i>
            <p style="color: var(--text-muted); font-size: 1.1rem; margin-top: 12px;">Click <strong>"Get AI Allocation Advice"</strong> to analyze your watchlist and get position sizing suggestions.</p>
            <p style="color: var(--text-muted); font-size: 0.85rem;">The AI will consider your cash available, open positions, market regimes, and recent patterns.</p>
        </div>
    }

    <!-- Advisor Scorecard -->
    @if (_scorecard is not null && _scorecard.TotalExecuted > 0)
    {
        <div class="card" style="margin-top: 24px; border-left: 3px solid var(--accent-purple);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                <div style="display: flex; align-items: center; gap: 8px;">
                    <i class="ph-duotone ph-chart-bar" style="font-size: 1.1rem; color: var(--accent-purple);"></i>
                    <span style="font-weight: 700; color: var(--text-heading);">Advisor Scorecard</span>
                    <span style="font-size: 0.6rem; background: rgba(99,102,241,0.15); color: var(--accent-purple); padding: 2px 8px; border-radius: 10px;">@_scorecard.AdviceCount runs</span>
                </div>
            </div>

            <!-- Top-level stats -->
            <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 12px; margin-bottom: 16px;">
                <div class="pattern-level">
                    <div class="pattern-level-label">Allocations</div>
                    <div class="pattern-level-value">@_scorecard.TotalAllocations</div>
                </div>
                <div class="pattern-level">
                    <div class="pattern-level-label">Executed</div>
                    <div class="pattern-level-value">@_scorecard.TotalExecuted <span style="font-size: 0.6rem; color: var(--text-muted);">(@_scorecard.ExecutionRate%)</span></div>
                </div>
                <div class="pattern-level">
                    <div class="pattern-level-label">Win Rate</div>
                    <div class="pattern-level-value" style="color: @(_scorecard.WinRate >= 50 ? "var(--accent-green)" : "var(--accent-red)");">@_scorecard.WinRate%</div>
                </div>
                <div class="pattern-level">
                    <div class="pattern-level-label">Total P&amp;L</div>
                    <div class="pattern-level-value" style="color: @(_scorecard.TotalPnL >= 0 ? "var(--accent-green)" : "var(--accent-red)");">@((_scorecard.TotalPnL >= 0 ? "+" : "") + _scorecard.TotalPnL.ToString("C0"))</div>
                </div>
                <div class="pattern-level">
                    <div class="pattern-level-label">AI / Manual</div>
                    <div class="pattern-level-value" style="font-size: 0.85rem;">
                        <span style="color: var(--accent-purple);">@_scorecard.AiExecuted</span>
                        <span style="color: var(--text-muted); margin: 0 4px;">/</span>
                        <span style="color: var(--accent-cyan);">@_scorecard.ManualExecuted</span>
                    </div>
                </div>
            </div>

            <!-- Confidence breakdown -->
            <div style="font-size: 0.7rem; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 8px;">
                Performance by Confidence Level
            </div>
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
                @foreach (var c in _scorecard.ByConfidence.OrderByDescending(c => c.Confidence == "High" ? 3 : c.Confidence == "Medium" ? 2 : 1))
                {
                    var confColor = c.Confidence == "High" ? "var(--accent-green)" : c.Confidence == "Medium" ? "var(--accent-amber)" : "var(--text-muted)";
                    var bgColor = c.Confidence == "High" ? "rgba(16,185,129,0.08)" : c.Confidence == "Medium" ? "rgba(245,158,11,0.08)" : "rgba(107,114,128,0.08)";
                    <div style="padding: 10px 14px; border-radius: 6px; background: @bgColor; border: 1px solid @(c.Confidence == "High" ? "rgba(16,185,129,0.2)" : c.Confidence == "Medium" ? "rgba(245,158,11,0.2)" : "rgba(107,114,128,0.15)");">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                            <span style="font-weight: 700; color: @confColor;">@c.Confidence</span>
                            <span style="font-size: 0.65rem; color: var(--text-muted);">@c.Executed / @c.Total executed</span>
                        </div>
                        @if (c.Executed > 0)
                        {
                            <div style="display: flex; justify-content: space-between; font-size: 0.8rem;">
                                <div>
                                    <span style="color: var(--text-muted); font-size: 0.65rem;">Win Rate</span>
                                    <div style="font-weight: 700; color: @(c.WinRate >= 50 ? "var(--accent-green)" : "var(--accent-red)");">@c.WinRate%</div>
                                </div>
                                <div style="text-align: right;">
                                    <span style="color: var(--text-muted); font-size: 0.65rem;">P&amp;L</span>
                                    <div style="font-weight: 700; font-family: 'JetBrains Mono', monospace; color: @(c.TotalPnL >= 0 ? "var(--accent-green)" : "var(--accent-red)");">@((c.TotalPnL >= 0 ? "+" : "") + c.TotalPnL.ToString("C0"))</div>
                                </div>
                            </div>
                        }
                        else
                        {
                            <div style="font-size: 0.75rem; color: var(--text-muted);">No executions yet</div>
                        }
                    </div>
                }
            </div>
        </div>
    }

    <!-- Advice History -->
    @if (_history.Any())
    {
        <div style="margin-top: 24px;">
            <div style="font-weight: 600; color: var(--text-heading); margin-bottom: 12px;">
                <i class="ph-duotone ph-clock-counter-clockwise" style="margin-right: 6px; color: var(--text-muted);"></i>Past Advice
            </div>

            @{
                // Don't show the currently-displayed advice in history (avoid duplication)
                var historyToShow = _rehydratedFrom is not null
                ? _history.Where(h => h.CreatedAt != _rehydratedFrom.Value).ToList()
                : _history.Skip(_result is not null && _history.Any() && Math.Abs((_history.First().CreatedAt - (_rehydratedFrom ?? DateTime.MinValue)).TotalSeconds) < 60 ? 0 : 0).ToList();

                // If the live result matches the most recent history item, skip it
                if (_result is not null && _rehydratedFrom is not null && _history.Any())
                {
                    historyToShow = _history.Where(h => Math.Abs((h.CreatedAt - _rehydratedFrom.Value).TotalSeconds) > 60).ToList();
                }
            }

            @foreach (var item in historyToShow)
            {
                var isExpanded = _expandedHistoryId == item.Id;
                <div class="card" style="margin-bottom: 8px; cursor: pointer;" @onclick="() => ToggleHistory(item.Id)">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <span style="font-size: 0.75rem; color: var(--text-muted);">@item.CreatedAt.ToLocalTime().ToString("MMM dd, h:mm tt")</span>
                            <span style="font-size: 0.8rem; color: var(--text-body);">@item.Summary</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 12px;">
                            @if (!string.IsNullOrEmpty(item.DiversificationScore))
                            {
                                <span style="font-size: 0.65rem; padding: 2px 8px; border-radius: 10px; background: @GetDiverseColor(item.DiversificationScore); color: white;">@item.DiversificationScore</span>
                            }
                            <span style="font-size: 0.8rem; font-weight: 600; color: var(--accent-cyan);">@item.TotalSuggestedAllocation.ToString("C0")</span>
                            <i class="ph @(isExpanded ? "ph-caret-up" : "ph-caret-down")" style="color: var(--text-muted);"></i>
                        </div>
                    </div>

                    @if (isExpanded)
                    {
                        <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border); font-size: 0.8rem;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <div style="display: flex; gap: 20px; color: var(--text-muted);">
                                    <span>Cash: @item.CashAvailable.ToString("C0")</span>
                                    <span>Invested: @item.TotalInvested.ToString("C0")</span>
                                    <span>Positions: @item.OpenPositionCount</span>
                                    <span>Watchlist: @item.WatchlistCount</span>
                                    <span>Allocations: @item.TotalAllocations</span>
                                </div>
                                <button class="btn btn-secondary btn-sm" @onclick:stopPropagation="true" @onclick="() => RehydrateAdvice(item)">
                                    <i class="ph ph-arrow-counter-clockwise" style="margin-right: 4px;"></i>Load Full View
                                </button>
                            </div>
                            @{
                                var allocations = ParseAllocations(item.ResponseJson);
                                var executedCount = 0;
                            }
                            @if (allocations.Any())
                            {
                                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 8px; margin-top: 8px;">
                                    @foreach (var a in allocations)
                                    {
                                        var aSkip = a.Skip;
                                        var aDirClass = a.Direction.ToLower() == "short" ? "short" : "long";
                                        var matchedPosition = !aSkip ? FindMatchingPosition(a.Symbol, item.CreatedAt) : null;
                                        var wasExecuted = matchedPosition is not null;
                                        if (wasExecuted) executedCount++;
                                        var wasAi = wasExecuted && matchedPosition!.IsAiGenerated;
                                        var isOpen = wasExecuted && matchedPosition!.Status == Amplify.Domain.Enumerations.PositionStatus.Open;
                                        var pnl = wasExecuted ? matchedPosition!.UnrealizedPnL + matchedPosition.RealizedPnL : 0;
                                        var pnlColor = pnl >= 0 ? "var(--accent-green)" : "var(--accent-red)";

                                        <div style="padding: 10px 12px; border-radius: 6px; background: var(--bg-card-hover); @(aSkip ? "opacity: 0.5;" : "") @(wasExecuted ? "border-left: 3px solid " + (wasAi ? "var(--accent-purple)" : "var(--accent-cyan)") + ";" : "")">
                                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                                <span style="font-weight: 600;">@a.Symbol</span>
                                                <div style="display: flex; align-items: center; gap: 6px;">
                                                    @if (!aSkip)
                                                    {
                                                        <span style="font-size: 0.6rem; padding: 1px 6px; border-radius: 8px; background: @(aDirClass == "long" ? "rgba(16,185,129,0.15)" : "rgba(239,68,68,0.15)"); color: @(aDirClass == "long" ? "var(--accent-green)" : "var(--accent-red)");">@a.Direction</span>
                                                    }
                                                    <span style="color: var(--accent-cyan); font-weight: 600;">@a.SuggestedBudget.ToString("C0")</span>
                                                </div>
                                            </div>

                                            @* Execution status *@
                                            @if (aSkip)
                                            {
                                                <div style="font-size: 0.65rem; color: var(--text-muted); margin-top: 4px;">
                                                    <i class="ph-light ph-skip-forward" style="margin-right: 2px;"></i>@(a.SkipReason ?? "Skipped")
                                                </div>
                                            }
                                            else if (wasExecuted)
                                            {
                                                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 6px;">
                                                    <span style="font-size: 0.6rem; padding: 2px 8px; border-radius: 10px; font-weight: 600; display: flex; align-items: center; gap: 4px;
                                                                                background: @(wasAi ? "rgba(99,102,241,0.15)" : "rgba(6,182,212,0.15)");
                                                                                color: @(wasAi ? "var(--accent-purple)" : "var(--accent-cyan)");">
                                                        <i class="ph-bold @(wasAi ? "ph-robot" : "ph-user")"></i>
                                                        @(wasAi ? "AI Executed" : "You Executed")
                                                    </span>
                                                    <div style="display: flex; align-items: center; gap: 6px;">
                                                        @if (isOpen)
                                                        {
                                                            <span style="font-size: 0.6rem; padding: 1px 6px; border-radius: 8px; background: rgba(16,185,129,0.15); color: var(--accent-green);">Open</span>
                                                        }
                                                        else
                                                        {
                                                            <span style="font-size: 0.6rem; padding: 1px 6px; border-radius: 8px; background: rgba(107,114,128,0.15); color: var(--text-muted);">Closed</span>
                                                        }
                                                        <span style="font-size: 0.75rem; font-weight: 600; color: @pnlColor; font-family: 'JetBrains Mono', monospace;">
                                                            @(pnl >= 0 ? "+" : "")@pnl.ToString("C0")
                                                        </span>
                                                    </div>
                                                </div>
                                                <div style="font-size: 0.65rem; color: var(--text-muted); margin-top: 2px;">
                                                    Entry: @matchedPosition!.EntryPrice.ToString("C2") · Qty: @matchedPosition.Quantity
                                                </div>
                                            }
                                            else
                                            {
                                                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 6px;">
                                                    <span style="font-size: 0.6rem; padding: 2px 8px; border-radius: 10px; background: rgba(107,114,128,0.1); color: var(--text-muted); font-weight: 600;">
                                                        <i class="ph-light ph-minus-circle" style="margin-right: 2px;"></i>Not Executed
                                                    </span>
                                                    <a href="/planner?symbol=@a.Symbol&budget=@((int)a.SuggestedBudget)"
                                                       class="btn btn-secondary btn-sm"
                                                       @onclick:stopPropagation="true"
                                                       style="font-size: 0.65rem; padding: 2px 8px;">
                                                        <i class="ph-bold ph-arrow-right" style="margin-right: 2px;"></i>Trade Planner
                                                    </a>
                                                </div>
                                            }
                                            @if (!aSkip && (!string.IsNullOrEmpty(a.PatternSummary) || a.PatternIds.Any()))
                                            {
                                                <div style="margin-top: 4px; font-size: 0.6rem; display: flex; align-items: center; gap: 4px; flex-wrap: wrap;">
                                                    <i class="ph-light ph-chart-line" style="color: var(--accent-purple);"></i>
                                                    @if (!string.IsNullOrEmpty(a.PatternSummary))
                                                    {
                                                        <span style="color: var(--text-muted);">@a.PatternSummary</span>
                                                    }
                                                    @foreach (var pid in a.PatternIds.Take(2))
                                                    {
                                                        <a href="/pattern-lifecycle?highlight=@pid"
                                                           @onclick:stopPropagation="true"
                                                           style="font-size: 0.55rem; padding: 1px 4px; border-radius: 6px; background: rgba(99,102,241,0.12); color: var(--accent-purple); text-decoration: none; font-family: 'JetBrains Mono', monospace;">
                                                            @pid[..Math.Min(8, pid.Length)]
                                                        </a>
                                                    }
                                                </div>
                                            }
                                        </div>
                                    }
                                </div>

                                @* Summary line *@
                                <div style="margin-top: 8px; font-size: 0.7rem; color: var(--text-muted);">
                                    @executedCount / @allocations.Count(a => !a.Skip) allocations executed
                                </div>
                            }
                        </div>
                    }
                </div>
            }
        </div>
    }
</div>

@code {
    private PortfolioBalanceData? _balance;
    private PortfolioAllocationResult? _result;
    private bool _loading;
    private bool _loaded;
    private bool _hasRun;
    private string? _error;
    private int _watchlistCount;

    // History
    private List<AdviceHistoryItem> _history = new();
    private Guid? _expandedHistoryId;
    private DateTime? _rehydratedFrom;

    // AI-executed positions (for badge display)
    private HashSet<string> _aiPositionSymbols = new(StringComparer.OrdinalIgnoreCase);

    // All positions for matching against past advice
    private List<PositionDto> _allPositions = new();

    // Scorecard
    private AdvisorScorecard? _scorecard;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender || _loaded) return;
        _loaded = true;

        var state = await AuthState.GetAuthenticationStateAsync();
        if (!state.User.Identity?.IsAuthenticated ?? true)
        {
            Nav.NavigateTo("/login");
            return;
        }

        try
        {
            _balance = await SettingsApi.GetPortfolioBalanceAsync();
            var watchlist = await WatchlistApi.GetWatchlistAsync();
            _watchlistCount = watchlist.Count(w => w.IsActive);
            _history = await AdvisorApi.GetAdviceHistoryAsync(10);

            // Load scorecard
            try { _scorecard = await AdvisorApi.GetScorecardAsync(); } catch { }

            // Load AI-generated open positions for badge display
            try
            {
                var openPositions = await PortfolioApi.GetOpenPositionsAsync();
                var closedPositions = await PortfolioApi.GetClosedPositionsAsync();
                _allPositions = openPositions.Concat(closedPositions).ToList();
                _aiPositionSymbols = new HashSet<string>(
                    openPositions.Where(p => p.IsAiGenerated).Select(p => p.Symbol),
                    StringComparer.OrdinalIgnoreCase);
            }
            catch { }

            // Auto-load the most recent advice if it's still fresh
            if (_history.Any() && _result is null)
            {
                var latest = _history.First();
                var age = DateTime.UtcNow - latest.CreatedAt;

                // Keep advice alive based on reasonable staleness thresholds
                // Under 24h = always show, under 7 days = show with "stale" indicator
                if (age.TotalDays < 7)
                {
                    try
                    {
                        var options = new JsonSerializerOptions { PropertyNameCaseInsensitive = true };
                        var parsed = JsonSerializer.Deserialize<PortfolioAllocationResult>(latest.ResponseJson, options);
                        if (parsed is not null)
                        {
                            _result = parsed;
                            _rehydratedFrom = latest.CreatedAt;
                            _hasRun = true;
                        }
                    }
                    catch { }
                }
            }
        }
        catch { }

        StateHasChanged();
    }

    private async Task RunAdvisor()
    {
        _loading = true;
        _error = null;
        _result = null;
        _hasRun = true;
        _rehydratedFrom = null;
        StateHasChanged();

        try
        {
            _result = await AdvisorApi.GetAllocationAdviceAsync();
            if (_result is null)
                _error = "Failed to get AI advice. Make sure Ollama is running and you have symbols in your watchlist.";

            // Refresh balance + history + AI positions
            _balance = await SettingsApi.GetPortfolioBalanceAsync();
            _history = await AdvisorApi.GetAdviceHistoryAsync(10);
            try
            {
                var openPositions = await PortfolioApi.GetOpenPositionsAsync();
                var closedPositions = await PortfolioApi.GetClosedPositionsAsync();
                _allPositions = openPositions.Concat(closedPositions).ToList();
                _aiPositionSymbols = new HashSet<string>(
                    openPositions.Where(p => p.IsAiGenerated).Select(p => p.Symbol),
                    StringComparer.OrdinalIgnoreCase);
            }
            catch { }
        }
        catch (TaskCanceledException)
        {
            _error = "Request timed out. Ollama may be processing — try again.";
        }
        catch (Exception ex)
        {
            _error = $"Error: {ex.Message}";
        }
        finally
        {
            _loading = false;
            StateHasChanged();
        }
    }

    private static string GetDiverseColor(string score) => score switch
    {
        "Good" => "var(--accent-green)",
        "Poor" => "var(--accent-red)",
        _ => "var(--accent-amber)"
    };

    private static string FormatAge(TimeSpan age)
    {
        if (age.TotalMinutes < 60) return $"{(int)age.TotalMinutes}m";
        if (age.TotalHours < 24) return $"{(int)age.TotalHours}h";
        return $"{(int)age.TotalDays}d";
    }

    /// <summary>
    /// Find a position that was likely created from this advice allocation.
    /// Matches by symbol + created within 12 hours after the advice was generated.
    /// </summary>
    private PositionDto? FindMatchingPosition(string symbol, DateTime adviceCreatedAt)
    {
        var windowEnd = adviceCreatedAt.AddHours(12);
        return _allPositions
            .Where(p => p.Symbol.Equals(symbol, StringComparison.OrdinalIgnoreCase)
                && p.CreatedAt >= adviceCreatedAt.AddMinutes(-5) // small buffer
                && p.CreatedAt <= windowEnd)
            .OrderBy(p => p.CreatedAt)
            .FirstOrDefault();
    }

    private void ToggleHistory(Guid id)
    {
        _expandedHistoryId = _expandedHistoryId == id ? null : id;
    }

    private void RehydrateAdvice(AdviceHistoryItem item)
    {
        try
        {
            var options = new JsonSerializerOptions { PropertyNameCaseInsensitive = true };
            var parsed = JsonSerializer.Deserialize<PortfolioAllocationResult>(item.ResponseJson, options);
            if (parsed is not null)
            {
                _result = parsed;
                _rehydratedFrom = item.CreatedAt;
                _hasRun = true;
                _error = null;
            }
        }
        catch
        {
            _error = "Failed to load past advice — the stored data may be in an unexpected format.";
        }
        StateHasChanged();
    }

    private void DismissRehydrated()
    {
        _result = null;
        _rehydratedFrom = null;
        _hasRun = false;
        StateHasChanged();
    }

    private static List<AllocationSuggestion> ParseAllocations(string responseJson)
    {
        try
        {
            using var doc = JsonDocument.Parse(responseJson);
            if (doc.RootElement.TryGetProperty("allocations", out var arr))
            {
                var options = new JsonSerializerOptions { PropertyNameCaseInsensitive = true };
                return JsonSerializer.Deserialize<List<AllocationSuggestion>>(arr.GetRawText(), options) ?? new();
            }
        }
        catch { }
        return new();
    }
}
