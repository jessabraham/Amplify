@page "/planner"
@rendermode InteractiveServer
@inject PatternScannerApiClient ScannerApi
@inject RegimeApiClient RegimeApi
@inject RiskApiClient RiskApi
@inject SignalApiClient SignalApi
@inject PortfolioApiClient PortfolioApi
@inject AdvisoryApiClient AdvisoryApi
@inject SimulationApiClient SimApi
@inject SettingsApiClient SettingsApi
@inject AuthStateProvider AuthState
@inject NavigationManager Nav
@using Amplify.Application.Common.DTOs.Trading
@using Amplify.Application.Common.DTOs.Market
@using Amplify.Application.Common.Models
@using Amplify.Domain.Enumerations
@using Amplify.Web.Services

<div class="fade-in">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
        <h1><i class="ph-duotone ph-path" style="margin-right: 8px; color: var(--accent-cyan);"></i>Trade Planner</h1>
        <span style="font-size: 0.8rem; color: var(--text-muted);">
            Step @_step of 5
        </span>
    </div>

    <!-- Step Indicator -->
    <div style="display: flex; gap: 4px; margin-bottom: 24px;">
        @for (int i = 1; i <= 5; i++)
        {
            var stepNum = i;
            var isActive = stepNum == _step;
            var isDone = stepNum < _step;
            var color = isDone ? "var(--accent-green)" : isActive ? "var(--accent-cyan)" : "var(--surface-hover)";
            <div style="flex: 1; height: 4px; border-radius: 2px; background: @color; transition: background 0.3s;"></div>
        }
    </div>

    <!-- ═══════════════════════════════════════════════════════════════ -->
    <!-- STEP 1: SCAN                                                    -->
    <!-- ═══════════════════════════════════════════════════════════════ -->
    @if (_step == 1)
    {
        <div class="card">
            <div style="font-weight: 600; color: var(--text-heading); margin-bottom: 4px;">
                <i class="ph-duotone ph-crosshair" style="margin-right: 6px; color: var(--accent-cyan);"></i>Step 1: Scan for Patterns
            </div>
            <div style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 16px;">
                Enter a symbol to scan for candlestick and chart patterns. The scanner will also detect the current market regime.
            </div>

            <div style="display: flex; gap: 12px; align-items: flex-end;">
                <div>
                    <label style="font-size: 0.75rem; color: var(--text-muted);">Symbol</label>
                    <input type="text" class="form-input" placeholder="e.g. AAPL" @bind="_symbol"
                           style="width: 140px; text-transform: uppercase;" />
                </div>
                <button class="btn btn-primary" @onclick="RunScan" disabled="@_scanning">
                    <i class="ph-bold ph-magnifying-glass" style="margin-right: 4px;"></i>@(_scanning ? "Scanning..." : "Scan Symbol")
                </button>
            </div>

            @if (!string.IsNullOrEmpty(_error))
            {
                <div style="color: var(--accent-red); font-size: 0.8rem; margin-top: 10px;">@_error</div>
            }
        </div>

        @if (_scanResult is not null)
        {
            <!-- Multi-Timeframe Regime Overview -->
            <div class="card" style="margin-top: 16px;">
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                    @{
                        var regCss = _scanResult.CombinedRegime.ToLower().Replace("volexpansion", "vol-expansion").Replace("meanreversion", "mean-reversion");
                        var alignColor = _scanResult.RegimeAlignment == "Aligned" ? "var(--accent-green)" : _scanResult.RegimeAlignment == "Conflicting" ? "var(--accent-red)" : "var(--accent-yellow, #f0ad4e)";
                        var dirAlignColor = _scanResult.DirectionAlignment.Contains("All") ? "var(--accent-green)" : _scanResult.DirectionAlignment == "Conflicting" ? "var(--accent-red)" : "var(--accent-yellow, #f0ad4e)";
                    }
                    <span class="regime-badge @regCss" style="font-size: 0.9rem; padding: 6px 16px;">@_scanResult.CombinedRegime</span>
                    <span style="font-size: 0.8rem; color: var(--text-muted);">
                        Confidence: <span style="font-weight: 700; color: var(--accent-cyan);">@(_scanResult.CombinedRegimeConfidence.ToString("F0"))%</span>
                    </span>
                    <span style="font-size: 0.75rem; padding: 3px 8px; border-radius: 4px; background: rgba(255,255,255,0.05); color: @alignColor;">
                        <i class="ph-bold ph-stack" style="margin-right: 3px;"></i>Regime: @_scanResult.RegimeAlignment
                    </span>
                    <span style="font-size: 0.75rem; padding: 3px 8px; border-radius: 4px; background: rgba(255,255,255,0.05); color: @dirAlignColor;">
                        <i class="ph-bold ph-arrows-merge" style="margin-right: 3px;"></i>Direction: @_scanResult.DirectionAlignment
                    </span>
                </div>

                <!-- Per-Timeframe Breakdown -->
                @if (_scanResult.TimeframeSummaries?.Any() == true)
                {
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
                        @foreach (var tf in _scanResult.TimeframeSummaries)
                        {
                            var tfDirColor = tf.DominantDirection == "Bullish" ? "var(--accent-green)" : tf.DominantDirection == "Bearish" ? "var(--accent-red)" : "var(--text-muted)";
                            var tfRegCss = tf.Regime.ToLower().Replace("volexpansion", "vol-expansion").Replace("meanreversion", "mean-reversion");
                            var tfWeight = tf.Timeframe == "Weekly" ? "3x" : tf.Timeframe == "Daily" ? "2x" : "1x";
                            <div style="background: var(--surface-hover); border-radius: 8px; padding: 10px 12px; border: 1px solid var(--border);">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                                    <span style="font-weight: 700; color: var(--text-heading); font-size: 0.85rem;">@tf.Timeframe</span>
                                    <span style="font-size: 0.65rem; color: var(--text-muted); opacity: 0.6;">weight @tfWeight</span>
                                </div>
                                <div style="display: flex; gap: 6px; flex-wrap: wrap; font-size: 0.72rem;">
                                    <span class="regime-badge @tfRegCss" style="font-size: 0.65rem; padding: 2px 8px;">@tf.Regime</span>
                                    <span style="color: @tfDirColor; font-weight: 600;">@tf.DominantDirection</span>
                                    <span style="color: var(--text-muted);">@tf.BullishCount▲ @tf.BearishCount▼</span>
                                </div>
                                @if (tf.RSI.HasValue)
                                {
                                    var rsiColor = tf.RSI < 30 ? "var(--accent-green)" : tf.RSI > 70 ? "var(--accent-red)" : "var(--text-muted)";
                                    <div style="font-size: 0.7rem; color: @rsiColor; margin-top: 4px;">RSI @tf.RSI?.ToString("F0") · Vol: @tf.VolumeProfile</div>
                                }
                            </div>
                        }
                    </div>
                }
            </div>

            <!-- Context Layers -->
            @if (GetActiveContext() is ContextData ctx)
            {
                <div class="card" style="margin-top: 12px;">
                    <div style="font-weight: 600; color: var(--text-heading); margin-bottom: 10px; font-size: 0.85rem;">
                        <i class="ph-duotone ph-chart-line-up" style="margin-right: 6px;"></i>Market Context
                        <span style="font-size: 0.7rem; color: var(--text-muted); font-weight: 400; margin-left: 6px;">(@(ctx.Timeframe) timeframe@(ctx.KeyLevels?.Any() == true ? " — key levels from Daily" : ""))</span>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; font-size: 0.78rem;">
                        <!-- Volume -->
                        <div style="text-align: center;">
                            <div style="color: var(--text-muted); font-size: 0.7rem;">Volume</div>
                            <div style="font-weight: 700; color: @(GetVolumeColor(ctx.VolumeProfile));">
                                @(string.IsNullOrEmpty(ctx.VolumeProfile) ? "N/A" : $"{ctx.VolumeProfile} ({ctx.VolumeRatio:F1}x)")
                            </div>
                        </div>
                        <!-- MA Alignment -->
                        <div style="text-align: center;">
                            <div style="color: var(--text-muted); font-size: 0.7rem;">MA Stack</div>
                            <div style="font-weight: 700; color: @(GetMAColor(ctx.MAAlignment));">
                                @(string.IsNullOrEmpty(ctx.MAAlignment) ? "N/A" : ctx.MAAlignment)
                            </div>
                        </div>
                        <!-- RSI -->
                        <div style="text-align: center;">
                            <div style="color: var(--text-muted); font-size: 0.7rem;">RSI (14)</div>
                            <div style="font-weight: 700; color: @(GetRSIColor(ctx.RSIZone));">
                                @(ctx.RSI.HasValue && ctx.RSI.Value > 0 ? $"{ctx.RSI.Value:F0} ({ctx.RSIZone})" : "N/A")
                            </div>
                        </div>
                        <!-- ATR -->
                        <div style="text-align: center;">
                            <div style="color: var(--text-muted); font-size: 0.7rem;">Volatility (ATR)</div>
                            <div style="font-weight: 700; color: var(--text-heading);">
                                @(ctx.ATRPercent.HasValue && ctx.ATRPercent.Value > 0 ? $"{ctx.ATRPercent.Value:F2}%" : "N/A")
                            </div>
                        </div>
                    </div>

                    <!-- Key Levels (from active context or Daily fallback) -->
                    @{
                        var dailyCtx = _scanResult.TimeframeContexts?.FirstOrDefault(c => c.Timeframe == "Daily") ?? _scanResult.Context;
                        var supportVal = ctx.NearestSupport ?? dailyCtx?.NearestSupport;
                        var resistVal = ctx.NearestResistance ?? dailyCtx?.NearestResistance;
                        var distSupport = ctx.DistToSupportPct ?? dailyCtx?.DistToSupportPct;
                        var distResist = ctx.DistToResistancePct ?? dailyCtx?.DistToResistancePct;
                    }
                    @if (supportVal.HasValue || resistVal.HasValue)
                    {
                        <div style="display: flex; gap: 20px; margin-top: 10px; font-size: 0.75rem;">
                            @if (supportVal.HasValue)
                            {
                                <span style="color: var(--accent-green);">
                                    <i class="ph-bold ph-arrow-down" style="margin-right: 3px;"></i>Support: @FormatPrice(supportVal.Value)
                                    <span style="opacity: 0.6;">(@distSupport?.ToString("F1")% below)</span>
                                </span>
                            }
                            @if (resistVal.HasValue)
                            {
                                <span style="color: var(--accent-red);">
                                    <i class="ph-bold ph-arrow-up" style="margin-right: 3px;"></i>Resistance: @FormatPrice(resistVal.Value)
                                    <span style="opacity: 0.6;">(@distResist?.ToString("F1")% above)</span>
                                </span>
                            }
                            @if (ctx.DistFromSMA200Pct.HasValue)
                            {
                                var sma200Color = Math.Abs(ctx.DistFromSMA200Pct.Value) > 15 ? "var(--accent-red)" : "var(--text-muted)";
                                var sma200Str = ctx.DistFromSMA200Pct.Value.ToString("+0.0;-0.0") + "% from SMA200";
                                <span style="color: @sma200Color; margin-left: auto;">@sma200Str</span>
                            }
                        </div>
                    }
                </div>
            }

            <!-- Patterns Found -->
            <div class="card" style="margin-top: 12px;">
                <div style="font-weight: 600; color: var(--text-heading); margin-bottom: 12px;">
                    <i class="ph-duotone ph-eye" style="margin-right: 6px;"></i>@_scanResult.TotalPatterns Patterns Found
                    <span style="font-size: 0.8rem; color: var(--text-muted); margin-left: 8px;">Current price: @(FormatPrice(_scanResult.CurrentPrice))</span>
                </div>

                @if (_scanResult.Patterns.Count == 0)
                {
                    <div style="color: var(--text-muted); font-size: 0.85rem;">No patterns detected. Try a different symbol.</div>
                }
                else
                {
                    <!-- Timeframe tabs -->
                    <div style="display: flex; gap: 6px; margin-bottom: 12px; flex-wrap: wrap;">
                        @{
                            var tabList = GetPatternTabs();
                        }
                        @foreach (var tab in tabList)
                        {
                            var isActive = _patternTab == tab.Name;
                            var tabColor = tab.Color;
                            <button style="padding: 4px 12px; font-size: 0.75rem; border-radius: 6px; border: 1px solid @(isActive? tabColor : "var(--border)"); background: @(isActive ? "rgba(255,255,255,0.08)" : "transparent"); color: @(isActive? tabColor : "var(--text-muted)"); cursor: pointer; font-weight: @(isActive ? "700" : "500"); transition: all 0.2s;"
                                    @onclick="() => { _patternTab = tab.Name; }">
                                @tab.Name <span style="opacity: 0.7;">(@tab.Count)</span>
                            </button>
                        }
                    </div>

                    <div style="display: flex; flex-direction: column; gap: 8px; max-height: 400px; overflow-y: auto;">
                        @{
                            var filtered = GetFilteredPatterns(); var bestPerTf = GetBestPerTimeframe();
                        }
                        @foreach (var p in filtered)
                        {
                            var isSelected = ReferenceEquals(_selectedPattern, p);
                            var isBestInTf = bestPerTf.ContainsKey(p.Timeframe) && bestPerTf[p.Timeframe] == p.PatternName;
                            var dirColor = p.Direction == "Bullish" ? "var(--accent-green)" : p.Direction == "Bearish" ? "var(--accent-red)" : "var(--text-muted)";
                            var tfBadgeColor = p.Timeframe switch
                            {
                                                    "1H" => "rgba(245,158,11,0.25)",
                                                    "4H" => "rgba(255,255,255,0.08)",
                                                    "Daily" => "rgba(0,200,200,0.15)",
                                                    "Weekly" => "rgba(123,97,255,0.3)",
                                _ => "rgba(0,200,200,0.15)"
                            };
                            <div style="background: @(isSelected ? "var(--surface-hover)" : isBestInTf ? "rgba(6,182,212,0.04)" : "transparent"); border: 1px solid @(isSelected ? "var(--accent-cyan)" : isBestInTf ? "rgba(6,182,212,0.25)" : "var(--border)"); border-radius: 8px; padding: 10px 14px; cursor: pointer; transition: all 0.2s;"
                                 @onclick="() => SelectPattern(p)">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <span style="font-size: 0.6rem; padding: 2px 6px; border-radius: 3px; background: @tfBadgeColor; font-weight: 600;">@p.Timeframe</span>
                                        @if (isBestInTf)
                                        {
                                            <span style="font-size: 0.55rem; padding: 2px 6px; border-radius: 3px; background: rgba(6,182,212,0.2); color: var(--accent-cyan); font-weight: 700; letter-spacing: 0.5px;">★ TOP PICK</span>
                                        }
                                        <span style="font-weight: 600; color: var(--text-heading);">@p.PatternName</span>
                                        <span style="font-size: 0.7rem; color: @dirColor; font-weight: 600;">@p.Direction</span>
                                        @if (!string.IsNullOrEmpty(p.AIGrade))
                                        {
                                            <span style="font-size: 0.65rem; background: var(--surface-hover); padding: 2px 6px; border-radius: 4px;">AI: @p.AIGrade</span>
                                        }
                                    </div>
                                    <span style="font-size: 0.8rem; font-weight: 700; color: var(--accent-cyan);">@(p.Confidence.ToString("F0"))%</span>
                                </div>
                                <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 4px;">
                                    Entry @(FormatPrice(p.SuggestedEntry)) · Stop @(FormatPrice(p.SuggestedStop)) · Target @(FormatPrice(p.SuggestedTarget))
                                </div>
                                @if (!string.IsNullOrEmpty(p.Description))
                                {
                                    <div style="font-size: 0.7rem; color: var(--text-muted); margin-top: 4px; opacity: 0.7;">@p.Description</div>
                                }
                            </div>
                        }
                    </div>

                    <div style="margin-top: 16px; display: flex; justify-content: flex-end; gap: 10px;">
                        <button class="btn btn-secondary" @onclick="SkipToTradeSetup">
                            Skip to Trade Setup <i class="ph-bold ph-arrow-right" style="margin-left: 4px;"></i>
                        </button>
                        @if (_selectedPattern is not null)
                        {
                            <button class="btn btn-primary" @onclick="GoToStep2">
                                Continue with @_selectedPattern.PatternName <i class="ph-bold ph-arrow-right" style="margin-left: 4px;"></i>
                            </button>
                        }
                    </div>
                }
            </div>
        }
    }

    <!-- ═══════════════════════════════════════════════════════════════ -->
    <!-- STEP 2: AI ADVISORY                                             -->
    <!-- ═══════════════════════════════════════════════════════════════ -->
    @if (_step == 2)
    {
        <div class="card">
            <div style="font-weight: 600; color: var(--text-heading); margin-bottom: 4px;">
                <i class="ph-duotone ph-robot" style="margin-right: 6px; color: var(--accent-cyan);"></i>Step 2: AI Analysis
            </div>
            <div style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 16px;">
                AI is evaluating the @((_selectedPattern is not null) ? "pattern, " : "")regime, and suggested levels for @_symbol.
            </div>

            <!-- Selected pattern or scan context -->
            @if (_selectedPattern is not null)
            {
                var tfColor = _selectedPattern.Timeframe switch
                {
                                "1H" => "var(--accent-amber)",
                                "4H" => "rgba(255,255,255,0.7)",
                                "Daily" => "var(--accent-cyan)",
                                "Weekly" => "rgba(123,97,255,0.9)",
                    _ => "var(--text-muted)"
                };
                var dirColor = _selectedPattern.Direction == "Bullish" ? "var(--accent-green)" : _selectedPattern.Direction == "Bearish" ? "var(--accent-red)" : "var(--text-muted)";
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 16px; padding: 10px 14px; background: var(--surface-hover); border-radius: 8px; border-left: 3px solid @tfColor;">
                    <span style="font-size: 0.65rem; padding: 2px 8px; border-radius: 4px; background: rgba(255,255,255,0.08); font-weight: 700; color: @tfColor;">@_selectedPattern.Timeframe</span>
                    <span style="font-weight: 600; color: var(--text-heading);">@_selectedPattern.PatternName</span>
                    <span style="font-size: 0.75rem; font-weight: 600; color: @dirColor;">@_selectedPattern.Direction</span>
                    <span style="font-size: 0.75rem; color: var(--accent-cyan); font-weight: 700;">@(_selectedPattern.Confidence.ToString("F0"))%</span>
                </div>
            }
            else if (_scanResult is not null)
            {
                var dirColor2 = _scanResult.DirectionAlignment.Contains("Bullish") ? "var(--accent-green)" : _scanResult.DirectionAlignment.Contains("Bearish") ? "var(--accent-red)" : "var(--text-muted)";
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 16px; padding: 10px 14px; background: var(--surface-hover); border-radius: 8px; border-left: 3px solid var(--text-muted);">
                    <span style="font-size: 0.65rem; padding: 2px 8px; border-radius: 4px; background: rgba(255,255,255,0.08); font-weight: 600; color: var(--text-muted);">NO PATTERN</span>
                    <span style="font-weight: 600; color: var(--text-heading);">@_symbol</span>
                    <span style="font-size: 0.12rem; color: var(--border);">|</span>
                    <span style="font-size: 0.7rem; color: var(--text-muted);">Regime:</span>
                    <span style="font-size: 0.75rem; font-weight: 600; color: var(--accent-cyan);">@_scanResult.CombinedRegime</span>
                    <span style="font-size: 0.12rem; color: var(--border);">|</span>
                    <span style="font-size: 0.7rem; color: var(--text-muted);">Direction:</span>
                    <span style="font-size: 0.75rem; font-weight: 600; color: @dirColor2;">@_scanResult.DirectionAlignment</span>
                    <span style="font-size: 0.12rem; color: var(--border);">|</span>
                    <span style="font-size: 0.7rem; color: var(--text-muted);">Patterns:</span>
                    <span style="font-size: 0.75rem; font-weight: 600; color: var(--text-heading);">@_scanResult.TotalPatterns found</span>
                </div>
            }

            @if (_aiLoading)
            {
                <div style="text-align: center; padding: 32px;">
                    <i class="ph ph-circle-notch" style="font-size: 2rem; color: var(--accent-cyan); animation: spin 1s linear infinite;"></i>
                    <p style="color: var(--text-muted); margin-top: 8px;">Consulting AI advisor...</p>
                </div>
            }
            else if (_scanResult?.AIAnalysis is not null)
            {
                var ai = _scanResult.AIAnalysis;
                <div style="display: flex; gap: 12px; margin-bottom: 16px;">
                    <div style="background: var(--surface-hover); border-radius: 8px; padding: 10px 14px; flex: 1;">
                        <div style="font-size: 0.7rem; color: var(--text-muted);">Bias</div>
                        <div style="font-weight: 700; color: @(ai.OverallBias == "Bullish" ? "var(--accent-green)" : ai.OverallBias == "Bearish" ? "var(--accent-red)" : "var(--text-muted)");">@ai.OverallBias</div>
                    </div>
                    <div style="background: var(--surface-hover); border-radius: 8px; padding: 10px 14px; flex: 1;">
                        <div style="font-size: 0.7rem; color: var(--text-muted);">AI Confidence</div>
                        <div style="font-weight: 700; color: var(--accent-cyan);">@(ai.OverallConfidence.ToString("F0") + "%")</div>
                    </div>
                    <div style="background: var(--surface-hover); border-radius: 8px; padding: 10px 14px; flex: 1;">
                        <div style="font-size: 0.7rem; color: var(--text-muted);">Action</div>
                        <div style="font-weight: 700; color: var(--text-heading);">@ai.RecommendedAction</div>
                    </div>
                </div>

                @if (!string.IsNullOrEmpty(ai.Summary))
                {
                    <div style="background: var(--surface-hover); border-radius: 8px; padding: 12px 16px; margin-bottom: 12px; font-size: 0.85rem; line-height: 1.6; color: var(--text-heading);">
                        @ai.Summary
                    </div>
                }

                @if (ai.RecommendedEntry.HasValue)
                {
                    <div style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 8px;">AI Suggested Levels:</div>
                    <div style="display: flex; gap: 12px; margin-bottom: 12px;">
                        <div style="background: var(--surface-hover); padding: 6px 12px; border-radius: 6px; font-size: 0.8rem;">
                            Entry: <span style="font-weight: 700;">@(FormatPrice(ai.RecommendedEntry.Value))</span>
                        </div>
                        @if (ai.RecommendedStop.HasValue)
                        {
                            <div style="background: var(--surface-hover); padding: 6px 12px; border-radius: 6px; font-size: 0.8rem;">
                                Stop: <span style="font-weight: 700; color: var(--accent-red);">@(FormatPrice(ai.RecommendedStop.Value))</span>
                            </div>
                        }
                        @if (ai.RecommendedTarget.HasValue)
                        {
                            <div style="background: var(--surface-hover); padding: 6px 12px; border-radius: 6px; font-size: 0.8rem;">
                                Target: <span style="font-weight: 700; color: var(--accent-green);">@(FormatPrice(ai.RecommendedTarget.Value))</span>
                            </div>
                        }
                    </div>
                }
            }
            else if (!string.IsNullOrEmpty(_aiResponse))
            {
                <div style="background: var(--surface-hover); border-radius: 8px; padding: 12px 16px; font-size: 0.85rem; line-height: 1.6; color: var(--text-heading);">
                    @_aiResponse
                </div>
            }
            else
            {
                <div style="color: var(--text-muted); font-size: 0.85rem;">AI analysis not available. You can still proceed.</div>
            }

            <div style="display: flex; justify-content: space-between; margin-top: 16px;">
                <button class="btn btn-secondary" @onclick="() => _step = 1"><i class="ph-bold ph-arrow-left" style="margin-right: 4px;"></i> Back</button>
                <button class="btn btn-primary" @onclick="GoToStep3">Set Trade Levels <i class="ph-bold ph-arrow-right" style="margin-left: 4px;"></i></button>
            </div>
        </div>
    }

    <!-- ═══════════════════════════════════════════════════════════════ -->
    <!-- STEP 3: SET LEVELS                                              -->
    <!-- ═══════════════════════════════════════════════════════════════ -->
    @if (_step == 3)
    {
        <div class="card">
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 4px;">
                <i class="ph-duotone ph-sliders" style="color: var(--accent-cyan); font-size: 1.2rem;"></i>
                <span style="font-weight: 600; color: var(--text-heading);">Step 3: Set Trade Levels</span>
                <span style="font-weight: 700; font-size: 1.1rem; color: var(--accent-cyan); margin-left: auto;">@_symbol</span>
                <span style="font-size: 0.75rem; color: var(--text-muted);">@(IsCrypto(_symbol) ? "Crypto" : "Stock")</span>
            </div>
            <div style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 16px;">
                Confirm or adjust entry, stop loss, and target prices. Pre-filled from pattern + AI suggestions.
            </div>

            <!-- Cash Available info bar -->
            <div style="display: flex; align-items: center; gap: 20px; padding: 10px 14px; border-radius: 6px; background: var(--bg-card-hover); margin-bottom: 16px; font-size: 0.8rem;">
                <span style="color: var(--text-muted);"><i class="ph-light ph-bank" style="margin-right: 4px;"></i>Cash Available:</span>
                <span style="font-weight: 700; color: var(--accent-green);">@_cashAvailable.ToString("C0")</span>
            </div>

            <div style="display: flex; flex-direction: column; gap: 12px; max-width: 600px;">
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
                    <div>
                        <label style="font-size: 0.75rem; color: var(--text-muted);">Direction</label>
                        <select class="form-input" @bind="_tradeDirection">
                            <option value="Long">Long</option>
                            <option value="Short">Short</option>
                        </select>
                    </div>
                    <div>
                        <label style="font-size: 0.75rem; color: var(--text-muted);">Position Budget ($)</label>
                        <input type="number" class="form-input" step="500" @bind="_positionBudget" />
                        @if (_cashAvailable > 0 && _scanResult?.AIAnalysis is not null)
                        {
                            var conf = _scanResult.AIAnalysis.OverallConfidence;
                            <div style="font-size: 0.65rem; color: var(--text-muted); margin-top: 3px;">
                                <i class="ph-light ph-brain" style="margin-right: 3px;"></i>Based on @(conf.ToString("F0"))% AI confidence · @(_scanResult.CombinedRegime) regime
                            </div>
                        }
                        else if (_cashAvailable > 0)
                        {
                            <div style="font-size: 0.65rem; color: var(--text-muted); margin-top: 3px;">
                                <i class="ph-light ph-lightbulb" style="margin-right: 3px;"></i>Default 5% of cash. Run scan for AI-driven sizing.
                            </div>
                        }
                    </div>
                    <div>
                        <label style="font-size: 0.75rem; color: var(--text-muted);">Risk %</label>
                        <input type="number" class="form-input" step="0.5" @bind="_riskPercent" />
                    </div>
                </div>

                <!-- Estimated position size preview -->
                @if (_entryPrice > 0 && _positionBudget > 0)
                {
                    var isCrypto = IsCrypto(_symbol);
                    var estUnits = isCrypto
                    ? Math.Round(_positionBudget / _entryPrice, 6)
                    : Math.Floor(_positionBudget / _entryPrice);
                    var estCost = estUnits * _entryPrice;
                    var riskAmount = _positionBudget * _riskPercent / 100m;
                    var exceedsCash = _positionBudget > _cashAvailable;
                    var portfolioPct = _cashAvailable > 0 ? _positionBudget / _cashAvailable * 100m : 0;
                    <div style="margin-top: 4px; padding: 10px 14px; border-radius: 6px; background: var(--bg-card-hover); font-size: 0.78rem; display: flex; gap: 16px; align-items: center; flex-wrap: wrap;">
                        <span style="color: var(--text-muted);">
                            <i class="ph-duotone ph-calculator" style="margin-right: 4px;"></i>Est. Position:
                        </span>
                        <span style="font-weight: 700; color: var(--text-heading);">@(isCrypto? estUnits.ToString("N6") : estUnits.ToString("N0")) @(isCrypto ? "units" : "shares")</span>
                        <span style="color: var(--text-muted);">×</span>
                        <span style="font-weight: 600;">@FormatPrice(_entryPrice)</span>
                        <span style="color: var(--text-muted);">=</span>
                        <span style="font-weight: 700; color: @(exceedsCash ? "var(--accent-red)" : "var(--accent-cyan)");">@estCost.ToString("C0")</span>
                        <span style="color: var(--text-muted);">(@(portfolioPct.ToString("F1"))% of cash) · max risk: @riskAmount.ToString("C0")</span>
                        @if (exceedsCash)
                        {
                            <span style="color: var(--accent-red); font-weight: 600;">
                                <i class="ph-bold ph-warning" style="margin-right: 3px;"></i>Exceeds cash available
                            </span>
                        }
                    </div>
                }

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div>
                        <label style="font-size: 0.75rem; color: var(--text-muted);">Entry Price</label>
                        <input type="number" class="form-input" step="0.01" @bind="_entryPrice" />
                    </div>
                    <div>
                        <label style="font-size: 0.75rem; color: var(--text-muted);">Stop Loss</label>
                        <input type="number" class="form-input" step="0.01" @bind="_stopLoss" />
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div>
                        <label style="font-size: 0.75rem; color: var(--text-muted);">Target 1</label>
                        <input type="number" class="form-input" step="0.01" @bind="_target1" />
                    </div>
                    <div>
                        <label style="font-size: 0.75rem; color: var(--text-muted);">Target 2 (optional)</label>
                        <input type="number" class="form-input" step="0.01" @bind="_target2" />
                    </div>
                </div>
            </div>

            @if (!string.IsNullOrEmpty(_error))
            {
                <div style="color: var(--accent-red); font-size: 0.8rem; margin-top: 10px;">@_error</div>
            }

            <div style="display: flex; justify-content: space-between; margin-top: 16px;">
                <button class="btn btn-secondary" @onclick="() => _step = 2"><i class="ph-bold ph-arrow-left" style="margin-right: 4px;"></i> Back</button>
                <button class="btn btn-primary" @onclick="RunRiskCheck" disabled="@_calculating">
                    @(_calculating ? "Calculating..." : "Calculate Risk") <i class="ph-bold ph-arrow-right" style="margin-left: 4px;"></i>
                </button>
            </div>
        </div>
    }

    <!-- ═══════════════════════════════════════════════════════════════ -->
    <!-- STEP 4: RISK ASSESSMENT                                         -->
    <!-- ═══════════════════════════════════════════════════════════════ -->
    @if (_step == 4 && _riskResult is not null)
    {
        <div class="card">
            <div style="font-weight: 600; color: var(--text-heading); margin-bottom: 4px;">
                <i class="ph-duotone ph-shield-check" style="margin-right: 6px; color: var(--accent-cyan);"></i>Step 4: Risk Assessment
            </div>
            <div style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 16px;">Review position sizing and risk/reward before committing.</div>

            <!-- Pass/Fail -->
            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 16px; padding: 10px 14px; border-radius: 8px; background: @(_riskResult.PassesRiskCheck ? "rgba(34,197,94,0.1)" : "rgba(239,68,68,0.1)"); border: 1px solid @(_riskResult.PassesRiskCheck ? "rgba(34,197,94,0.2)" : "rgba(239,68,68,0.2)");">
                @if (_riskResult.PassesRiskCheck)
                {
                    <i class="ph-bold ph-check-circle" style="color: var(--accent-green); font-size: 1.1rem;"></i>
                    <span style="font-weight: 700; color: var(--accent-green);">PASSES RISK CHECK</span>
                }
                else
                {
                    <i class="ph-bold ph-x-circle" style="color: var(--accent-red); font-size: 1.1rem;"></i>
                    <span style="font-weight: 700; color: var(--accent-red);">FAILS RISK CHECK</span>
                }
            </div>

            @foreach (var v in _riskResult.Violations)
            {
                <div style="font-size: 0.8rem; color: var(--accent-red); margin-bottom: 4px;">
                    <i class="ph-light ph-x" style="margin-right: 4px;"></i>@v
                </div>
            }
            @foreach (var w in _riskResult.Warnings)
            {
                <div style="font-size: 0.8rem; color: var(--accent-amber); margin-bottom: 4px;">
                    <i class="ph-light ph-warning" style="margin-right: 4px;"></i>@w
                </div>
            }

            <!-- Key Numbers -->
            <div class="stats-row" style="margin-top: 16px; margin-bottom: 16px;">
                <div class="stat-card">
                    <div class="stat-label">@(IsCrypto(_symbol) ? "Units" : "Shares")</div>
                    <div class="stat-value">@(IsCrypto(_symbol) ? _riskResult.ShareCount.ToString("N6") : _riskResult.ShareCount.ToString("N0"))</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Position Value</div>
                    <div class="stat-value">@(_riskResult.PositionValue.ToString("C0"))</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Max Loss</div>
                    <div class="stat-value negative">@(_riskResult.MaxLoss.ToString("C0"))</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">R:R (T1)</div>
                    @{
                        var rrStr = _riskResult.RiskRewardRatio1.ToString("F1");
                    }
                    <div class="stat-value">@rrStr : 1</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Gain @@ T1</div>
                    <div class="stat-value positive">@(_riskResult.PotentialGain1.ToString("C0"))</div>
                </div>
            </div>

            <div style="display: flex; justify-content: space-between; margin-top: 16px;">
                <button class="btn btn-secondary" @onclick="() => _step = 3"><i class="ph-bold ph-arrow-left" style="margin-right: 4px;"></i> Adjust Levels</button>
                <button class="btn btn-primary" @onclick="GoToStep5">
                    <i class="ph-bold ph-check" style="margin-right: 4px;"></i> Confirm &amp; Open Position
                </button>
            </div>
        </div>
    }

    <!-- ═══════════════════════════════════════════════════════════════ -->
    <!-- STEP 5: CONFIRM & EXECUTE                                       -->
    <!-- ═══════════════════════════════════════════════════════════════ -->
    @if (_step == 5)
    {
        <div class="card">
            @if (_executing)
            {
                <div style="text-align: center; padding: 32px;">
                    <i class="ph ph-circle-notch" style="font-size: 2rem; color: var(--accent-cyan); animation: spin 1s linear infinite;"></i>
                    <p style="color: var(--text-muted); margin-top: 8px;">Creating signal and opening position...</p>
                </div>
            }
            else if (_executionComplete)
            {
                <div style="text-align: center; padding: 32px;">
                    <i class="ph-duotone ph-check-circle" style="font-size: 3rem; color: var(--accent-green);"></i>
                    <h2 style="margin-top: 12px; color: var(--text-heading);">Trade Executed!</h2>
                    <p style="color: var(--text-muted); margin-top: 8px;">
                        @_symbol · @_tradeDirection · @(IsCrypto(_symbol) ? _riskResult?.ShareCount.ToString("N6") : _riskResult?.ShareCount.ToString("N0")) @(IsCrypto(_symbol) ? "units" : "shares") @@ @FormatPrice(_entryPrice)
                    </p>
                    <div style="display: flex; justify-content: center; gap: 12px; margin-top: 20px;">
                        <a href="/portfolio" class="btn btn-primary">
                            <i class="ph-light ph-wallet" style="margin-right: 4px;"></i>View Portfolio
                        </a>
                        <button class="btn btn-secondary" @onclick="StartOver">
                            <i class="ph-light ph-plus" style="margin-right: 4px;"></i>Plan Another Trade
                        </button>
                    </div>
                </div>
            }
            else
            {
                <div style="color: var(--accent-red); font-size: 0.85rem;">@_error</div>
                <button class="btn btn-secondary" @onclick="() => _step = 4" style="margin-top: 12px;">
                    <i class="ph-bold ph-arrow-left" style="margin-right: 4px;"></i> Back
                </button>
            }
        </div>
    }
</div>

@code {
    private int _step = 1;
    private string _symbol = "";
    private string? _error;

    [SupplyParameterFromQuery]
    [Parameter]
    public string? Symbol { get; set; }

    [SupplyParameterFromQuery]
    [Parameter]
    public decimal? Budget { get; set; }

    // Step 1: Scan
    private bool _scanning;
    private ScanResultData? _scanResult;
    private string _patternTab = "All";
    // Regime is now part of _scanResult (CombinedRegime)
    private ScannedPatternDto? _selectedPattern;

    // Step 2: AI
    private bool _aiLoading;
    private string? _aiResponse;

    // Step 3: Levels
    private string _tradeDirection = "Long";
    private decimal _entryPrice;
    private decimal _stopLoss;
    private decimal _target1;
    private decimal? _target2;
    private decimal _riskPercent = 2.0m;
    private decimal _portfolioSize = 100_000m;
    private decimal _cashAvailable = 100_000m;
    private decimal _positionBudget = 5_000m;

    // Step 4: Risk
    private bool _calculating;
    private RiskAssessmentDto? _riskResult;

    // Step 5: Execute
    private bool _executing;
    private bool _executionComplete;

    private bool _loaded;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender || _loaded) return;
        _loaded = true;

        var state = await AuthState.GetAuthenticationStateAsync();
        if (!state.User.Identity?.IsAuthenticated ?? true)
        {
            Nav.NavigateTo("/login");
            return;
        }

        // Load user's portfolio balance to set correct portfolio size
        try
        {
            var balance = await SettingsApi.GetPortfolioBalanceAsync();
            if (balance is not null)
            {
                _cashAvailable = balance.CashAvailable > 0 ? balance.CashAvailable : balance.StartingCapital;
                _portfolioSize = _cashAvailable;
                _positionBudget = Budget ?? CalculateRecommendedBudget();
            }
        }
        catch { }

        // Auto-scan if symbol passed via query string
        if (!string.IsNullOrWhiteSpace(Symbol))
        {
            _symbol = Symbol.ToUpper();
            StateHasChanged();
            await RunScan();
        }

        StateHasChanged();
    }

    // ── STEP 1: SCAN ────────────────────────────────────────────────

    private async Task RunScan()
    {
        _error = null;
        if (string.IsNullOrWhiteSpace(_symbol))
        { _error = "Enter a symbol."; return; }

        _scanning = true;
        _scanResult = null;
        _selectedPattern = null;

        try
        {
            // Multi-timeframe scan (4H + Daily + Weekly) with AI enabled
            // Regime is now computed per-timeframe and combined inside the scan
            _scanResult = await ScannerApi.ScanSymbolAsync(_symbol.ToUpper(), 40, "All", "Daily", true);

            if (_scanResult?.Patterns != null)
            {
                Console.WriteLine($"📊 UI received {_scanResult.Patterns.Count} patterns: " +
                    string.Join(", ", _scanResult.Patterns.GroupBy(p => p.Timeframe).Select(g => $"{g.Key}={g.Count()}")));
            }
        }
        catch (Exception ex) { _error = ex.Message; }
        finally { _scanning = false; }
    }

    private List<(string Name, int Count, string Color)> GetPatternTabs()
    {
        if (_scanResult is null) return new();
        return new List<(string Name, int Count, string Color)>
        {
            ("All", _scanResult.Patterns.Count, "var(--text-heading)"),
            ("1H", _scanResult.Patterns.Count(p => p.Timeframe == "1H"), "var(--accent-amber)"),
            ("4H", _scanResult.Patterns.Count(p => p.Timeframe == "4H"), "rgba(255,255,255,0.6)"),
            ("Daily", _scanResult.Patterns.Count(p => p.Timeframe == "Daily"), "var(--accent-cyan)"),
            ("Weekly", _scanResult.Patterns.Count(p => p.Timeframe == "Weekly"), "rgba(123,97,255,0.9)")
        };
    }

    private List<ScannedPatternDto> GetFilteredPatterns()
    {
        if (_scanResult is null) return new();
        var patterns = _patternTab == "All"
            ? _scanResult.Patterns
            : _scanResult.Patterns.Where(p => p.Timeframe == _patternTab);
        return patterns.OrderByDescending(p => p.Confidence).ToList();
    }

    private Dictionary<string, string> GetBestPerTimeframe()
    {
        if (_scanResult is null) return new();
        return _scanResult.Patterns
            .GroupBy(p => p.Timeframe)
            .ToDictionary(
                g => g.Key,
                g => g.OrderByDescending(p => p.Confidence).First().PatternName
            );
    }

    private static string FormatPrice(decimal price)
    {
        if (price == 0) return "$0";
        if (price < 0.01m) return price.ToString("C6");
        if (price < 1m) return price.ToString("C4");
        if (price < 10m) return price.ToString("C3");
        return price.ToString("C2");
    }

    private static string GetVolumeColor(string? profile) => profile switch
    {
        "Breakout" => "var(--accent-green)",
        "Low" => "var(--accent-red)",
        _ => "var(--text-heading)"
    };

    private static string GetMAColor(string? alignment) =>
        alignment?.Contains("Bullish") == true ? "var(--accent-green)" :
        alignment?.Contains("Bearish") == true ? "var(--accent-red)" :
        "var(--text-heading)";

    private static string GetRSIColor(string? zone) => zone switch
    {
        "Oversold" => "var(--accent-green)",
        "Overbought" => "var(--accent-red)",
        _ => "var(--text-heading)"
    };

    private static bool IsCrypto(string symbol) =>
        symbol.EndsWith("USD", StringComparison.OrdinalIgnoreCase) &&
        new[] { "BTC", "ETH", "SOL", "DOGE", "XRP", "ADA", "AVAX", "DOT", "MATIC", "LINK", "SHIB", "LTC" }
            .Any(c => symbol.StartsWith(c, StringComparison.OrdinalIgnoreCase));

    /// <summary>
    /// Calculate recommended position budget based on AI confidence and pattern strength.
    /// Higher confidence = larger allocation. Adjusted for regime and asset volatility.
    /// </summary>
    private decimal CalculateRecommendedBudget()
    {
        if (_cashAvailable <= 0) return 5_000m;

        // Base allocation from AI confidence (0-100 → 1-10% of cash)
        var aiConfidence = _scanResult?.AIAnalysis?.OverallConfidence ?? 50m;
        var patternConfidence = _selectedPattern?.Confidence ?? 50m;

        // Blend AI + pattern confidence
        var blendedConfidence = (aiConfidence * 0.6m) + (patternConfidence * 0.4m);

        // Map confidence to allocation %:
        //   50% confidence → 2% of cash
        //   70% confidence → 5% of cash
        //   90% confidence → 8% of cash
        //  100% confidence → 10% of cash
        var allocationPct = Math.Max(1m, Math.Min(10m, blendedConfidence / 10m));

        // Regime adjustment
        var regime = _scanResult?.CombinedRegime ?? "";
        if (regime.Contains("Choppy", StringComparison.OrdinalIgnoreCase))
            allocationPct *= 0.6m;  // reduce in choppy markets
        else if (regime.Contains("Trending", StringComparison.OrdinalIgnoreCase))
            allocationPct *= 1.1m;  // slight boost in trending

        // Crypto volatility discount
        if (IsCrypto(_symbol))
            allocationPct *= 0.7m;

        var recommended = Math.Round(_cashAvailable * allocationPct / 100m, 0);

        // Floor: at least $500 or one unit of the asset
        recommended = Math.Max(recommended, Math.Max(500m, _entryPrice > 0 ? _entryPrice : 0));

        // Ceiling: never exceed 25% of cash
        recommended = Math.Min(recommended, _cashAvailable * 0.25m);

        return recommended;
    }

    /// <summary>
    /// Returns the market context matching the currently selected pattern tab.
    /// Falls back to Daily if no tab-specific context exists, then to the default Context.
    /// </summary>
    private ContextData? GetActiveContext()
    {
        if (_scanResult is null) return null;

        // If timeframe contexts are available, pick the one matching the tab
        if (_scanResult.TimeframeContexts?.Any() == true)
        {
            var targetTf = _patternTab == "All" ? "Daily" : _patternTab;
            var match = _scanResult.TimeframeContexts.FirstOrDefault(c => c.Timeframe == targetTf);
            if (match is not null) return match;
        }

        // Fallback to the default Daily context
        return _scanResult.Context;
    }

    private void SelectPattern(ScannedPatternDto pattern)
    {
        _selectedPattern = ReferenceEquals(_selectedPattern, pattern) ? null : pattern;
    }

    private void GoToStep2()
    {
        if (_selectedPattern is not null)
        {
            // Pre-fill levels from selected pattern
            _entryPrice = _selectedPattern.SuggestedEntry;
            _stopLoss = _selectedPattern.SuggestedStop;
            _target1 = _selectedPattern.SuggestedTarget;
            _tradeDirection = _selectedPattern.Direction == "Bearish" ? "Short" : "Long";
        }

        // Override with AI suggestions if available and valid (non-zero)
        if (_scanResult?.AIAnalysis is not null)
        {
            var ai = _scanResult.AIAnalysis;
            if (ai.RecommendedEntry.HasValue && ai.RecommendedEntry.Value > 0)
                _entryPrice = ai.RecommendedEntry.Value;
            if (ai.RecommendedStop.HasValue && ai.RecommendedStop.Value > 0)
                _stopLoss = ai.RecommendedStop.Value;
            if (ai.RecommendedTarget.HasValue && ai.RecommendedTarget.Value > 0)
                _target1 = ai.RecommendedTarget.Value;
        }

        _step = 2;
    }

    private void SkipToTradeSetup()
    {
        _selectedPattern = null;

        // Try AI suggestions first
        if (_scanResult?.AIAnalysis is not null)
        {
            var ai = _scanResult.AIAnalysis;
            if (ai.RecommendedEntry.HasValue && ai.RecommendedEntry.Value > 0)
                _entryPrice = ai.RecommendedEntry.Value;
            if (ai.RecommendedStop.HasValue && ai.RecommendedStop.Value > 0)
                _stopLoss = ai.RecommendedStop.Value;
            if (ai.RecommendedTarget.HasValue && ai.RecommendedTarget.Value > 0)
                _target1 = ai.RecommendedTarget.Value;
            _tradeDirection = ai.OverallBias?.Contains("Bearish") == true ? "Short" : "Long";
        }

        // If levels are still 0, try the highest-confidence pattern
        if (_entryPrice == 0 && _scanResult?.Patterns?.Any() == true)
        {
            var best = _scanResult.Patterns.OrderByDescending(p => p.Confidence).First();
            if (best.SuggestedEntry > 0) _entryPrice = best.SuggestedEntry;
            if (best.SuggestedStop > 0) _stopLoss = best.SuggestedStop;
            if (best.SuggestedTarget > 0) _target1 = best.SuggestedTarget;
            _tradeDirection = best.Direction == "Bearish" ? "Short" : "Long";
        }

        // Last resort: current price with default percentages
        if (_entryPrice == 0 && _scanResult?.CurrentPrice > 0)
        {
            _entryPrice = _scanResult.CurrentPrice;
            _stopLoss = Math.Round(_scanResult.CurrentPrice * 0.97m, 2);
            _target1 = Math.Round(_scanResult.CurrentPrice * 1.05m, 2);
            _tradeDirection = "Long";
        }

        _step = 2;
    }

    // ── STEP 2 → 3 ──────────────────────────────────────────────────

    private void GoToStep3()
    {
        _error = null;
        _step = 3;
    }

    // ── STEP 3 → 4: RISK CHECK ──────────────────────────────────────

    private async Task RunRiskCheck()
    {
        _error = null;
        if (_entryPrice <= 0 || _stopLoss <= 0 || _target1 <= 0)
        { _error = "Entry, stop loss, and target are required."; return; }

        _calculating = true;
        try
        {
            var input = new RiskInputDto
            {
                Symbol = _symbol.ToUpper(),
                EntryPrice = _entryPrice,
                StopLoss = _stopLoss,
                Target1 = _target1,
                Target2 = _target2,
                PortfolioSize = _cashAvailable,  // Total cash for % calculations
                RiskPercent = _riskPercent,
                PositionBudget = _positionBudget, // How much to invest in this trade
                IsShort = _tradeDirection == "Short",
                WinRate = _selectedPattern?.HistoricalWinRate
            };

            _riskResult = await RiskApi.CalculateAsync(input);
            if (_riskResult is null)
            { _error = "Risk calculation failed."; return; }

            _step = 4;
        }
        catch (Exception ex) { _error = ex.Message; }
        finally { _calculating = false; }
    }

    // ── STEP 4 → 5: EXECUTE ─────────────────────────────────────────

    private void GoToStep5()
    {
        _error = null;
        _step = 5;
        _ = ExecuteTrade();
    }

    private async Task ExecuteTrade()
    {
        _executing = true;
        _executionComplete = false;
        StateHasChanged();

        try
        {
            // 1. Create signal
            var signalType = _tradeDirection == "Short" ? SignalType.Short : SignalType.Long;
            var regime = Enum.TryParse<MarketRegime>(_scanResult?.CombinedRegime, out var parsed) ? parsed : MarketRegime.Choppy;
            var assetClass = IsCrypto(_symbol) ? AssetClass.Crypto : AssetClass.Stock;

            var signalDto = new TradeSignalDto
            {
                Asset = _symbol.ToUpper(),
                AssetClass = assetClass,
                SignalType = signalType,
                Source = SignalSource.Manual,
                Status = SignalStatus.Accepted,
                Regime = regime,
                PatternName = _selectedPattern?.PatternName,
                PatternTimeframe = _selectedPattern?.Timeframe ?? "Daily",
                PatternConfidence = _selectedPattern?.Confidence,
                SetupScore = _selectedPattern?.Confidence ?? 50,
                EntryPrice = _entryPrice,
                StopLoss = _stopLoss,
                Target1 = _target1,
                Target2 = _target2 ?? 0,
                RiskPercent = _riskPercent,
                // AI data
                AISummary = _scanResult?.AIAnalysis?.Summary,
                AIBias = _scanResult?.AIAnalysis?.OverallBias,
                AIConfidence = _scanResult?.AIAnalysis?.OverallConfidence,
                AIRecommendedAction = _scanResult?.AIAnalysis?.RecommendedAction,
                // Risk data
                RiskShareCount = (int?)_riskResult?.ShareCount,
                RiskPositionValue = _riskResult?.PositionValue,
                RiskMaxLoss = _riskResult?.MaxLoss,
                RiskRewardRatio = _riskResult?.RiskRewardRatio1,
                RiskKellyPercent = _riskResult?.KellyPercent,
                RiskPassesCheck = _riskResult?.PassesRiskCheck,
                RiskPortfolioSize = _riskResult?.PortfolioSize,
                RiskWarnings = _riskResult is not null ? string.Join("; ", _riskResult.Warnings.Concat(_riskResult.Violations)) : null
            };
            var signal = await SignalApi.CreateSignalAsync(signalDto);

            // 2. Open position (validates against cash available)
            var positionDto = new PositionDto
            {
                Symbol = _symbol.ToUpper(),
                AssetClass = assetClass,
                SignalType = signalType,
                EntryPrice = _entryPrice,
                Quantity = _riskResult?.ShareCount ?? 0,
                StopLoss = _stopLoss,
                Target1 = _target1,
                Target2 = _target2,
                TradeSignalId = signal?.Id
            };
            await PortfolioApi.OpenPositionAsync(positionDto);

            // 3. Create simulated trade for outcome tracking
            if (signal?.Id != null && signal.Id != Guid.Empty)
            {
                try
                {
                    await SimApi.CreateSimulatedTradeAsync(new CreateSimulatedTradeRequest
                    {
                        TradeSignalId = signal.Id,
                        PatternType = _selectedPattern?.PatternType,
                        PatternDirection = _selectedPattern?.Direction,
                        PatternTimeframe = _selectedPattern?.Timeframe,
                        PatternConfidence = _selectedPattern?.Confidence,
                        TimeframeAlignment = _scanResult?.DirectionAlignment,
                        RegimeAlignment = _scanResult?.RegimeAlignment,
                        MAAlignment = GetActiveContext()?.MAAlignment,
                        VolumeProfile = GetActiveContext()?.VolumeProfile,
                        RSIAtEntry = GetActiveContext()?.RSI
                    });
                }
                catch { /* simulation is non-critical */ }
            }

            _executionComplete = true;
        }
        catch (Exception ex)
        {
            _error = $"Execution failed: {ex.Message}";
            _executionComplete = false;
        }
        finally
        {
            _executing = false;
            StateHasChanged();
        }
    }

    private void StartOver()
    {
        _step = 1;
        _symbol = "";
        _scanResult = null;
        _selectedPattern = null;
        _riskResult = null;
        _error = null;
        _executionComplete = false;
    }

    // ── Helpers ──────────────────────────────────────────────────────

    private static List<Candle> GenerateRegimeCandles(string symbol, int count)
    {
        var rng = new Random(symbol.GetHashCode());
        var candles = new List<Candle>();
        var price = 150m;
        for (int i = 0; i < count; i++)
        {
            var change = (decimal)(rng.NextDouble() - 0.48) * 2.5m;
            var open = price;
            var close = price + change;
            var high = Math.Max(open, close) + (decimal)rng.NextDouble() * 1.5m;
            var low = Math.Min(open, close) - (decimal)rng.NextDouble() * 1.5m;
            candles.Add(new Candle
            {
                Time = DateTime.UtcNow.AddDays(-count + i),
                Open = Math.Round(Math.Max(open, 1), 2),
                High = Math.Round(Math.Max(high, 1), 2),
                Low = Math.Round(Math.Max(low, 1), 2),
                Close = Math.Round(Math.Max(close, 1), 2),
                Volume = 1_000_000m + (decimal)rng.Next(-200000, 200000)
            });
            price = close;
        }
        return candles;
    }
}
