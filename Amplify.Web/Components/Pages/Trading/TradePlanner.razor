@page "/planner"
@rendermode InteractiveServer
@inject PatternScannerApiClient ScannerApi
@inject RegimeApiClient RegimeApi
@inject RiskApiClient RiskApi
@inject SignalApiClient SignalApi
@inject PortfolioApiClient PortfolioApi
@inject AdvisoryApiClient AdvisoryApi
@inject SimulationApiClient SimApi
@inject AuthStateProvider AuthState
@inject NavigationManager Nav
@using Amplify.Application.Common.DTOs.Trading
@using Amplify.Application.Common.DTOs.Market
@using Amplify.Application.Common.Models
@using Amplify.Domain.Enumerations
@using Amplify.Web.Services

<div class="fade-in">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
        <h1><i class="ph-duotone ph-path" style="margin-right: 8px; color: var(--accent-cyan);"></i>Trade Planner</h1>
        <span style="font-size: 0.8rem; color: var(--text-muted);">
            Step @_step of 5
        </span>
    </div>

    <!-- Step Indicator -->
    <div style="display: flex; gap: 4px; margin-bottom: 24px;">
        @for (int i = 1; i <= 5; i++)
        {
            var stepNum = i;
            var isActive = stepNum == _step;
            var isDone = stepNum < _step;
            var color = isDone ? "var(--accent-green)" : isActive ? "var(--accent-cyan)" : "var(--surface-hover)";
            <div style="flex: 1; height: 4px; border-radius: 2px; background: @color; transition: background 0.3s;"></div>
        }
    </div>

    <!-- ═══════════════════════════════════════════════════════════════ -->
    <!-- STEP 1: SCAN                                                    -->
    <!-- ═══════════════════════════════════════════════════════════════ -->
    @if (_step == 1)
    {
        <div class="card">
            <div style="font-weight: 600; color: var(--text-heading); margin-bottom: 4px;">
                <i class="ph-duotone ph-crosshair" style="margin-right: 6px; color: var(--accent-cyan);"></i>Step 1: Scan for Patterns
            </div>
            <div style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 16px;">
                Enter a symbol to scan for candlestick and chart patterns. The scanner will also detect the current market regime.
            </div>

            <div style="display: flex; gap: 12px; align-items: flex-end;">
                <div>
                    <label style="font-size: 0.75rem; color: var(--text-muted);">Symbol</label>
                    <input type="text" class="form-input" placeholder="e.g. AAPL" @bind="_symbol"
                           style="width: 140px; text-transform: uppercase;" />
                </div>
                <button class="btn btn-primary" @onclick="RunScan" disabled="@_scanning">
                    <i class="ph-bold ph-magnifying-glass" style="margin-right: 4px;"></i>@(_scanning ? "Scanning..." : "Scan Symbol")
                </button>
            </div>

            @if (!string.IsNullOrEmpty(_error))
            {
                <div style="color: var(--accent-red); font-size: 0.8rem; margin-top: 10px;">@_error</div>
            }
        </div>

        @if (_scanResult is not null)
        {
            <!-- Multi-Timeframe Regime Overview -->
            <div class="card" style="margin-top: 16px;">
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                    @{
                        var regCss = _scanResult.CombinedRegime.ToLower().Replace("volexpansion", "vol-expansion").Replace("meanreversion", "mean-reversion");
                        var alignColor = _scanResult.RegimeAlignment == "Aligned" ? "var(--accent-green)" : _scanResult.RegimeAlignment == "Conflicting" ? "var(--accent-red)" : "var(--accent-yellow, #f0ad4e)";
                        var dirAlignColor = _scanResult.DirectionAlignment.Contains("All") ? "var(--accent-green)" : _scanResult.DirectionAlignment == "Conflicting" ? "var(--accent-red)" : "var(--accent-yellow, #f0ad4e)";
                    }
                    <span class="regime-badge @regCss" style="font-size: 0.9rem; padding: 6px 16px;">@_scanResult.CombinedRegime</span>
                    <span style="font-size: 0.8rem; color: var(--text-muted);">
                        Confidence: <span style="font-weight: 700; color: var(--accent-cyan);">@(_scanResult.CombinedRegimeConfidence.ToString("F0"))%</span>
                    </span>
                    <span style="font-size: 0.75rem; padding: 3px 8px; border-radius: 4px; background: rgba(255,255,255,0.05); color: @alignColor;">
                        <i class="ph-bold ph-stack" style="margin-right: 3px;"></i>Regime: @_scanResult.RegimeAlignment
                    </span>
                    <span style="font-size: 0.75rem; padding: 3px 8px; border-radius: 4px; background: rgba(255,255,255,0.05); color: @dirAlignColor;">
                        <i class="ph-bold ph-arrows-merge" style="margin-right: 3px;"></i>Direction: @_scanResult.DirectionAlignment
                    </span>
                </div>

                <!-- Per-Timeframe Breakdown -->
                @if (_scanResult.TimeframeSummaries?.Any() == true)
                {
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
                        @foreach (var tf in _scanResult.TimeframeSummaries)
                        {
                            var tfDirColor = tf.DominantDirection == "Bullish" ? "var(--accent-green)" : tf.DominantDirection == "Bearish" ? "var(--accent-red)" : "var(--text-muted)";
                            var tfRegCss = tf.Regime.ToLower().Replace("volexpansion", "vol-expansion").Replace("meanreversion", "mean-reversion");
                            var tfWeight = tf.Timeframe == "Weekly" ? "3x" : tf.Timeframe == "Daily" ? "2x" : "1x";
                            <div style="background: var(--surface-hover); border-radius: 8px; padding: 10px 12px; border: 1px solid var(--border);">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                                    <span style="font-weight: 700; color: var(--text-heading); font-size: 0.85rem;">@tf.Timeframe</span>
                                    <span style="font-size: 0.65rem; color: var(--text-muted); opacity: 0.6;">weight @tfWeight</span>
                                </div>
                                <div style="display: flex; gap: 6px; flex-wrap: wrap; font-size: 0.72rem;">
                                    <span class="regime-badge @tfRegCss" style="font-size: 0.65rem; padding: 2px 8px;">@tf.Regime</span>
                                    <span style="color: @tfDirColor; font-weight: 600;">@tf.DominantDirection</span>
                                    <span style="color: var(--text-muted);">@tf.BullishCount▲ @tf.BearishCount▼</span>
                                </div>
                                @if (tf.RSI.HasValue)
                                {
                                    var rsiColor = tf.RSI < 30 ? "var(--accent-green)" : tf.RSI > 70 ? "var(--accent-red)" : "var(--text-muted)";
                                    <div style="font-size: 0.7rem; color: @rsiColor; margin-top: 4px;">RSI @tf.RSI?.ToString("F0") · Vol: @tf.VolumeProfile</div>
                                }
                            </div>
                        }
                    </div>
                }
            </div>

            <!-- Context Layers -->
            @if (_scanResult.Context is not null)
            {
                var ctx = _scanResult.Context;
                <div class="card" style="margin-top: 12px;">
                    <div style="font-weight: 600; color: var(--text-heading); margin-bottom: 10px; font-size: 0.85rem;">
                        <i class="ph-duotone ph-chart-line-up" style="margin-right: 6px;"></i>Market Context
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; font-size: 0.78rem;">
                        <!-- Volume -->
                        <div style="text-align: center;">
                            <div style="color: var(--text-muted); font-size: 0.7rem;">Volume</div>
                            @{
                                var volColor = ctx.VolumeProfile == "Breakout" ? "var(--accent-green)" : ctx.VolumeProfile == "Low" ? "var(--accent-red)" : "var(--text-heading)";
                            }
                            <div style="font-weight: 700; color: @volColor;">@ctx.VolumeProfile (@(ctx.VolumeRatio)x)</div>
                        </div>
                        <!-- MA Alignment -->
                        <div style="text-align: center;">
                            <div style="color: var(--text-muted); font-size: 0.7rem;">MA Stack</div>
                            @{
                                var maColor = ctx.MAAlignment.Contains("Bullish") ? "var(--accent-green)" : ctx.MAAlignment.Contains("Bearish") ? "var(--accent-red)" : "var(--text-heading)";
                            }
                            <div style="font-weight: 700; color: @maColor;">@ctx.MAAlignment</div>
                        </div>
                        <!-- RSI -->
                        <div style="text-align: center;">
                            <div style="color: var(--text-muted); font-size: 0.7rem;">RSI (14)</div>
                            @{
                                var rsiZoneColor = ctx.RSIZone == "Oversold" ? "var(--accent-green)" : ctx.RSIZone == "Overbought" ? "var(--accent-red)" : "var(--text-heading)";
                            }
                            <div style="font-weight: 700; color: @rsiZoneColor;">@ctx.RSI?.ToString("F0") (@ctx.RSIZone)</div>
                        </div>
                        <!-- ATR -->
                        <div style="text-align: center;">
                            <div style="color: var(--text-muted); font-size: 0.7rem;">Volatility (ATR)</div>
                            <div style="font-weight: 700; color: var(--text-heading);">@ctx.ATRPercent?.ToString("F2")%</div>
                        </div>
                    </div>

                    <!-- Key Levels -->
                    @if (ctx.NearestSupport.HasValue || ctx.NearestResistance.HasValue)
                    {
                        <div style="display: flex; gap: 20px; margin-top: 10px; font-size: 0.75rem;">
                            @if (ctx.NearestSupport.HasValue)
                            {
                                <span style="color: var(--accent-green);">
                                    <i class="ph-bold ph-arrow-down" style="margin-right: 3px;"></i>Support: @ctx.NearestSupport?.ToString("C2")
                                    <span style="opacity: 0.6;">(@ctx.DistToSupportPct?.ToString("F1")% below)</span>
                                </span>
                            }
                            @if (ctx.NearestResistance.HasValue)
                            {
                                <span style="color: var(--accent-red);">
                                    <i class="ph-bold ph-arrow-up" style="margin-right: 3px;"></i>Resistance: @ctx.NearestResistance?.ToString("C2")
                                    <span style="opacity: 0.6;">(@ctx.DistToResistancePct?.ToString("F1")% above)</span>
                                </span>
                            }
                            @if (ctx.DistFromSMA200Pct.HasValue)
                            {
                                var sma200Color = Math.Abs(ctx.DistFromSMA200Pct.Value) > 15 ? "var(--accent-red)" : "var(--text-muted)";
                                var sma200Str = ctx.DistFromSMA200Pct.Value.ToString("+0.0;-0.0") + "% from SMA200";
                                <span style="color: @sma200Color; margin-left: auto;">@sma200Str</span>
                            }
                        </div>
                    }
                </div>
            }

            <!-- Patterns Found -->
            <div class="card" style="margin-top: 12px;">
                <div style="font-weight: 600; color: var(--text-heading); margin-bottom: 12px;">
                    <i class="ph-duotone ph-eye" style="margin-right: 6px;"></i>@_scanResult.TotalPatterns Patterns Found
                    <span style="font-size: 0.8rem; color: var(--text-muted); margin-left: 8px;">Current price: @(_scanResult.CurrentPrice.ToString("C2"))</span>
                </div>

                @if (_scanResult.Patterns.Count == 0)
                {
                    <div style="color: var(--text-muted); font-size: 0.85rem;">No patterns detected. Try a different symbol.</div>
                }
                else
                {
                    <div style="display: flex; flex-direction: column; gap: 8px; max-height: 400px; overflow-y: auto;">
                        @foreach (var p in _scanResult.Patterns)
                        {
                            var isSelected = ReferenceEquals(_selectedPattern, p);
                            var dirColor = p.Direction == "Bullish" ? "var(--accent-green)" : p.Direction == "Bearish" ? "var(--accent-red)" : "var(--text-muted)";
                            var tfBadgeColor = p.Timeframe == "Weekly" ? "rgba(123,97,255,0.3)" : p.Timeframe == "4H" ? "rgba(255,255,255,0.05)" : "rgba(0,200,200,0.15)";
                            <div style="background: @(isSelected ? "var(--surface-hover)" : "transparent"); border: 1px solid @(isSelected ? "var(--accent-cyan)" : "var(--border)"); border-radius: 8px; padding: 10px 14px; cursor: pointer; transition: all 0.2s;"
                                 @onclick="() => SelectPattern(p)">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <span style="font-size: 0.6rem; padding: 2px 6px; border-radius: 3px; background: @tfBadgeColor; font-weight: 600;">@p.Timeframe</span>
                                        <span style="font-weight: 600; color: var(--text-heading);">@p.PatternName</span>
                                        <span style="font-size: 0.7rem; color: @dirColor; font-weight: 600;">@p.Direction</span>
                                        @if (!string.IsNullOrEmpty(p.AIGrade))
                                        {
                                            <span style="font-size: 0.65rem; background: var(--surface-hover); padding: 2px 6px; border-radius: 4px;">AI: @p.AIGrade</span>
                                        }
                                    </div>
                                    <span style="font-size: 0.8rem; font-weight: 700; color: var(--accent-cyan);">@(p.Confidence.ToString("F0"))%</span>
                                </div>
                                <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 4px;">
                                    Entry @(p.SuggestedEntry.ToString("C2")) · Stop @(p.SuggestedStop.ToString("C2")) · Target @(p.SuggestedTarget.ToString("C2"))
                                </div>
                                @if (!string.IsNullOrEmpty(p.Description))
                                {
                                    <div style="font-size: 0.7rem; color: var(--text-muted); margin-top: 4px; opacity: 0.7;">@p.Description</div>
                                }
                            </div>
                        }
                    </div>

                    <div style="margin-top: 16px; display: flex; justify-content: flex-end;">
                        <button class="btn btn-primary" disabled="@(_selectedPattern is null)" @onclick="GoToStep2">
                            Continue with Selected Pattern <i class="ph-bold ph-arrow-right" style="margin-left: 4px;"></i>
                        </button>
                    </div>
                }
            </div>
        }
    }

    <!-- ═══════════════════════════════════════════════════════════════ -->
    <!-- STEP 2: AI ADVISORY                                             -->
    <!-- ═══════════════════════════════════════════════════════════════ -->
    @if (_step == 2)
    {
        <div class="card">
            <div style="font-weight: 600; color: var(--text-heading); margin-bottom: 4px;">
                <i class="ph-duotone ph-robot" style="margin-right: 6px; color: var(--accent-cyan);"></i>Step 2: AI Analysis
            </div>
            <div style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 16px;">
                AI is evaluating the pattern, regime, and suggested levels for @_symbol.
            </div>

            @if (_aiLoading)
            {
                <div style="text-align: center; padding: 32px;">
                    <i class="ph ph-circle-notch" style="font-size: 2rem; color: var(--accent-cyan); animation: spin 1s linear infinite;"></i>
                    <p style="color: var(--text-muted); margin-top: 8px;">Consulting AI advisor...</p>
                </div>
            }
            else if (_scanResult?.AIAnalysis is not null)
            {
                var ai = _scanResult.AIAnalysis;
                <div style="display: flex; gap: 12px; margin-bottom: 16px;">
                    <div style="background: var(--surface-hover); border-radius: 8px; padding: 10px 14px; flex: 1;">
                        <div style="font-size: 0.7rem; color: var(--text-muted);">Bias</div>
                        <div style="font-weight: 700; color: @(ai.OverallBias == "Bullish" ? "var(--accent-green)" : ai.OverallBias == "Bearish" ? "var(--accent-red)" : "var(--text-muted)");">@ai.OverallBias</div>
                    </div>
                    <div style="background: var(--surface-hover); border-radius: 8px; padding: 10px 14px; flex: 1;">
                        <div style="font-size: 0.7rem; color: var(--text-muted);">AI Confidence</div>
                        <div style="font-weight: 700; color: var(--accent-cyan);">@(ai.OverallConfidence.ToString("F0") + "%")</div>
                    </div>
                    <div style="background: var(--surface-hover); border-radius: 8px; padding: 10px 14px; flex: 1;">
                        <div style="font-size: 0.7rem; color: var(--text-muted);">Action</div>
                        <div style="font-weight: 700; color: var(--text-heading);">@ai.RecommendedAction</div>
                    </div>
                </div>

                @if (!string.IsNullOrEmpty(ai.Summary))
                {
                    <div style="background: var(--surface-hover); border-radius: 8px; padding: 12px 16px; margin-bottom: 12px; font-size: 0.85rem; line-height: 1.6; color: var(--text-heading);">
                        @ai.Summary
                    </div>
                }

                @if (ai.RecommendedEntry.HasValue)
                {
                    <div style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 8px;">AI Suggested Levels:</div>
                    <div style="display: flex; gap: 12px; margin-bottom: 12px;">
                        <div style="background: var(--surface-hover); padding: 6px 12px; border-radius: 6px; font-size: 0.8rem;">
                            Entry: <span style="font-weight: 700;">@(ai.RecommendedEntry.Value.ToString("C2"))</span>
                        </div>
                        @if (ai.RecommendedStop.HasValue)
                        {
                            <div style="background: var(--surface-hover); padding: 6px 12px; border-radius: 6px; font-size: 0.8rem;">
                                Stop: <span style="font-weight: 700; color: var(--accent-red);">@(ai.RecommendedStop.Value.ToString("C2"))</span>
                            </div>
                        }
                        @if (ai.RecommendedTarget.HasValue)
                        {
                            <div style="background: var(--surface-hover); padding: 6px 12px; border-radius: 6px; font-size: 0.8rem;">
                                Target: <span style="font-weight: 700; color: var(--accent-green);">@(ai.RecommendedTarget.Value.ToString("C2"))</span>
                            </div>
                        }
                    </div>
                }
            }
            else if (!string.IsNullOrEmpty(_aiResponse))
            {
                <div style="background: var(--surface-hover); border-radius: 8px; padding: 12px 16px; font-size: 0.85rem; line-height: 1.6; color: var(--text-heading);">
                    @_aiResponse
                </div>
            }
            else
            {
                <div style="color: var(--text-muted); font-size: 0.85rem;">AI analysis not available. You can still proceed.</div>
            }

            <div style="display: flex; justify-content: space-between; margin-top: 16px;">
                <button class="btn btn-secondary" @onclick="() => _step = 1"><i class="ph-bold ph-arrow-left" style="margin-right: 4px;"></i> Back</button>
                <button class="btn btn-primary" @onclick="GoToStep3">Set Trade Levels <i class="ph-bold ph-arrow-right" style="margin-left: 4px;"></i></button>
            </div>
        </div>
    }

    <!-- ═══════════════════════════════════════════════════════════════ -->
    <!-- STEP 3: SET LEVELS                                              -->
    <!-- ═══════════════════════════════════════════════════════════════ -->
    @if (_step == 3)
    {
        <div class="card">
            <div style="font-weight: 600; color: var(--text-heading); margin-bottom: 4px;">
                <i class="ph-duotone ph-sliders" style="margin-right: 6px; color: var(--accent-cyan);"></i>Step 3: Set Trade Levels
            </div>
            <div style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 16px;">
                Confirm or adjust entry, stop loss, and target prices for @_symbol. Pre-filled from pattern + AI suggestions.
            </div>

            <div style="display: flex; flex-direction: column; gap: 12px; max-width: 500px;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div>
                        <label style="font-size: 0.75rem; color: var(--text-muted);">Direction</label>
                        <select class="form-input" @bind="_tradeDirection">
                            <option value="Long">Long</option>
                            <option value="Short">Short</option>
                        </select>
                    </div>
                    <div>
                        <label style="font-size: 0.75rem; color: var(--text-muted);">Portfolio Size ($)</label>
                        <input type="number" class="form-input" step="1000" @bind="_portfolioSize" />
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
                    <div>
                        <label style="font-size: 0.75rem; color: var(--text-muted);">Entry Price</label>
                        <input type="number" class="form-input" step="0.01" @bind="_entryPrice" />
                    </div>
                    <div>
                        <label style="font-size: 0.75rem; color: var(--text-muted);">Stop Loss</label>
                        <input type="number" class="form-input" step="0.01" @bind="_stopLoss" />
                    </div>
                    <div>
                        <label style="font-size: 0.75rem; color: var(--text-muted);">Risk %</label>
                        <input type="number" class="form-input" step="0.5" @bind="_riskPercent" />
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div>
                        <label style="font-size: 0.75rem; color: var(--text-muted);">Target 1</label>
                        <input type="number" class="form-input" step="0.01" @bind="_target1" />
                    </div>
                    <div>
                        <label style="font-size: 0.75rem; color: var(--text-muted);">Target 2 (optional)</label>
                        <input type="number" class="form-input" step="0.01" @bind="_target2" />
                    </div>
                </div>
            </div>

            @if (!string.IsNullOrEmpty(_error))
            {
                <div style="color: var(--accent-red); font-size: 0.8rem; margin-top: 10px;">@_error</div>
            }

            <div style="display: flex; justify-content: space-between; margin-top: 16px;">
                <button class="btn btn-secondary" @onclick="() => _step = 2"><i class="ph-bold ph-arrow-left" style="margin-right: 4px;"></i> Back</button>
                <button class="btn btn-primary" @onclick="RunRiskCheck" disabled="@_calculating">
                    @(_calculating ? "Calculating..." : "Calculate Risk") <i class="ph-bold ph-arrow-right" style="margin-left: 4px;"></i>
                </button>
            </div>
        </div>
    }

    <!-- ═══════════════════════════════════════════════════════════════ -->
    <!-- STEP 4: RISK ASSESSMENT                                         -->
    <!-- ═══════════════════════════════════════════════════════════════ -->
    @if (_step == 4 && _riskResult is not null)
    {
        <div class="card">
            <div style="font-weight: 600; color: var(--text-heading); margin-bottom: 4px;">
                <i class="ph-duotone ph-shield-check" style="margin-right: 6px; color: var(--accent-cyan);"></i>Step 4: Risk Assessment
            </div>
            <div style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 16px;">Review position sizing and risk/reward before committing.</div>

            <!-- Pass/Fail -->
            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 16px; padding: 10px 14px; border-radius: 8px; background: @(_riskResult.PassesRiskCheck ? "rgba(34,197,94,0.1)" : "rgba(239,68,68,0.1)"); border: 1px solid @(_riskResult.PassesRiskCheck ? "rgba(34,197,94,0.2)" : "rgba(239,68,68,0.2)");">
                @if (_riskResult.PassesRiskCheck)
                {
                    <i class="ph-bold ph-check-circle" style="color: var(--accent-green); font-size: 1.1rem;"></i>
                    <span style="font-weight: 700; color: var(--accent-green);">PASSES RISK CHECK</span>
                }
                else
                {
                    <i class="ph-bold ph-x-circle" style="color: var(--accent-red); font-size: 1.1rem;"></i>
                    <span style="font-weight: 700; color: var(--accent-red);">FAILS RISK CHECK</span>
                }
            </div>

            @foreach (var v in _riskResult.Violations)
            {
                <div style="font-size: 0.8rem; color: var(--accent-red); margin-bottom: 4px;">
                    <i class="ph-light ph-x" style="margin-right: 4px;"></i>@v
                </div>
            }
            @foreach (var w in _riskResult.Warnings)
            {
                <div style="font-size: 0.8rem; color: var(--accent-amber); margin-bottom: 4px;">
                    <i class="ph-light ph-warning" style="margin-right: 4px;"></i>@w
                </div>
            }

            <!-- Key Numbers -->
            <div class="stats-row" style="margin-top: 16px; margin-bottom: 16px;">
                <div class="stat-card">
                    <div class="stat-label">Shares</div>
                    <div class="stat-value">@(_riskResult.ShareCount.ToString("N0"))</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Position Value</div>
                    <div class="stat-value">@(_riskResult.PositionValue.ToString("C0"))</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Max Loss</div>
                    <div class="stat-value negative">@(_riskResult.MaxLoss.ToString("C0"))</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">R:R (T1)</div>
                    @{
                        var rrStr = _riskResult.RiskRewardRatio1.ToString("F1");
                    }
                    <div class="stat-value">@rrStr : 1</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Gain @@ T1</div>
                    <div class="stat-value positive">@(_riskResult.PotentialGain1.ToString("C0"))</div>
                </div>
            </div>

            <div style="display: flex; justify-content: space-between; margin-top: 16px;">
                <button class="btn btn-secondary" @onclick="() => _step = 3"><i class="ph-bold ph-arrow-left" style="margin-right: 4px;"></i> Adjust Levels</button>
                <button class="btn btn-primary" @onclick="GoToStep5">
                    <i class="ph-bold ph-check" style="margin-right: 4px;"></i> Confirm &amp; Open Position
                </button>
            </div>
        </div>
    }

    <!-- ═══════════════════════════════════════════════════════════════ -->
    <!-- STEP 5: CONFIRM & EXECUTE                                       -->
    <!-- ═══════════════════════════════════════════════════════════════ -->
    @if (_step == 5)
    {
        <div class="card">
            @if (_executing)
            {
                <div style="text-align: center; padding: 32px;">
                    <i class="ph ph-circle-notch" style="font-size: 2rem; color: var(--accent-cyan); animation: spin 1s linear infinite;"></i>
                    <p style="color: var(--text-muted); margin-top: 8px;">Creating signal and opening position...</p>
                </div>
            }
            else if (_executionComplete)
            {
                <div style="text-align: center; padding: 32px;">
                    <i class="ph-duotone ph-check-circle" style="font-size: 3rem; color: var(--accent-green);"></i>
                    <h2 style="margin-top: 12px; color: var(--text-heading);">Trade Executed!</h2>
                    <p style="color: var(--text-muted); margin-top: 8px;">
                        @_symbol · @_tradeDirection · @(_riskResult?.ShareCount.ToString("N0")) shares @@ @(_entryPrice.ToString("C2"))
                    </p>
                    <div style="display: flex; justify-content: center; gap: 12px; margin-top: 20px;">
                        <a href="/portfolio" class="btn btn-primary">
                            <i class="ph-light ph-wallet" style="margin-right: 4px;"></i>View Portfolio
                        </a>
                        <button class="btn btn-secondary" @onclick="StartOver">
                            <i class="ph-light ph-plus" style="margin-right: 4px;"></i>Plan Another Trade
                        </button>
                    </div>
                </div>
            }
            else
            {
                <div style="color: var(--accent-red); font-size: 0.85rem;">@_error</div>
                <button class="btn btn-secondary" @onclick="() => _step = 4" style="margin-top: 12px;">
                    <i class="ph-bold ph-arrow-left" style="margin-right: 4px;"></i> Back
                </button>
            }
        </div>
    }
</div>

@code {
    private int _step = 1;
    private string _symbol = "";
    private string? _error;

    [SupplyParameterFromQuery]
    [Parameter]
    public string? Symbol { get; set; }

    // Step 1: Scan
    private bool _scanning;
    private ScanResultData? _scanResult;
    // Regime is now part of _scanResult (CombinedRegime)
    private ScannedPatternDto? _selectedPattern;

    // Step 2: AI
    private bool _aiLoading;
    private string? _aiResponse;

    // Step 3: Levels
    private string _tradeDirection = "Long";
    private decimal _entryPrice;
    private decimal _stopLoss;
    private decimal _target1;
    private decimal? _target2;
    private decimal _riskPercent = 2.0m;
    private decimal _portfolioSize = 100_000m;

    // Step 4: Risk
    private bool _calculating;
    private RiskAssessmentDto? _riskResult;

    // Step 5: Execute
    private bool _executing;
    private bool _executionComplete;

    private bool _loaded;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender || _loaded) return;
        _loaded = true;

        var state = await AuthState.GetAuthenticationStateAsync();
        if (!state.User.Identity?.IsAuthenticated ?? true)
        {
            Nav.NavigateTo("/login");
            return;
        }

        // Auto-scan if symbol passed via query string
        if (!string.IsNullOrWhiteSpace(Symbol))
        {
            _symbol = Symbol.ToUpper();
            StateHasChanged();
            await RunScan();
        }

        StateHasChanged();
    }

    // ── STEP 1: SCAN ────────────────────────────────────────────────

    private async Task RunScan()
    {
        _error = null;
        if (string.IsNullOrWhiteSpace(_symbol))
        { _error = "Enter a symbol."; return; }

        _scanning = true;
        _scanResult = null;
        _selectedPattern = null;

        try
        {
            // Multi-timeframe scan (4H + Daily + Weekly) with AI enabled
            // Regime is now computed per-timeframe and combined inside the scan
            _scanResult = await ScannerApi.ScanSymbolAsync(_symbol.ToUpper(), 40, "All", "Daily", true);
        }
        catch (Exception ex) { _error = ex.Message; }
        finally { _scanning = false; }
    }

    private void SelectPattern(ScannedPatternDto pattern)
    {
        _selectedPattern = ReferenceEquals(_selectedPattern, pattern) ? null : pattern;
    }

    private void GoToStep2()
    {
        if (_selectedPattern is null) return;

        // Pre-fill levels from pattern
        _entryPrice = _selectedPattern.SuggestedEntry;
        _stopLoss = _selectedPattern.SuggestedStop;
        _target1 = _selectedPattern.SuggestedTarget;
        _tradeDirection = _selectedPattern.Direction == "Bearish" ? "Short" : "Long";

        // Override with AI suggestions if available
        if (_scanResult?.AIAnalysis is not null)
        {
            var ai = _scanResult.AIAnalysis;
            if (ai.RecommendedEntry.HasValue) _entryPrice = ai.RecommendedEntry.Value;
            if (ai.RecommendedStop.HasValue) _stopLoss = ai.RecommendedStop.Value;
            if (ai.RecommendedTarget.HasValue) _target1 = ai.RecommendedTarget.Value;
        }

        _step = 2;
    }

    // ── STEP 2 → 3 ──────────────────────────────────────────────────

    private void GoToStep3()
    {
        _error = null;
        _step = 3;
    }

    // ── STEP 3 → 4: RISK CHECK ──────────────────────────────────────

    private async Task RunRiskCheck()
    {
        _error = null;
        if (_entryPrice <= 0 || _stopLoss <= 0 || _target1 <= 0)
        { _error = "Entry, stop loss, and target are required."; return; }

        _calculating = true;
        try
        {
            var input = new RiskInputDto
            {
                Symbol = _symbol.ToUpper(),
                EntryPrice = _entryPrice,
                StopLoss = _stopLoss,
                Target1 = _target1,
                Target2 = _target2,
                PortfolioSize = _portfolioSize,
                RiskPercent = _riskPercent,
                IsShort = _tradeDirection == "Short",
                WinRate = _selectedPattern?.HistoricalWinRate
            };

            _riskResult = await RiskApi.CalculateAsync(input);
            if (_riskResult is null)
            { _error = "Risk calculation failed."; return; }

            _step = 4;
        }
        catch (Exception ex) { _error = ex.Message; }
        finally { _calculating = false; }
    }

    // ── STEP 4 → 5: EXECUTE ─────────────────────────────────────────

    private void GoToStep5()
    {
        _error = null;
        _step = 5;
        _ = ExecuteTrade();
    }

    private async Task ExecuteTrade()
    {
        _executing = true;
        _executionComplete = false;
        StateHasChanged();

        try
        {
            // 1. Create signal
            var signalType = _tradeDirection == "Short" ? SignalType.Short : SignalType.Long;
            var regime = Enum.TryParse<MarketRegime>(_scanResult?.CombinedRegime, out var parsed) ? parsed : MarketRegime.Choppy;

            var signalDto = new TradeSignalDto
            {
                Asset = _symbol.ToUpper(),
                AssetClass = AssetClass.Stock,
                SignalType = signalType,
                Regime = regime,
                SetupScore = _selectedPattern?.Confidence ?? 50,
                EntryPrice = _entryPrice,
                StopLoss = _stopLoss,
                Target1 = _target1,
                Target2 = _target2 ?? 0,
                RiskPercent = _riskPercent,
                // AI data
                AISummary = _scanResult?.AIAnalysis?.Summary,
                AIBias = _scanResult?.AIAnalysis?.OverallBias,
                AIConfidence = _scanResult?.AIAnalysis?.OverallConfidence,
                AIRecommendedAction = _scanResult?.AIAnalysis?.RecommendedAction,
                // Risk data
                RiskShareCount = (int?)_riskResult?.ShareCount,
                RiskPositionValue = _riskResult?.PositionValue,
                RiskMaxLoss = _riskResult?.MaxLoss,
                RiskRewardRatio = _riskResult?.RiskRewardRatio1,
                RiskKellyPercent = _riskResult?.KellyPercent,
                RiskPassesCheck = _riskResult?.PassesRiskCheck,
                RiskPortfolioSize = _riskResult?.PortfolioSize,
                RiskWarnings = _riskResult is not null ? string.Join("; ", _riskResult.Warnings.Concat(_riskResult.Violations)) : null
            };
            var signal = await SignalApi.CreateSignalAsync(signalDto);

            // 2. Open position
            var positionDto = new PositionDto
            {
                Symbol = _symbol.ToUpper(),
                AssetClass = AssetClass.Stock,
                SignalType = signalType,
                EntryPrice = _entryPrice,
                Quantity = _riskResult?.ShareCount ?? 0,
                StopLoss = _stopLoss,
                Target1 = _target1,
                Target2 = _target2,
                TradeSignalId = signal?.Id
            };
            await PortfolioApi.OpenPositionAsync(positionDto);

            // 3. Create simulated trade for outcome tracking
            if (signal?.Id != null && signal.Id != Guid.Empty)
            {
                try
                {
                    await SimApi.CreateSimulatedTradeAsync(new CreateSimulatedTradeRequest
                    {
                        TradeSignalId = signal.Id,
                        PatternType = _selectedPattern?.PatternType,
                        PatternDirection = _selectedPattern?.Direction,
                        PatternTimeframe = _selectedPattern?.Timeframe,
                        PatternConfidence = _selectedPattern?.Confidence,
                        TimeframeAlignment = _scanResult?.DirectionAlignment,
                        RegimeAlignment = _scanResult?.RegimeAlignment,
                        MAAlignment = _scanResult?.Context?.MAAlignment,
                        VolumeProfile = _scanResult?.Context?.VolumeProfile,
                        RSIAtEntry = _scanResult?.Context?.RSI
                    });
                }
                catch { /* simulation is non-critical */ }
            }

            _executionComplete = true;
        }
        catch (Exception ex)
        {
            _error = $"Execution failed: {ex.Message}";
            _executionComplete = false;
        }
        finally
        {
            _executing = false;
            StateHasChanged();
        }
    }

    private void StartOver()
    {
        _step = 1;
        _symbol = "";
        _scanResult = null;
        _selectedPattern = null;
        _riskResult = null;
        _error = null;
        _executionComplete = false;
    }

    // ── Helpers ──────────────────────────────────────────────────────

    private static List<Candle> GenerateRegimeCandles(string symbol, int count)
    {
        var rng = new Random(symbol.GetHashCode());
        var candles = new List<Candle>();
        var price = 150m;
        for (int i = 0; i < count; i++)
        {
            var change = (decimal)(rng.NextDouble() - 0.48) * 2.5m;
            var open = price;
            var close = price + change;
            var high = Math.Max(open, close) + (decimal)rng.NextDouble() * 1.5m;
            var low = Math.Min(open, close) - (decimal)rng.NextDouble() * 1.5m;
            candles.Add(new Candle
            {
                Time = DateTime.UtcNow.AddDays(-count + i),
                Open = Math.Round(Math.Max(open, 1), 2),
                High = Math.Round(Math.Max(high, 1), 2),
                Low = Math.Round(Math.Max(low, 1), 2),
                Close = Math.Round(Math.Max(close, 1), 2),
                Volume = 1_000_000m + (decimal)rng.Next(-200000, 200000)
            });
            price = close;
        }
        return candles;
    }
}
