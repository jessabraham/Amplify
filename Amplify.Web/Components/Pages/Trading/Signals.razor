@page "/signals"
@rendermode InteractiveServer
@inject SignalApiClient SignalApi
@inject AuthStateProvider AuthState
@inject NavigationManager Nav
@using Amplify.Application.Common.DTOs.Trading
@using Amplify.Web.Services
@using Amplify.Web.Components.Charts

<div class="fade-in">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
        <h1><i class="ph-duotone ph-chart-bar" style="margin-right: 8px; color: var(--accent-cyan);"></i>Trade Signals</h1>
        <div style="display: flex; align-items: center; gap: 16px;">
            <span style="font-size: 0.8rem; color: var(--text-muted);">
                <i class="ph-light ph-pulse" style="margin-right: 4px;"></i>@_signals.Count active signals
            </span>
            <a href="/signals/create" class="btn btn-primary">
                <i class="ph-bold ph-plus"></i> New Signal
            </a>
        </div>
    </div>

    @if (_loading)
    {
        <div class="card" style="text-align: center; padding: 48px;">
            <i class="ph ph-circle-notch" style="font-size: 2rem; color: var(--accent-blue); animation: spin 1s linear infinite;"></i>
            <p style="color: var(--text-muted); margin-top: 12px;">Loading signals...</p>
        </div>
    }
    else if (_signals.Count == 0)
    {
        <div class="card" style="text-align: center; padding: 48px;">
            <i class="ph-thin ph-chart-bar" style="font-size: 3rem; color: var(--text-muted);"></i>
            <p style="color: var(--text-muted); font-size: 1.1rem; margin-top: 12px;">No active signals found.</p>
            <p style="color: var(--text-muted); font-size: 0.85rem; margin-top: 4px;">Create your first signal to get started.</p>
        </div>
    }
    else
    {
        <!-- Chart Panel (shows when a signal is selected) -->
        @if (_selectedSignal is not null)
        {
            <div style="margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <span style="font-size: 1.1rem; font-weight: 700; font-family: 'JetBrains Mono', monospace; color: var(--text-heading);">
                            @_selectedSignal.Asset
                        </span>
                        <span class="signal-type-badge @(_selectedSignal.SignalType.ToString().ToLower() == "short" ? "short" : "long")" style="font-size: 0.65rem;">
                            @_selectedSignal.SignalType
                        </span>
                        <span class="regime-badge @(_selectedSignal.Regime.ToString().ToLower().Replace("volexpansion", "vol-expansion").Replace("meanreversion", "mean-reversion"))" style="font-size: 0.6rem;">
                            @_selectedSignal.Regime
                        </span>
                        <span style="font-size: 0.8rem; color: var(--text-muted);">
                            Score: <span style="font-weight: 700; color: var(--accent-cyan);">@_selectedSignal.SetupScore.ToString("F1")</span>
                        </span>
                    </div>
                    <button class="btn btn-secondary" style="font-size: 0.8rem; padding: 5px 12px;" @onclick="CloseChart">
                        <i class="ph ph-x" style="margin-right: 4px;"></i>Close Chart
                    </button>
                </div>

                <PriceChart Symbol="@_selectedSignal.Asset"
                            EntryPrice="@_selectedSignal.EntryPrice"
                            StopLoss="@_selectedSignal.StopLoss"
                            Target1="@_selectedSignal.Target1"
                            Target2="@_selectedSignal.Target2" />
            </div>
        }

        <!-- Signal Cards Grid -->
        <div class="signal-grid">
            @foreach (var s in _signals)
            {
                var signalClass = s.SignalType.ToString().ToLower() == "short" ? "short" : "long";
                var regimeClass = s.Regime.ToString().ToLower().Replace("volexpansion", "vol-expansion").Replace("meanreversion", "mean-reversion");
                var scorePercent = s.SetupScore;
                var scoreLevel = scorePercent >= 75 ? "high" : scorePercent >= 50 ? "medium" : "low";
                var isSelected = _selectedSignal?.Id == s.Id;

                <div class="signal-card @signalClass @(isSelected ? "selected" : "")"
                     @onclick="() => SelectSignal(s)"
                     style="cursor: pointer; @(isSelected ? "border-color: var(--accent-cyan); box-shadow: 0 0 12px rgba(6, 182, 212, 0.2);" : "")">

                    <div class="signal-card-header">
                        <span class="signal-asset">@s.Asset</span>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            @if (isSelected)
                            {
                                <i class="ph-bold ph-chart-line" style="color: var(--accent-cyan); font-size: 0.85rem;" title="Chart open"></i>
                            }
                            <span class="signal-type-badge @signalClass">
                                @if (signalClass == "long")
                                {
                                    <i class="ph-bold ph-trend-up" style="margin-right: 4px;"></i>
                                }
                                else
                                {
                                    <i class="ph-bold ph-trend-down" style="margin-right: 4px;"></i>
                                }
                                @s.SignalType
                            </span>
                        </div>
                    </div>

                    <div class="signal-score">
                        <div class="score-bar">
                            <div class="score-bar-fill @scoreLevel" style="width: @(scorePercent)%"></div>
                        </div>
                        <span class="score-value">@s.SetupScore.ToString("F1")</span>
                    </div>

                    <div class="signal-levels">
                        <div class="level-item">
                            <div class="level-label"><i class="ph-light ph-sign-in" style="margin-right: 3px;"></i>Entry</div>
                            <div class="level-value entry">@s.EntryPrice.ToString("C")</div>
                        </div>
                        <div class="level-item">
                            <div class="level-label"><i class="ph-light ph-shield-warning" style="margin-right: 3px;"></i>Stop Loss</div>
                            <div class="level-value stop">@s.StopLoss.ToString("C")</div>
                        </div>
                        <div class="level-item">
                            <div class="level-label"><i class="ph-light ph-target" style="margin-right: 3px;"></i>Target 1</div>
                            <div class="level-value target">@s.Target1.ToString("C")</div>
                        </div>
                        <div class="level-item">
                            <div class="level-label"><i class="ph-light ph-target" style="margin-right: 3px;"></i>Target 2</div>
                            <div class="level-value target">@s.Target2.ToString("C")</div>
                        </div>
                    </div>

                    <div class="signal-footer">
                        <span class="regime-badge @regimeClass">@s.Regime</span>
                        <span class="risk-badge">
                            <i class="ph-light ph-warning" style="margin-right: 3px;"></i>@s.RiskPercent.ToString("F1")%
                        </span>
                        <span class="signal-time">
                            <i class="ph-thin ph-clock" style="margin-right: 3px;"></i>@s.CreatedAt.ToString("MMM dd, HH:mm")
                        </span>
                    </div>
                </div>
            }
        </div>
    }
</div>

@code {
    private List<TradeSignalDto> _signals = new();
    private TradeSignalDto? _selectedSignal;
    private bool _loading = true;
    private bool _loaded;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender || _loaded) return;
        _loaded = true;

        var state = await AuthState.GetAuthenticationStateAsync();
        if (!state.User.Identity?.IsAuthenticated ?? true)
        {
            Nav.NavigateTo("/login");
            return;
        }

        try
        {
            _signals = await SignalApi.GetSignalsAsync();
        }
        catch
        {
            Nav.NavigateTo("/login");
            return;
        }
        finally
        {
            _loading = false;
        }

        StateHasChanged();
    }

    private void SelectSignal(TradeSignalDto signal)
    {
        if (_selectedSignal?.Id == signal.Id)
            _selectedSignal = null;
        else
            _selectedSignal = signal;
    }

    private void CloseChart()
    {
        _selectedSignal = null;
    }
}
