@page "/dashboard"
@rendermode InteractiveServer
@using Amplify.Web.Services
@inject DashboardApiClient DashApi
@inject SimulationApiClient SimApi
@inject AuthStateProvider AuthState
@inject NavigationManager Nav
@inject IJSRuntime JS

<div class="fade-in">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 28px;">
        <h1><i class="ph-duotone ph-squares-four" style="margin-right: 8px; color: var(--accent-cyan);"></i>Dashboard</h1>
        <div style="display: flex; align-items: center; gap: 12px;">
            <a href="/planner" class="btn btn-primary" style="font-size: 0.85rem;">
                <i class="ph-bold ph-path" style="margin-right: 4px;"></i>New Trade
            </a>
            <span style="font-size: 0.8rem; color: var(--text-muted);">
                <i class="ph-light ph-clock" style="margin-right: 4px;"></i>@DateTime.Now.ToString("dddd, MMMM dd yyyy")
            </span>
        </div>
    </div>

    @if (_loading)
    {
        <div class="card" style="text-align: center; padding: 48px;">
            <i class="ph ph-circle-notch" style="font-size: 2rem; color: var(--accent-blue); animation: spin 1s linear infinite;"></i>
            <p style="color: var(--text-muted); margin-top: 12px;">Loading dashboard...</p>
        </div>
    }
    else if (_data is null)
    {
        <div class="card" style="text-align: center; padding: 48px;">
            <i class="ph-thin ph-chart-pie" style="font-size: 3rem; color: var(--text-muted);"></i>
            <p style="color: var(--text-muted); margin-top: 12px;">Unable to load dashboard data.</p>
            @if (!string.IsNullOrEmpty(_errorMsg))
            {
                <p style="color: var(--accent-red); font-size: 0.8rem; margin-top: 8px;">@_errorMsg</p>
            }
            <p style="color: var(--text-muted); font-size: 0.75rem; margin-top: 4px;">Check the API console for details.</p>
        </div>
    }
    else
    {
        <!-- Stats Row -->
        <div class="stats-row" style="margin-bottom: 20px;">
            <div class="stat-card">
                <div class="stat-label"><i class="ph-light ph-wallet" style="margin-right: 4px;"></i>Invested</div>
                <div class="stat-value">@(_data.TotalInvested.ToString("C0"))</div>
            </div>
            <div class="stat-card">
                <div class="stat-label"><i class="ph-light ph-chart-line-up" style="margin-right: 4px;"></i>Unrealized P&amp;L</div>
                @{
                    var pnlClass = _data.TotalUnrealizedPnL >= 0 ? "positive" : "negative";
                }
                @{
                    var pnlSign = _data.TotalUnrealizedPnL >= 0 ? "+" : "";
                }
                @{
                    var pnlDisplay = pnlSign + _data.TotalUnrealizedPnL.ToString("C0");
                }
                <div class="stat-value @pnlClass">@pnlDisplay</div>
            </div>
            <div class="stat-card">
                <div class="stat-label"><i class="ph-light ph-stack" style="margin-right: 4px;"></i>Open Positions</div>
                <div class="stat-value">@_data.OpenPositionCount</div>
            </div>
            <div class="stat-card">
                <div class="stat-label"><i class="ph-light ph-chart-bar" style="margin-right: 4px;"></i>Active Signals</div>
                <div class="stat-value">@_data.TotalSignals</div>
            </div>
            <div class="stat-card">
                <div class="stat-label"><i class="ph-light ph-star" style="margin-right: 4px;"></i>Avg Score</div>
                <div class="stat-value">@_data.AvgScore</div>
            </div>
            <div class="stat-card">
                <div class="stat-label"><i class="ph-light ph-lightning" style="margin-right: 4px;"></i>High Conviction</div>
                <div class="stat-value" style="color: var(--accent-cyan);">@_data.HighConviction</div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div style="display: flex; gap: 12px; margin-bottom: 20px; flex-wrap: wrap;">
            <a href="/planner" class="quick-action-card">
                <i class="ph-duotone ph-path" style="font-size: 1.3rem; color: var(--accent-cyan);"></i>
                <span>Trade Planner</span>
            </a>
            <a href="/scanner" class="quick-action-card">
                <i class="ph-duotone ph-crosshair" style="font-size: 1.3rem; color: var(--accent-green);"></i>
                <span>Scanner</span>
            </a>
            <a href="/risk" class="quick-action-card">
                <i class="ph-duotone ph-shield-check" style="font-size: 1.3rem; color: var(--accent-amber);"></i>
                <span>Risk Calc</span>
            </a>
            <a href="/regime" class="quick-action-card">
                <i class="ph-duotone ph-wave-sine" style="font-size: 1.3rem; color: var(--accent-purple);"></i>
                <span>Regime</span>
            </a>
            <a href="/advisor" class="quick-action-card">
                <i class="ph-duotone ph-robot" style="font-size: 1.3rem; color: var(--accent-blue);"></i>
                <span>AI Advisor</span>
            </a>
            <a href="/portfolio" class="quick-action-card">
                <i class="ph-duotone ph-wallet" style="font-size: 1.3rem; color: var(--accent-pink);"></i>
                <span>Portfolio</span>
            </a>
        </div>

        <!-- Your Edge: Simulation Stats -->
        @if (_simStats is not null && _simStats.TotalTrades > 0)
        {
            <div class="card" style="margin-bottom: 20px; border-left: 3px solid var(--accent-cyan);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <i class="ph-duotone ph-game-controller" style="font-size: 1.1rem; color: var(--accent-cyan);"></i>
                        <span style="font-weight: 700; color: var(--text-heading);">Your Edge</span>
                        <span style="font-size: 0.6rem; background: rgba(6,182,212,0.15); color: var(--accent-cyan); padding: 2px 8px; border-radius: 10px;">@_simStats.TotalTrades trades</span>
                    </div>
                    <a href="/simulation" style="font-size: 0.75rem; color: var(--accent-cyan); text-decoration: none;">
                        View All <i class="ph ph-arrow-right" style="margin-left: 3px;"></i>
                    </a>
                </div>
                <div style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 12px;">
                    <div class="pattern-level">
                        <div class="pattern-level-label">Win Rate</div>
                        <div class="pattern-level-value" style="color: @(_simStats.WinRate >= 50 ? "var(--accent-green)" : "var(--accent-red)");">@_simStats.WinRate.ToString("F0")%</div>
                    </div>
                    <div class="pattern-level">
                        <div class="pattern-level-label">Avg R</div>
                        <div class="pattern-level-value" style="color: @(_simStats.AvgRMultiple >= 0 ? "var(--accent-green)" : "var(--accent-red)");">@_simStats.AvgRMultiple.ToString("F1")R</div>
                    </div>
                    <div class="pattern-level">
                        <div class="pattern-level-label">Total P&L</div>
                        <div class="pattern-level-value" style="color: @(_simStats.TotalPnLPercent >= 0 ? "var(--accent-green)" : "var(--accent-red)");">@_simStats.TotalPnLPercent.ToString("+0.0;-0.0")%</div>
                    </div>
                    <div class="pattern-level">
                        <div class="pattern-level-label">Long Win</div>
                        <div class="pattern-level-value" style="color: var(--accent-green);">@_simStats.LongWinRate.ToString("F0")%</div>
                    </div>
                    <div class="pattern-level">
                        <div class="pattern-level-label">TF Aligned</div>
                        <div class="pattern-level-value" style="color: var(--accent-green);">@_simStats.AlignedWinRate.ToString("F0")%</div>
                    </div>
                    <div class="pattern-level">
                        <div class="pattern-level-label">TF Conflicting</div>
                        <div class="pattern-level-value" style="color: var(--accent-red);">@_simStats.ConflictingWinRate.ToString("F0")%</div>
                    </div>
                </div>
            </div>
        }

        <!-- Main Grid: Positions + Activity -->
        <div style="display: grid; grid-template-columns: 3fr 2fr; gap: 20px; margin-bottom: 20px;">

            <!-- Open Positions -->
            <div class="card">
                <div class="card-header">
                    <span class="card-title"><i class="ph-duotone ph-wallet" style="margin-right: 6px;"></i>Open Positions</span>
                    <a href="/portfolio" class="btn btn-secondary" style="font-size: 0.75rem; padding: 4px 10px;">
                        View All <i class="ph ph-arrow-right" style="margin-left: 3px;"></i>
                    </a>
                </div>
                @if (_data.TopPositions.Any())
                {
                    <div style="display: flex; flex-direction: column; gap: 8px;">
                        @foreach (var p in _data.TopPositions)
                        {
                            var isLong = p.SignalType.ToLower() != "short";
                            var pColor = p.UnrealizedPnL >= 0 ? "var(--accent-green)" : "var(--accent-red)";
                            var pnlStr = (p.UnrealizedPnL >= 0 ? "+" : "") + p.UnrealizedPnL.ToString("C0");
                            var retVal = p.ReturnPercent ?? 0m;
                            var retStr = (retVal >= 0 ? "+" : "") + retVal.ToString("F1") + "%";
                            var posUrl = $"/planner?symbol={p.Symbol}";
                            var qtyEntry = p.Quantity.ToString("N0") + " @ " + p.EntryPrice.ToString("C2");
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 10px; background: var(--surface-hover); border-radius: 6px;">
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <span style="font-weight: 700; font-family: 'JetBrains Mono', monospace; min-width: 50px;">@p.Symbol</span>
                                    <span style="font-size: 0.65rem; padding: 2px 6px; border-radius: 4px; background: @(isLong ? "rgba(16,185,129,0.15)" : "rgba(239,68,68,0.15)"); color: @(isLong ? "var(--accent-green)" : "var(--accent-red)");">
                                        @p.SignalType
                                    </span>
                                    <span style="font-size: 0.75rem; color: var(--text-muted);">@qtyEntry</span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 12px;">
                                    <div style="text-align: right;">
                                        <div style="font-size: 0.85rem; font-weight: 700; color: @pColor; font-family: 'JetBrains Mono', monospace;">
                                            @pnlStr
                                        </div>
                                        <div style="font-size: 0.65rem; color: @pColor;">
                                            @retStr
                                        </div>
                                    </div>
                                    <a href="@posUrl" title="Plan trade" style="color: var(--accent-cyan); font-size: 0.85rem;">
                                        <i class="ph ph-path"></i>
                                    </a>
                                </div>
                            </div>
                        }
                    </div>
                }
                else
                {
                    <div style="text-align: center; padding: 20px; color: var(--text-muted); font-size: 0.85rem;">
                        No open positions. <a href="/planner" style="color: var(--accent-cyan);">Plan your first trade</a>
                    </div>
                }
            </div>

            <!-- Activity Feed -->
            <div class="card">
                <div class="card-header">
                    <span class="card-title"><i class="ph-duotone ph-pulse" style="margin-right: 6px;"></i>Recent Activity</span>
                </div>
                <div style="display: flex; flex-direction: column; gap: 6px; max-height: 340px; overflow-y: auto;">
                    @if (_data.RecentPatterns.Any())
                    {
                        @foreach (var pat in _data.RecentPatterns)
                        {
                            var dirColor = pat.Direction == "Bullish" ? "var(--accent-green)" : pat.Direction == "Bearish" ? "var(--accent-red)" : "var(--text-muted)";
                            var dirIcon = pat.Direction == "Bullish" ? "ph-trend-up" : pat.Direction == "Bearish" ? "ph-trend-down" : "ph-minus";
                            var patUrl = $"/planner?symbol={pat.Asset}";
                            var confStr = pat.Confidence.ToString("F0") + "%";
                            <a href="@patUrl" style="text-decoration: none; display: flex; gap: 10px; padding: 6px 8px; border-radius: 6px; border-left: 3px solid @dirColor;">
                                <div style="flex: 1;">
                                    <div style="display: flex; align-items: center; gap: 6px;">
                                        <i class="ph-bold @dirIcon" style="color: @dirColor; font-size: 0.75rem;"></i>
                                        <span style="font-weight: 600; font-size: 0.8rem; color: var(--text-heading);">@pat.Asset</span>
                                        <span style="font-size: 0.7rem; color: var(--text-muted);">@pat.PatternType</span>
                                        <span style="font-size: 0.65rem; font-weight: 600; color: var(--accent-cyan);">@confStr</span>
                                    </div>
                                    @if (!string.IsNullOrEmpty(pat.AIAnalysis))
                                    {
                                        <div style="font-size: 0.7rem; color: var(--text-muted); margin-top: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 280px;">@pat.AIAnalysis</div>
                                    }
                                </div>
                                <span style="font-size: 0.65rem; color: var(--text-muted); white-space: nowrap; align-self: center;">@pat.CreatedAt.ToString("MMM dd")</span>
                            </a>
                        }
                    }

                    @if (_data.RecentRegimes.Any())
                    {
                        <div style="font-size: 0.65rem; text-transform: uppercase; color: var(--text-muted); padding: 4px 8px; margin-top: 4px;">Regime Changes</div>
                        @foreach (var r in _data.RecentRegimes)
                        {
                            var regimeColor = r.Regime.ToLower() switch
                            {
                                                "trending" => "var(--accent-blue)",
                                                "choppy" => "var(--accent-amber)",
                                                "volexpansion" => "var(--accent-red)",
                                                "meanreversion" => "var(--accent-purple)",
                                _ => "var(--text-muted)"
                            };
                            var regimeConfStr = r.Confidence.ToString("F0") + "%";
                            var regimeDateStr = r.DetectedAt.ToString("MMM dd");
                            <div style="display: flex; gap: 10px; padding: 4px 8px; align-items: center;">
                                <i class="ph-bold ph-wave-sine" style="color: @regimeColor; font-size: 0.75rem;"></i>
                                <span style="font-weight: 600; font-size: 0.8rem; color: var(--text-heading); min-width: 50px;">@r.Symbol</span>
                                <span style="font-size: 0.7rem; color: @regimeColor; font-weight: 600;">@r.Regime</span>
                                <span style="font-size: 0.65rem; color: var(--text-muted);">@regimeConfStr</span>
                                <span style="font-size: 0.65rem; color: var(--text-muted); margin-left: auto;">@regimeDateStr</span>
                            </div>
                        }
                    }

                    @if (!_data.RecentPatterns.Any() && !_data.RecentRegimes.Any())
                    {
                        <div style="text-align: center; padding: 20px; color: var(--text-muted); font-size: 0.85rem;">
                            No recent activity. <a href="/scanner" style="color: var(--accent-cyan);">Run a scan</a> to get started.
                        </div>
                    }
                </div>
            </div>
        </div>

        <!-- Charts Row -->
        <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-bottom: 20px;">
            <div class="card">
                <div class="card-header">
                    <span class="card-title"><i class="ph-duotone ph-chart-line-up" style="margin-right: 6px;"></i>Portfolio Equity Curve</span>
                </div>
                <div style="height: 280px; position: relative;"><canvas id="equityChart"></canvas></div>
            </div>
            <div class="card">
                <div class="card-header">
                    <span class="card-title"><i class="ph-duotone ph-chart-pie" style="margin-right: 6px;"></i>Signal Types</span>
                </div>
                <div style="height: 280px; position: relative;"><canvas id="signalTypePie"></canvas></div>
            </div>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
            <div class="card">
                <div class="card-header">
                    <span class="card-title"><i class="ph-duotone ph-star" style="margin-right: 6px;"></i>Score Distribution</span>
                </div>
                <div style="height: 240px; position: relative;"><canvas id="scoreBarChart"></canvas></div>
            </div>
            <div class="card">
                <div class="card-header">
                    <span class="card-title"><i class="ph-duotone ph-wave-sine" style="margin-right: 6px;"></i>Market Regimes</span>
                </div>
                <div style="height: 240px; position: relative;"><canvas id="regimePie"></canvas></div>
            </div>
        </div>

        <!-- Recent Signals Table -->
        <div class="card">
            <div class="card-header">
                <span class="card-title"><i class="ph-duotone ph-clock-countdown" style="margin-right: 6px;"></i>Recent Signals</span>
                <a href="/signals" class="btn btn-secondary" style="font-size: 0.8rem; padding: 5px 12px;">
                    View All <i class="ph ph-arrow-right" style="margin-left: 4px;"></i>
                </a>
            </div>
            @if (_data.RecentSignals.Any())
            {
                <table class="table">
                    <thead>
                        <tr><th>Asset</th><th>Type</th><th>Score</th><th>Entry</th><th>Created</th><th></th></tr>
                    </thead>
                    <tbody>
                        @foreach (var s in _data.RecentSignals)
                        {
                            var typeClass = s.SignalType.ToLower() == "short" ? "short" : "long";
                            var sigUrl = $"/planner?symbol={s.Asset}";
                            <tr>
                                <td style="font-family: 'JetBrains Mono', monospace; font-weight: 700;">@s.Asset</td>
                                <td>
                                    <span class="signal-type-badge @typeClass">
                                        @if (typeClass == "long")
                                        {
                                            <i class="ph-bold ph-trend-up" style="margin-right: 3px;"></i>
                                        }
                                        else
                                        {

                                            <i class="ph-bold ph-trend-down" style="margin-right: 3px;"></i>
                                        }
                                        @s.SignalType
                                    </span>
                                </td>
                                <td style="font-family: 'JetBrains Mono', monospace;">@s.SetupScore.ToString("F1")</td>
                                <td style="font-family: 'JetBrains Mono', monospace; color: var(--accent-blue);">@s.EntryPrice.ToString("C")</td>
                                <td style="color: var(--text-muted); font-size: 0.8rem;">@s.CreatedAt.ToString("MMM dd, HH:mm")</td>
                                <td><a href="@sigUrl" style="color: var(--accent-cyan);" title="Plan trade"><i class="ph ph-path"></i></a></td>
                            </tr>
                        }
                    </tbody>
                </table>
            }
            else
            {
                <p style="color: var(--text-muted); font-size: 0.85rem; padding: 16px 0;">No signals yet. <a href="/planner" style="color: var(--accent-cyan);">Plan your first trade</a>.</p>
            }
        </div>
    }
</div>

<style>
    .quick-action-card {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 6px;
        padding: 14px 18px;
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: 8px;
        text-decoration: none;
        color: var(--text-heading);
        font-size: 0.75rem;
        font-weight: 500;
        transition: all 0.2s;
        min-width: 100px;
    }

        .quick-action-card:hover {
            border-color: var(--accent-cyan);
            background: var(--surface-hover);
            transform: translateY(-2px);
        }
</style>

@code {
    private DashboardData? _data;
    private UserTradingStatsDto? _simStats;
    private bool _loading = true;
    private bool _loaded;
    private bool _chartsRendered;
    private string? _errorMsg;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender && !_chartsRendered) return;

        if (firstRender && !_loaded)
        {
            _loaded = true;
            var state = await AuthState.GetAuthenticationStateAsync();
            if (!state.User.Identity?.IsAuthenticated ?? true)
            {
                Nav.NavigateTo("/login");
                return;
            }

            try
            {
                _data = await DashApi.GetDashboardAsync();
                try { _simStats = await SimApi.GetUserStatsAsync(); } catch { }
            }
            catch (Exception ex)
            {
                _data = null;
                _errorMsg = $"Error: {ex.Message}";
            }
            finally { _loading = false; }

            _chartsRendered = true;
            StateHasChanged();
            return;
        }

        if (_chartsRendered && _data is not null)
        {
            _chartsRendered = false;
            await RenderCharts();
        }
    }

    private async Task RenderCharts()
    {
        try
        {
            var eqLabels = new List<string>();
            var eqData = new List<double>();
            var bv = 100000.0;
            for (int i = 0; i < 30; i++)
            {
                eqLabels.Add(DateTime.Today.AddDays(-29 + i).ToString("MMM dd"));
                bv += (new Random(i * 42).NextDouble() - 0.45) * 1500;
                eqData.Add(Math.Round(bv, 2));
            }
            await JS.InvokeVoidAsync("createLineChart", "equityChart", eqLabels.ToArray(), eqData.ToArray(), "Portfolio Value", "#06b6d4");

            if (_data!.RecentSignals.Any())
            {
                var tg = _data.RecentSignals.GroupBy(s => s.SignalType).ToList();
                await JS.InvokeVoidAsync("createDoughnutChart", "signalTypePie",
                    tg.Select(g => g.Key).ToArray(),
                    tg.Select(g => (double)g.Count()).ToArray(),
                    tg.Select(g => g.Key.ToLower() == "short" ? "#ef4444" : "#10b981").ToArray());
            }

            var sb = new[] { "0-25", "25-50", "50-75", "75-100" };
            var sc = new double[4];
            foreach (var s in _data.RecentSignals)
            {
                if (s.SetupScore < 25) sc[0]++;
                else if (s.SetupScore < 50) sc[1]++;
                else if (s.SetupScore < 75) sc[2]++; else sc[3]++;
            }
            await JS.InvokeVoidAsync("createBarChart", "scoreBarChart", sb, sc, new[] { "#ef4444", "#f59e0b", "#3b82f6", "#10b981" });

            if (_data.RegimeBreakdown.Any())
            {
                await JS.InvokeVoidAsync("createDoughnutChart", "regimePie",
                    _data.RegimeBreakdown.Select(r => r.Regime).ToArray(),
                    _data.RegimeBreakdown.Select(r => (double)r.Count).ToArray(),
                    _data.RegimeBreakdown.Select(r => r.Regime.ToLower() switch
                    {
                        "trending" => "#3b82f6",
                        "choppy" => "#f59e0b",
                        "volexpansion" => "#ef4444",
                        "meanreversion" => "#a855f7",
                        _ => "#06b6d4"
                    }).ToArray());
            }
        }
        catch { }
    }
}
