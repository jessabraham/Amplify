@page "/dashboard"
@rendermode InteractiveServer
@using Amplify.Web.Services
@inject DashboardApiClient DashApi
@inject AuthStateProvider AuthState
@inject NavigationManager Nav
@inject IJSRuntime JS

<div class="fade-in">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 28px;">
        <h1><i class="ph-duotone ph-squares-four" style="margin-right: 8px; color: var(--accent-cyan);"></i>Dashboard</h1>
        <span style="font-size: 0.8rem; color: var(--text-muted);">
            <i class="ph-light ph-clock" style="margin-right: 4px;"></i>@DateTime.Now.ToString("dddd, MMMM dd yyyy")
        </span>
    </div>

    @if (_loading)
    {
        <div class="card" style="text-align: center; padding: 48px;">
            <i class="ph ph-circle-notch" style="font-size: 2rem; color: var(--accent-blue); animation: spin 1s linear infinite;"></i>
            <p style="color: var(--text-muted); margin-top: 12px;">Loading dashboard...</p>
        </div>
    }
    else if (_data is null)
    {
        <div class="card" style="text-align: center; padding: 48px;">
            <i class="ph-thin ph-chart-pie" style="font-size: 3rem; color: var(--text-muted);"></i>
            <p style="color: var(--text-muted); margin-top: 12px;">Unable to load dashboard data.</p>
        </div>
    }
    else
    {
        <!-- Stats Row -->
        <div class="stats-row">
            <div class="stat-card">
                <div class="stat-label"><i class="ph-light ph-chart-bar" style="margin-right: 4px;"></i>Active Signals</div>
                <div class="stat-value">@_data.TotalSignals</div>
            </div>
            <div class="stat-card">
                <div class="stat-label"><i class="ph-light ph-trend-up" style="margin-right: 4px;"></i>Long Positions</div>
                <div class="stat-value positive">@_data.LongCount</div>
            </div>
            <div class="stat-card">
                <div class="stat-label"><i class="ph-light ph-trend-down" style="margin-right: 4px;"></i>Short Positions</div>
                <div class="stat-value negative">@_data.ShortCount</div>
            </div>
            <div class="stat-card">
                <div class="stat-label"><i class="ph-light ph-star" style="margin-right: 4px;"></i>Avg Score</div>
                <div class="stat-value">@_data.AvgScore</div>
            </div>
            <div class="stat-card">
                <div class="stat-label"><i class="ph-light ph-warning" style="margin-right: 4px;"></i>Avg Risk</div>
                <div class="stat-value" style="color: var(--accent-amber);">@_data.AvgRisk%</div>
            </div>
            <div class="stat-card">
                <div class="stat-label"><i class="ph-light ph-lightning" style="margin-right: 4px;"></i>High Conviction</div>
                <div class="stat-value" style="color: var(--accent-cyan);">@_data.HighConviction</div>
            </div>
        </div>

        <!-- Charts Row -->
        <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-bottom: 20px;">
            <!-- Equity Curve -->
            <div class="card">
                <div class="card-header">
                    <span class="card-title"><i class="ph-duotone ph-chart-line-up" style="margin-right: 6px;"></i>Portfolio Equity Curve</span>
                </div>
                <div style="height: 280px; position: relative;">
                    <canvas id="equityChart"></canvas>
                </div>
            </div>

            <!-- Signal Type Pie -->
            <div class="card">
                <div class="card-header">
                    <span class="card-title"><i class="ph-duotone ph-chart-pie" style="margin-right: 6px;"></i>Signal Types</span>
                </div>
                <div style="height: 280px; position: relative;">
                    <canvas id="signalTypePie"></canvas>
                </div>
            </div>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
            <!-- Score Distribution Bar -->
            <div class="card">
                <div class="card-header">
                    <span class="card-title"><i class="ph-duotone ph-star" style="margin-right: 6px;"></i>Score Distribution</span>
                </div>
                <div style="height: 240px; position: relative;">
                    <canvas id="scoreBarChart"></canvas>
                </div>
            </div>

            <!-- Regime Pie -->
            <div class="card">
                <div class="card-header">
                    <span class="card-title"><i class="ph-duotone ph-wave-sine" style="margin-right: 6px;"></i>Market Regimes</span>
                </div>
                <div style="height: 240px; position: relative;">
                    <canvas id="regimePie"></canvas>
                </div>
            </div>
        </div>

        <!-- Recent Signals Table -->
        <div class="card">
            <div class="card-header">
                <span class="card-title"><i class="ph-duotone ph-clock-countdown" style="margin-right: 6px;"></i>Recent Signals</span>
                <a href="/signals" class="btn btn-secondary" style="font-size: 0.8rem; padding: 5px 12px;">
                    View All <i class="ph ph-arrow-right" style="margin-left: 4px;"></i>
                </a>
            </div>
            @if (_data.RecentSignals.Any())
            {
                <table class="table">
                    <thead>
                        <tr>
                            <th>Asset</th>
                            <th>Type</th>
                            <th>Score</th>
                            <th>Entry</th>
                            <th>Created</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var s in _data.RecentSignals)
                        {
                            var typeClass = s.SignalType.ToLower() == "short" ? "short" : "long";
                            <tr>
                                <td style="font-family: 'JetBrains Mono', monospace; font-weight: 700;">@s.Asset</td>
                                <td>
                                    <span class="signal-type-badge @typeClass">
                                        @if (typeClass == "long")
                                        {
                                            <i class="ph-bold ph-trend-up" style="margin-right: 3px;"></i>
                                        }
                                        else
                                        {
                                            <i class="ph-bold ph-trend-down" style="margin-right: 3px;"></i>
                                        }
                                        @s.SignalType
                                    </span>
                                </td>
                                <td style="font-family: 'JetBrains Mono', monospace;">@s.SetupScore.ToString("F1")</td>
                                <td style="font-family: 'JetBrains Mono', monospace; color: var(--accent-blue);">@s.EntryPrice.ToString("C")</td>
                                <td style="font-family: 'JetBrains Mono', monospace; color: var(--text-muted); font-size: 0.8rem;">@s.CreatedAt.ToString("MMM dd, HH:mm")</td>
                            </tr>
                        }
                    </tbody>
                </table>
            }
            else
            {
                <p style="color: var(--text-muted); font-size: 0.85rem; padding: 16px 0;">No signals created yet. <a href="/signals/create">Create your first signal</a>.</p>
            }
        </div>
    }
</div>

@code {
    private DashboardData? _data;
    private bool _loading = true;
    private bool _loaded;
    private bool _chartsRendered;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender && !_chartsRendered) return;

        if (firstRender && !_loaded)
        {
            _loaded = true;

            var state = await AuthState.GetAuthenticationStateAsync();
            if (!state.User.Identity?.IsAuthenticated ?? true)
            {
                Nav.NavigateTo("/login");
                return;
            }

            try
            {
                _data = await DashApi.GetDashboardAsync();
            }
            catch
            {
                Nav.NavigateTo("/login");
                return;
            }
            finally
            {
                _loading = false;
            }

            _chartsRendered = true;
            StateHasChanged();
            return;
        }

        // Render charts after data is loaded
        if (_chartsRendered && _data is not null)
        {
            _chartsRendered = false;
            await RenderCharts();
        }
    }

    private async Task RenderCharts()
    {
        try
        {
            // Equity Curve (simulated based on signals)
            var equityLabels = new List<string>();
            var equityData = new List<double>();
            var baseValue = 100000.0;

            for (int i = 0; i < 30; i++)
            {
                equityLabels.Add(DateTime.Today.AddDays(-29 + i).ToString("MMM dd"));
                baseValue += (new Random(i * 42).NextDouble() - 0.45) * 1500;
                equityData.Add(Math.Round(baseValue, 2));
            }

            await JS.InvokeVoidAsync("createLineChart",
                "equityChart",
                equityLabels.ToArray(),
                equityData.ToArray(),
                "Portfolio Value",
                "#06b6d4");

            // Signal Type Pie
            if (_data!.RecentSignals.Any())
            {
                var typeGroups = _data.RecentSignals
                    .GroupBy(s => s.SignalType)
                    .ToList();

                var pieLabels = typeGroups.Select(g => g.Key).ToArray();
                var pieData = typeGroups.Select(g => (double)g.Count()).ToArray();
                var pieColors = typeGroups.Select(g =>
                    g.Key.ToLower() == "short" ? "#ef4444" : "#10b981").ToArray();

                await JS.InvokeVoidAsync("createDoughnutChart",
                    "signalTypePie",
                    pieLabels,
                    pieData,
                    pieColors);
            }

            // Score Distribution Bar
            var scoreBuckets = new[] { "0-25", "25-50", "50-75", "75-100" };
            var scoreCounts = new double[4];
            var scoreColors = new[] { "#ef4444", "#f59e0b", "#3b82f6", "#10b981" };

            foreach (var s in _data.RecentSignals)
            {
                if (s.SetupScore < 25) scoreCounts[0]++;
                else if (s.SetupScore < 50) scoreCounts[1]++;
                else if (s.SetupScore < 75) scoreCounts[2]++;
                else scoreCounts[3]++;
            }

            await JS.InvokeVoidAsync("createBarChart",
                "scoreBarChart",
                scoreBuckets,
                scoreCounts,
                scoreColors);

            // Regime Pie
            if (_data.RegimeBreakdown.Any())
            {
                var regimeLabels = _data.RegimeBreakdown.Select(r => r.Regime).ToArray();
                var regimeData = _data.RegimeBreakdown.Select(r => (double)r.Count).ToArray();
                var regimeColors = _data.RegimeBreakdown.Select(r => r.Regime.ToLower() switch
                {
                    "trending" => "#3b82f6",
                    "choppy" => "#f59e0b",
                    "volexpansion" => "#ef4444",
                    "meanreversion" => "#a855f7",
                    _ => "#06b6d4"
                }).ToArray();

                await JS.InvokeVoidAsync("createDoughnutChart",
                    "regimePie",
                    regimeLabels,
                    regimeData,
                    regimeColors);
            }
        }
        catch
        {
            // Charts may fail if JS not loaded yet
        }
    }
}
