@page "/backtest"
@rendermode InteractiveServer
@using Amplify.Web.Services
@using Amplify.Domain.Enumerations
@inject BacktestApiClient BacktestApi
@inject AuthStateProvider AuthState
@inject NavigationManager Nav

<div class="fade-in">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
        <h1><i class="ph-duotone ph-flask" style="margin-right: 8px; color: var(--accent-cyan);"></i>Backtest</h1>
        <button class="btn btn-primary" @onclick="() => _showForm = !_showForm">
            <i class="ph-bold ph-play"></i> Run Backtest
        </button>
    </div>

    @if (_showForm)
    {
        <div class="card" style="margin-bottom: 24px; max-width: 820px;">
            <h3 style="margin-bottom: 16px;">
                <i class="ph-duotone ph-gear" style="color: var(--accent-cyan); margin-right: 6px;"></i>Backtest Configuration
            </h3>

            @if (!string.IsNullOrEmpty(_error))
            {
                <div class="login-error" style="margin-bottom: 16px;">
                    <i class="ph-bold ph-warning" style="margin-right: 6px;"></i>@_error
                </div>
            }

            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px;">
                <div class="form-group">
                    <label><i class="ph-light ph-chart-bar" style="margin-right: 4px;"></i>Asset Symbol</label>
                    <input type="text" @bind="_asset" placeholder="AAPL, TSLA, BTC..." />
                </div>

                <div class="form-group">
                    <label><i class="ph-light ph-tag" style="margin-right: 4px;"></i>Asset Class</label>
                    <select @bind="_assetClass">
                        @foreach (var val in Enum.GetValues<AssetClass>())
                        {
                            <option value="@((int)val)">@val</option>
                        }
                    </select>
                </div>

                <div class="form-group">
                    <label><i class="ph-light ph-trend-up" style="margin-right: 4px;"></i>Signal Type</label>
                    <select @bind="_signalType">
                        @foreach (var val in Enum.GetValues<SignalType>())
                        {
                            <option value="@((int)val)">@val</option>
                        }
                    </select>
                </div>

                <div class="form-group">
                    <label><i class="ph-light ph-wave-sine" style="margin-right: 4px;"></i>Market Regime</label>
                    <select @bind="_regime">
                        @foreach (var val in Enum.GetValues<MarketRegime>())
                        {
                            <option value="@((int)val)">@val</option>
                        }
                    </select>
                </div>

                <div class="form-group">
                    <label><i class="ph-light ph-calendar" style="margin-right: 4px;"></i>Start Date</label>
                    <input type="date" @bind="_startDate" />
                </div>

                <div class="form-group">
                    <label><i class="ph-light ph-calendar" style="margin-right: 4px;"></i>End Date</label>
                    <input type="date" @bind="_endDate" />
                </div>

                <div class="form-group">
                    <label><i class="ph-light ph-currency-dollar" style="margin-right: 4px;"></i>Initial Capital</label>
                    <input type="number" @bind="_initialCapital" step="1000" />
                </div>
            </div>

            <div style="margin-top: 16px; display: flex; gap: 10px;">
                <button class="btn btn-primary" @onclick="RunBacktest" disabled="@_running">
                    @if (_running)
                    {
                        <i class="ph ph-circle-notch" style="animation: spin 1s linear infinite;"></i>
                        <span>Running...</span>
                    }
                    else
                    {
                        <i class="ph-bold ph-play"></i>
                        <span>Run Backtest</span>
                    }
                </button>
                <button class="btn btn-secondary" @onclick="() => _showForm = false">Cancel</button>
            </div>
        </div>
    }

    <!-- Latest Result -->
    @if (_latestResult is not null)
    {
        <div class="card" style="margin-bottom: 24px; border: 1px solid rgba(6, 182, 212, 0.3);">
            <div class="card-header">
                <span class="card-title">
                    <i class="ph-duotone ph-chart-line-up" style="margin-right: 6px; color: var(--accent-cyan);"></i>Latest Result —
                    <span style="font-family: 'JetBrains Mono', monospace;">@_latestResult.Asset</span>
                    <span class="signal-type-badge @(_latestResult.SignalType.ToLower() == "short" ? "short" : "long")" style="margin-left: 8px; font-size: 0.6rem;">@_latestResult.SignalType</span>
                </span>
                <span style="font-size: 0.75rem; color: var(--text-muted);">@_latestResult.StartDate.ToString("MMM dd, yyyy") — @_latestResult.EndDate.ToString("MMM dd, yyyy")</span>
            </div>

            <div class="stats-row" style="margin-bottom: 0;">
                <div class="stat-card">
                    <div class="stat-label"><i class="ph-light ph-hash" style="margin-right: 4px;"></i>Total Trades</div>
                    <div class="stat-value">@_latestResult.TotalTrades</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label"><i class="ph-light ph-trophy" style="margin-right: 4px;"></i>Win Rate</div>
                    <div class="stat-value" style="color: @(_latestResult.WinRate >= 50 ? "var(--accent-green)" : "var(--accent-red)");">@_latestResult.WinRate%</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label"><i class="ph-light ph-scales" style="margin-right: 4px;"></i>Profit Factor</div>
                    <div class="stat-value" style="color: @(_latestResult.ProfitFactor >= 1.5m ? "var(--accent-green)" : _latestResult.ProfitFactor >= 1m ? "var(--accent-amber)" : "var(--accent-red)");">@_latestResult.ProfitFactor</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label"><i class="ph-light ph-arrow-down" style="margin-right: 4px;"></i>Max Drawdown</div>
                    <div class="stat-value" style="color: var(--accent-red);">@_latestResult.MaxDrawdown%</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label"><i class="ph-light ph-currency-dollar" style="margin-right: 4px;"></i>Net P&L</div>
                    <div class="stat-value @(_latestResult.NetPnL >= 0 ? "positive" : "negative")">@_latestResult.NetPnL.ToString("+$#,##0.00;-$#,##0.00")</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label"><i class="ph-light ph-lightning" style="margin-right: 4px;"></i>Sharpe Ratio</div>
                    <div class="stat-value" style="color: @(_latestResult.SharpeRatio >= 2m ? "var(--accent-green)" : _latestResult.SharpeRatio >= 1m ? "var(--accent-amber)" : "var(--accent-red)");">@_latestResult.SharpeRatio</div>
                </div>
            </div>
        </div>
    }

    <!-- History -->
    @if (_loading)
    {
        <div class="card" style="text-align: center; padding: 48px;">
            <i class="ph ph-circle-notch" style="font-size: 2rem; color: var(--accent-blue); animation: spin 1s linear infinite;"></i>
        </div>
    }
    else if (_backtests.Count == 0 && _latestResult is null)
    {
        <div class="card" style="text-align: center; padding: 48px;">
            <i class="ph-thin ph-flask" style="font-size: 3rem; color: var(--text-muted);"></i>
            <p style="color: var(--text-muted); font-size: 1.1rem; margin-top: 12px;">No backtests run yet.</p>
            <p style="color: var(--text-muted); font-size: 0.85rem; margin-top: 4px;">Configure parameters above and run your first backtest.</p>
        </div>
    }
    else if (_backtests.Count > 0)
    {
        <div class="card">
            <div class="card-header">
                <span class="card-title"><i class="ph-duotone ph-clock-countdown" style="margin-right: 6px;"></i>Backtest History</span>
                <span style="font-size: 0.75rem; color: var(--text-muted);">@_backtests.Count runs</span>
            </div>
            <table class="table">
                <thead>
                    <tr>
                        <th>Asset</th>
                        <th>Type</th>
                        <th>Regime</th>
                        <th>Trades</th>
                        <th>Win Rate</th>
                        <th>Profit Factor</th>
                        <th>Drawdown</th>
                        <th>Net P&L</th>
                        <th>Sharpe</th>
                        <th>Date</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var b in _backtests)
                    {
                        <tr>
                            <td style="font-family: 'JetBrains Mono', monospace; font-weight: 700;">@b.Asset</td>
                            <td>
                                <span class="signal-type-badge @(b.SignalType.ToLower() == "short" ? "short" : "long")" style="font-size: 0.6rem;">
                                    @b.SignalType
                                </span>
                            </td>
                            <td>
                                <span class="regime-badge @(b.Regime.ToLower().Replace("volexpansion", "vol-expansion").Replace("meanreversion", "mean-reversion"))" style="font-size: 0.6rem;">
                                    @b.Regime
                                </span>
                            </td>
                            <td style="font-family: 'JetBrains Mono', monospace;">@b.TotalTrades</td>
                            <td style="font-family: 'JetBrains Mono', monospace; color: @(b.WinRate >= 50 ? "var(--accent-green)" : "var(--accent-red)");">@b.WinRate%</td>
                            <td style="font-family: 'JetBrains Mono', monospace; color: @(b.ProfitFactor >= 1.5m ? "var(--accent-green)" : b.ProfitFactor >= 1m ? "var(--accent-amber)" : "var(--accent-red)");">@b.ProfitFactor</td>
                            <td style="font-family: 'JetBrains Mono', monospace; color: var(--accent-red);">@b.MaxDrawdown%</td>
                            <td style="font-family: 'JetBrains Mono', monospace; color: @(b.NetPnL >= 0 ? "var(--accent-green)" : "var(--accent-red)");">@b.NetPnL.ToString("+$#,##0;-$#,##0")</td>
                            <td style="font-family: 'JetBrains Mono', monospace;">@b.SharpeRatio</td>
                            <td style="font-family: 'JetBrains Mono', monospace; font-size: 0.75rem; color: var(--text-muted);">@b.CreatedAt.ToString("MMM dd")</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
</div>

@code {
    private List<BacktestDto> _backtests = new();
    private BacktestDto? _latestResult;
    private bool _loading = true;
    private bool _loaded;
    private bool _showForm;
    private bool _running;
    private string? _error;

    // Form fields
    private string _asset = "";
    private int _assetClass;
    private int _signalType;
    private int _regime;
    private DateTime _startDate = DateTime.Today.AddMonths(-6);
    private DateTime _endDate = DateTime.Today;
    private decimal _initialCapital = 100000;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender || _loaded) return;
        _loaded = true;

        var state = await AuthState.GetAuthenticationStateAsync();
        if (!state.User.Identity?.IsAuthenticated ?? true)
        {
            Nav.NavigateTo("/login");
            return;
        }

        try
        {
            _backtests = await BacktestApi.GetBacktestsAsync();
        }
        catch
        {
            Nav.NavigateTo("/login");
            return;
        }
        finally { _loading = false; }

        StateHasChanged();
    }

    private async Task RunBacktest()
    {
        _error = null;

        if (string.IsNullOrWhiteSpace(_asset))
        {
            _error = "Asset symbol is required.";
            return;
        }

        if (_startDate >= _endDate)
        {
            _error = "Start date must be before end date.";
            return;
        }

        if (_initialCapital < 1000)
        {
            _error = "Initial capital must be at least $1,000.";
            return;
        }

        _running = true;

        var dto = new RunBacktestDto
        {
            Asset = _asset.ToUpper().Trim(),
            AssetClass = _assetClass,
            SignalType = _signalType,
            Regime = _regime,
            StartDate = _startDate,
            EndDate = _endDate,
            InitialCapital = _initialCapital
        };

        _latestResult = await BacktestApi.RunBacktestAsync(dto);

        if (_latestResult is not null)
        {
            _showForm = false;
            _backtests = await BacktestApi.GetBacktestsAsync();
        }
        else
        {
            _error = "Failed to run backtest.";
        }

        _running = false;
    }
}
