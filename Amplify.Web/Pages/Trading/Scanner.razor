@page "/scanner"
@rendermode InteractiveServer
@using Amplify.Web.Services
@inject PatternScannerApiClient ScannerApi
@inject AuthStateProvider AuthState
@inject NavigationManager Nav
@inject IJSRuntime JS

<div class="fade-in">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
        <h1><i class="ph-duotone ph-crosshair" style="margin-right: 8px; color: var(--accent-cyan);"></i>Pattern Scanner</h1>
    </div>

    <!-- Scan Controls -->
    <div class="card" style="margin-bottom: 20px;">
        <div style="display: flex; align-items: flex-end; gap: 16px; flex-wrap: wrap;">
            <div class="form-group" style="margin-bottom: 0; min-width: 160px;">
                <label><i class="ph-light ph-chart-bar" style="margin-right: 4px;"></i>Symbol</label>
                <input type="text" @bind="_symbol" placeholder="AAPL, TSLA, MSFT..." @onkeydown="HandleKeyDown" />
            </div>
            <div class="form-group" style="margin-bottom: 0; min-width: 130px;">
                <label><i class="ph-light ph-star" style="margin-right: 4px;"></i>Min Confidence</label>
                <select @bind="_minConfidence">
                    <option value="0">All</option>
                    <option value="50">50+</option>
                    <option value="60">60+</option>
                    <option value="70">70+</option>
                    <option value="80">80+</option>
                </select>
            </div>
            <div class="form-group" style="margin-bottom: 0; min-width: 130px;">
                <label><i class="ph-light ph-arrows-down-up" style="margin-right: 4px;"></i>Direction</label>
                <select @bind="_direction">
                    <option value="All">All</option>
                    <option value="Bullish">Bullish</option>
                    <option value="Bearish">Bearish</option>
                    <option value="Neutral">Neutral</option>
                </select>
            </div>
            <div class="form-group" style="margin-bottom: 0; min-width: 130px;">
                <label><i class="ph-light ph-robot" style="margin-right: 4px;"></i>AI Analysis</label>
                <select @bind="_enableAI">
                    <option value="true">Enabled</option>
                    <option value="false">Disabled</option>
                </select>
            </div>
            <button class="btn btn-primary" @onclick="RunScan" disabled="@_scanning" style="height: 40px;">
                @if (_scanning)
                {
                    <i class="ph ph-circle-notch" style="animation: spin 1s linear infinite;"></i>
                    <span>Scanning 1H + 4H + Daily + Weekly...</span>
                }
                else
                {
                    <i class="ph-bold ph-magnifying-glass"></i>
                    <span>Multi-Timeframe Scan</span>
                }
            </button>
        </div>

        <!-- Quick scan buttons -->
        <div style="margin-top: 12px; display: flex; gap: 8px; flex-wrap: wrap;">
            <span style="font-size: 0.7rem; color: var(--text-muted); align-self: center;">Quick:</span>
            @foreach (var ticker in new[] { "AAPL", "TSLA", "MSFT", "NVDA", "GOOGL", "AMZN", "META", "COIN" })
            {
                var t = ticker;
                <button class="btn-chip @(_symbol.ToUpper() == t ? "active" : "")" @onclick="() => QuickScan(t)">@t</button>
            }
        </div>
    </div>

    @if (!string.IsNullOrEmpty(_error))
    {
        <div class="login-error" style="margin-bottom: 20px;">
            <i class="ph-bold ph-warning" style="margin-right: 6px;"></i>@_error
        </div>
    }

    @if (_result is not null)
    {
        <!-- Symbol + Price Header -->
        <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 16px;">
            <span style="font-size: 1.2rem; font-weight: 700; font-family: 'JetBrains Mono', monospace; color: var(--text-heading);">
                @_result.Symbol
            </span>
            <span style="font-family: 'JetBrains Mono', monospace; color: var(--accent-blue);">
                @_result.CurrentPrice.ToString("C")
            </span>
            <span style="font-size: 0.8rem; color: var(--text-muted);">
                @_result.TotalPatterns patterns across 4 timeframes
            </span>
        </div>

        <!-- ═══ MULTI-TIMEFRAME REGIME ═══ -->
        <div class="card" style="margin-bottom: 16px;">
            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
                <i class="ph-duotone ph-stack" style="font-size: 1.1rem; color: var(--accent-cyan);"></i>
                <span style="font-weight: 700; color: var(--text-heading);">Multi-Timeframe Regime</span>
            </div>

            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 14px; flex-wrap: wrap;">
                @{
                    var regCss = _result.CombinedRegime.ToLower().Replace("volexpansion", "vol-expansion").Replace("meanreversion", "mean-reversion");
                    var alignColor = _result.RegimeAlignment == "Aligned" ? "var(--accent-green)" : _result.RegimeAlignment == "Conflicting" ? "var(--accent-red)" : "var(--accent-amber)";
                    var dirAlignColor = _result.DirectionAlignment.Contains("All Bullish") ? "var(--accent-green)" : _result.DirectionAlignment.Contains("All Bearish") ? "var(--accent-red)" : _result.DirectionAlignment == "Conflicting" ? "var(--accent-red)" : "var(--accent-amber)";
                }
                <span class="regime-badge @regCss" style="font-size: 0.9rem; padding: 6px 16px;">@_result.CombinedRegime</span>
                <span style="font-size: 0.8rem; color: var(--text-muted);">
                    Confidence: <span style="font-weight: 700; color: var(--accent-cyan);">@(_result.CombinedRegimeConfidence.ToString("F0"))%</span>
                </span>
                <span style="font-size: 0.75rem; padding: 3px 10px; border-radius: 4px; background: rgba(255,255,255,0.05); color: @alignColor; font-weight: 600;">
                    Regime: @_result.RegimeAlignment
                </span>
                <span style="font-size: 0.75rem; padding: 3px 10px; border-radius: 4px; background: rgba(255,255,255,0.05); color: @dirAlignColor; font-weight: 600;">
                    Direction: @_result.DirectionAlignment
                    @if (_result.AlignmentScore > 0)
                    {
                        <span style="opacity: 0.6; margin-left: 4px;">(@(_result.AlignmentScore.ToString("F0"))%)</span>
                    }
                </span>
            </div>

            <!-- Per-Timeframe Grid -->
            @if (_result.TimeframeSummaries?.Any() == true)
            {
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;">
                    @foreach (var tf in _result.TimeframeSummaries)
                    {
                        var tfDirColor = tf.DominantDirection == "Bullish" ? "var(--accent-green)" : tf.DominantDirection == "Bearish" ? "var(--accent-red)" : "var(--text-muted)";
                        var tfRegCss = tf.Regime.ToLower().Replace("volexpansion", "vol-expansion").Replace("meanreversion", "mean-reversion");
                        var tfWeight = tf.Timeframe == "Weekly" ? "3x weight" : tf.Timeframe == "Daily" ? "2x weight" : "1x weight";
                        <div style="background: var(--surface-hover); border-radius: 8px; padding: 12px 14px; border: 1px solid var(--border);">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <span style="font-weight: 700; color: var(--text-heading); font-size: 0.9rem;">@tf.Timeframe</span>
                                <span style="font-size: 0.6rem; color: var(--text-muted); opacity: 0.6;">@tfWeight</span>
                            </div>
                            <div style="display: flex; gap: 8px; flex-wrap: wrap; font-size: 0.75rem; margin-bottom: 6px;">
                                <span class="regime-badge @tfRegCss" style="font-size: 0.65rem; padding: 2px 8px;">@tf.Regime</span>
                                <span style="color: @tfDirColor; font-weight: 600;">@tf.DominantDirection</span>
                            </div>
                            <div style="font-size: 0.72rem; color: var(--text-muted);">
                                @tf.BullishCount bullish · @tf.BearishCount bearish · @tf.PatternCount total
                            </div>
                            @if (tf.RSI.HasValue)
                            {
                                var rsiColor = tf.RSI < 30 ? "var(--accent-green)" : tf.RSI > 70 ? "var(--accent-red)" : "var(--text-muted)";
                                <div style="font-size: 0.7rem; color: @rsiColor; margin-top: 4px;">RSI: @tf.RSI?.ToString("F0") · Volume: @tf.VolumeProfile</div>
                            }
                        </div>
                    }
                </div>
            }
        </div>

        <!-- ═══ CONTEXT LAYERS ═══ -->
        @if (_result.Context is not null)
        {
            var ctx = _result.Context;
            <div class="card" style="margin-bottom: 16px;">
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
                    <i class="ph-duotone ph-chart-line-up" style="font-size: 1.1rem; color: var(--accent-cyan);"></i>
                    <span style="font-weight: 700; color: var(--text-heading);">Market Context</span>
                </div>

                <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 12px; margin-bottom: 12px;">
                    <div class="pattern-level">
                        <div class="pattern-level-label">Volume</div>
                        @{
                            var volColor = ctx.VolumeProfile == "Breakout" ? "var(--accent-green)" : ctx.VolumeProfile == "Low" ? "var(--accent-red)" : "var(--text-heading)";
                        }
                        <div class="pattern-level-value" style="color: @volColor;">@ctx.VolumeProfile (@(ctx.VolumeRatio)x)</div>
                    </div>
                    <div class="pattern-level">
                        <div class="pattern-level-label">MA Stack</div>
                        @{
                            var maColor = ctx.MAAlignment.Contains("Bullish") ? "var(--accent-green)" : ctx.MAAlignment.Contains("Bearish") ? "var(--accent-red)" : "var(--text-heading)";
                        }
                        <div class="pattern-level-value" style="color: @maColor;">@ctx.MAAlignment</div>
                    </div>
                    <div class="pattern-level">
                        <div class="pattern-level-label">RSI (14)</div>
                        @{
                            var rsiZoneColor = ctx.RSIZone == "Oversold" ? "var(--accent-green)" : ctx.RSIZone == "Overbought" ? "var(--accent-red)" : "var(--text-heading)";
                        }
                        <div class="pattern-level-value" style="color: @rsiZoneColor;">@ctx.RSI?.ToString("F0") (@ctx.RSIZone)</div>
                    </div>
                    <div class="pattern-level">
                        <div class="pattern-level-label">Volatility</div>
                        <div class="pattern-level-value">@ctx.ATRPercent?.ToString("F2")%</div>
                    </div>
                    <div class="pattern-level">
                        <div class="pattern-level-label">Streak</div>
                        @if (ctx.ConsecutiveUpDays > 0)
                        {
                            <div class="pattern-level-value" style="color: var(--accent-green);">@ctx.ConsecutiveUpDays days up</div>
                        }
                        else if (ctx.ConsecutiveDownDays > 0)
                        {
                            <div class="pattern-level-value" style="color: var(--accent-red);">@ctx.ConsecutiveDownDays days down</div>
                        }
                        else
                        {
                            <div class="pattern-level-value">—</div>
                        }
                    </div>
                </div>

                <div style="display: flex; gap: 20px; font-size: 0.78rem; flex-wrap: wrap;">
                    @if (ctx.NearestSupport.HasValue)
                    {
                        <span style="color: var(--accent-green);">
                            <i class="ph-bold ph-arrow-down" style="margin-right: 3px;"></i>Support: @ctx.NearestSupport?.ToString("C2")
                            <span style="opacity: 0.6;">(@ctx.DistToSupportPct?.ToString("F1")% below)</span>
                        </span>
                    }
                    @if (ctx.NearestResistance.HasValue)
                    {
                        <span style="color: var(--accent-red);">
                            <i class="ph-bold ph-arrow-up" style="margin-right: 3px;"></i>Resistance: @ctx.NearestResistance?.ToString("C2")
                            <span style="opacity: 0.6;">(@ctx.DistToResistancePct?.ToString("F1")% above)</span>
                        </span>
                    }
                    @if (ctx.DistFromSMA200Pct.HasValue)
                    {
                        var sma200Color = Math.Abs(ctx.DistFromSMA200Pct.Value) > 15 ? "var(--accent-red)" : "var(--text-muted)";
                        <span style="color: @sma200Color; margin-left: auto;">@(ctx.DistFromSMA200Pct.Value.ToString("+0.0;-0.0"))% from SMA200</span>
                    }
                </div>

                @if (ctx.KeyLevels?.Any() == true)
                {
                    <div style="margin-top: 10px; display: flex; gap: 8px; flex-wrap: wrap;">
                        <span style="font-size: 0.65rem; color: var(--text-muted); align-self: center;">Key Levels:</span>
                        @foreach (var kl in ctx.KeyLevels)
                        {
                            var klColor = kl.Type == "Support" ? "var(--accent-green)" : kl.Type == "Resistance" ? "var(--accent-red)" : "var(--text-muted)";
                            <span style="font-size: 0.65rem; padding: 2px 6px; border-radius: 3px; background: rgba(255,255,255,0.05); color: @klColor;">
                                @kl.Type @kl.Price.ToString("C2") @(kl.TouchCount > 0 ? $"({kl.TouchCount}x)" : "")
                            </span>
                        }
                    </div>
                }
            </div>
        }

        <!-- ═══ AI ANALYSIS ═══ -->
        @if (_result.AIAnalysis is not null)
        {
            var ai = _result.AIAnalysis;
            var biasColor = ai.OverallBias switch
            {
                            "Strong Bullish" or "Bullish" => "var(--accent-green)",
                            "Strong Bearish" or "Bearish" => "var(--accent-red)",
                _ => "var(--accent-amber)"
            };
            var actionColor = ai.RecommendedAction switch
            {
                            "Buy" => "var(--accent-green)",
                            "Sell" => "var(--accent-red)",
                _ => "var(--accent-amber)"
            };
            var biasIcon = ai.OverallBias switch
            {
                            "Strong Bullish" or "Bullish" => "ph-trend-up",
                            "Strong Bearish" or "Bearish" => "ph-trend-down",
                _ => "ph-minus"
            };

            <div class="card ai-panel" style="margin-bottom: 20px; border-left: 3px solid @biasColor;">
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
                    <i class="ph-duotone ph-robot" style="font-size: 1.2rem; color: var(--accent-cyan);"></i>
                    <span style="font-size: 1rem; font-weight: 700; color: var(--text-heading);">AI Multi-Timeframe Analysis</span>
                    <span style="font-size: 0.6rem; background: rgba(6, 182, 212, 0.15); color: var(--accent-cyan); padding: 2px 8px; border-radius: 10px;">Ollama</span>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                    <div class="pattern-level">
                        <div class="pattern-level-label">Overall Bias</div>
                        <div class="pattern-level-value" style="color: @biasColor;">
                            <i class="ph-bold @biasIcon" style="margin-right: 3px;"></i>@ai.OverallBias
                        </div>
                    </div>
                    <div class="pattern-level">
                        <div class="pattern-level-label">AI Confidence</div>
                        <div class="pattern-level-value" style="color: var(--accent-cyan);">@ai.OverallConfidence%</div>
                    </div>
                    <div class="pattern-level">
                        <div class="pattern-level-label">Action</div>
                        <div class="pattern-level-value" style="color: @actionColor; font-weight: 700;">@ai.RecommendedAction</div>
                    </div>
                    <div class="pattern-level">
                        <div class="pattern-level-label">Risk : Reward</div>
                        <div class="pattern-level-value" style="color: var(--accent-blue);">@ai.RiskReward</div>
                    </div>
                </div>

                @if (ai.RecommendedEntry.HasValue)
                {
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                        <div class="pattern-level">
                            <div class="pattern-level-label">AI Entry</div>
                            <div class="pattern-level-value" style="color: var(--accent-blue);">@ai.RecommendedEntry.Value.ToString("C")</div>
                        </div>
                        <div class="pattern-level">
                            <div class="pattern-level-label">AI Stop</div>
                            <div class="pattern-level-value" style="color: var(--accent-red);">@(ai.RecommendedStop?.ToString("C") ?? "—")</div>
                        </div>
                        <div class="pattern-level">
                            <div class="pattern-level-label">AI Target</div>
                            <div class="pattern-level-value" style="color: var(--accent-green);">@(ai.RecommendedTarget?.ToString("C") ?? "—")</div>
                        </div>
                    </div>
                }

                <div style="margin-bottom: 12px;">
                    <div style="font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.05em; color: var(--text-muted); margin-bottom: 6px;">Summary</div>
                    <p style="font-size: 0.85rem; color: var(--text-secondary); line-height: 1.6; margin: 0;">@ai.Summary</p>
                </div>

                @if (!string.IsNullOrEmpty(ai.DetailedAnalysis))
                {
                    <div style="margin-bottom: 12px;">
                        <button class="btn-chip" style="margin-bottom: 8px;" @onclick="() => _showDetail = !_showDetail">
                            <i class="ph @(_showDetail ? "ph-caret-up" : "ph-caret-down")" style="margin-right: 4px;"></i>
                            @(_showDetail ? "Hide" : "Show") Detailed Analysis
                        </button>
                        @if (_showDetail)
                        {
                            <p style="font-size: 0.82rem; color: var(--text-secondary); line-height: 1.6; margin: 0; padding: 12px; background: var(--bg-input); border-radius: var(--radius-sm);">@ai.DetailedAnalysis</p>
                        }
                    </div>
                }

                @if (_result.Patterns.Any(p => p.Timeframe == _chartTimeframe && !string.IsNullOrEmpty(p.AIGrade)))
                {
                    <div>
                        <div style="font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.05em; color: var(--text-muted); margin-bottom: 8px;">Pattern Verdicts</div>
                        @foreach (var p in _result.Patterns.Where(p => p.Timeframe == _chartTimeframe && !string.IsNullOrEmpty(p.AIGrade)))
                        {
                            var gradeColor = p.AIGrade switch
                            {
                                                    "A+" or "A" => "var(--accent-green)",
                                                    "B+" or "B" => "var(--accent-cyan)",
                                                    "C" => "var(--accent-amber)",
                                _ => "var(--accent-red)"
                            };
                            var tfBadge = p.Timeframe == "Weekly" ? "rgba(123,97,255,0.3)" : p.Timeframe == "1H" ? "rgba(255,255,255,0.05)" : "rgba(0,200,200,0.15)";

                            <div style="display: flex; align-items: center; gap: 10px; padding: 6px 0; border-bottom: 1px solid var(--border);">
                                <span style="font-size: 0.55rem; padding: 1px 5px; border-radius: 3px; background: @tfBadge; min-width: 36px; text-align: center;">@p.Timeframe</span>
                                <span style="font-family: 'JetBrains Mono', monospace; font-size: 0.8rem; font-weight: 700; color: @gradeColor; min-width: 28px;">@p.AIGrade</span>
                                <span style="font-size: 0.7rem; min-width: 16px;">@(p.AIValid ? "✓" : "✗")</span>
                                <span style="font-size: 0.8rem; font-weight: 600; color: var(--text-heading); min-width: 160px;">@p.PatternName</span>
                                <span style="font-size: 0.75rem; color: var(--text-muted);">@p.AIReason</span>
                            </div>
                        }
                    </div>
                }
            </div>
        }

        <!-- Action Buttons -->
        <div style="display: flex; gap: 10px; margin-bottom: 20px;">
            @{
                var plannerUrl = $"/planner?symbol={_result.Symbol}";
            }
            <a href="@plannerUrl" class="btn btn-primary" style="font-size: 0.85rem;">
                <i class="ph-bold ph-path" style="margin-right: 4px;"></i>Plan Trade for @_result.Symbol
            </a>
            <a href="/risk" class="btn btn-secondary" style="font-size: 0.85rem;">
                <i class="ph-light ph-shield-check" style="margin-right: 4px;"></i>Risk Calculator
            </a>
        </div>

        <!-- ═══ PATTERN CHART OVERLAY ═══ -->
        @if (_result.ChartCandles.Any())
        {
            <div class="card" style="margin-bottom: 20px; padding: 0; overflow: hidden;">
                <!-- Header -->
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px 16px; border-bottom: 1px solid var(--border);">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <i class="ph-duotone ph-chart-line" style="font-size: 1.1rem; color: var(--accent-cyan);"></i>
                        <span style="font-weight: 700; color: var(--text-heading);">@_result.Symbol Chart</span>
                        <div style="display: flex; gap: 2px; background: rgba(255,255,255,0.04); border-radius: 6px; padding: 2px;">
                            @foreach (var tf in new[] { "1H", "4H", "Daily", "Weekly" })
                            {
                                var isActive = _chartTimeframe == tf;
                                var patternCount = _result.Patterns.Count(p => p.Timeframe == tf);
                                <button @onclick="() => SwitchChartTimeframe(tf)"
                                        style="font-size: 0.6rem; padding: 2px 10px; border-radius: 4px; border: none; cursor: pointer;
                                                       background: @(isActive ? "rgba(6,182,212,0.25)" : "transparent");
                                                       color: @(isActive ? "var(--accent-cyan)" : "var(--text-muted)");
                                                       font-weight: @(isActive ? "700" : "500"); transition: all 0.15s;">
                                    @tf
                                    @if (patternCount > 0)
                                    {
                                        <span style="opacity: 0.5; margin-left: 2px;">@patternCount</span>
                                    }
                                </button>
                            }
                        </div>
                        @if (!string.IsNullOrEmpty(_result.DataSource))
                        {
                            var isLive = _result.DataSource == "Alpaca";
                            <span style="font-size: 0.6rem; background: @(isLive ? "rgba(16,185,129,0.15)" : "rgba(251,191,36,0.15)"); color: @(isLive ? "var(--accent-green)" : "#fbbf24"); padding: 2px 8px; border-radius: 10px;">
                                <i class="ph-bold @(isLive ? "ph-broadcast" : "ph-flask")" style="margin-right: 3px;"></i>@_result.DataSource
                            </span>
                        }
                    </div>
                    <div style="display: flex; gap: 12px; align-items: center;">
                        @if (_selectedPatterns.Any())
                        {
                            <button class="btn btn-secondary" style="font-size: 0.7rem; padding: 3px 10px;" @onclick="ClearPatternSelection">
                                <i class="ph ph-x" style="margin-right: 3px;"></i>Clear
                            </button>
                        }
                        <span style="font-size: 0.65rem; color: var(--text-muted);">
                            @if (_selectedPatterns.Any())
                            {
                                <span>@_selectedPatterns.Count selected</span>
                            }
                            else
                            {

                                <span>Click patterns to highlight</span>
                            }
                        </span>
                    </div>
                </div>

                <!-- Split: Pattern Selector Panel + Chart -->
                <div style="display: grid; grid-template-columns: 220px 1fr; min-height: 480px;">
                    <!-- Pattern Selector Panel -->
                    <div style="border-right: 1px solid var(--border); padding: 8px; overflow-y: auto; max-height: 480px; background: rgba(0,0,0,0.15);">
                        @{
                            var tfPatternCount = _result.Patterns.Count(p => p.Timeframe == _chartTimeframe);
                        }
                        <div style="font-size: 0.6rem; text-transform: uppercase; letter-spacing: 0.05em; color: var(--text-muted); padding: 4px 8px; margin-bottom: 4px;">
                            Detected Patterns (@tfPatternCount)
                        </div>
                        @if (tfPatternCount == 0)
                        {
                            <div style="padding: 24px 12px; text-align: center;">
                                <i class="ph-duotone ph-magnifying-glass" style="font-size: 1.5rem; color: var(--text-muted); opacity: 0.4;"></i>
                                <p style="font-size: 0.75rem; color: var(--text-muted); margin-top: 8px;">No patterns detected on @_chartTimeframe</p>
                            </div>
                        }
                        @for (int i = 0; i < _result.Patterns.Count; i++)
                        {
                            var idx = i;
                            var p = _result.Patterns[idx];
                            if (p.Timeframe != _chartTimeframe) continue;
                            var isSelected = _selectedPatterns.Contains(idx);
                            var dirColor = p.Direction == "Bullish" ? "var(--accent-green)" : p.Direction == "Bearish" ? "var(--accent-red)" : "var(--text-muted)";
                            var bgColor = isSelected ? "rgba(6, 182, 212, 0.15)" : "transparent";
                            var borderColor = isSelected ? "var(--accent-cyan)" : "transparent";

                            <div @onclick="() => TogglePattern(idx)"
                                 style="padding: 8px; border-radius: 6px; margin-bottom: 4px; cursor: pointer;
                                                    background: @bgColor; border: 1px solid @borderColor;
                                                    transition: all 0.15s ease; @(!p.AIValid ? "opacity: 0.4;" : "")"
                                 class="pattern-select-item">

                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 3px;">
                                    <span style="font-size: 0.75rem; font-weight: 600; color: var(--text-heading);">@p.PatternName</span>
                                    @if (!string.IsNullOrEmpty(p.AIGrade))
                                    {
                                        var gradeCol = p.AIGrade.StartsWith("A") ? "var(--accent-green)" : p.AIGrade.StartsWith("B") ? "var(--accent-amber)" : "var(--accent-red)";
                                        <span style="font-size: 0.55rem; padding: 1px 5px; border-radius: 3px; background: rgba(255,255,255,0.06); color: @gradeCol; font-weight: 700;">@p.AIGrade</span>
                                    }
                                </div>

                                <div style="display: flex; gap: 6px; align-items: center; font-size: 0.6rem;">
                                    <span style="color: @dirColor; font-weight: 600;">@(p.Direction == "Bullish" ? "▲" : p.Direction == "Bearish" ? "▼" : "●") @p.Direction</span>
                                    <span style="color: var(--text-muted);">@p.Confidence.ToString("F0")%</span>
                                    @{
                                        var tfBg = p.Timeframe == "Weekly" ? "rgba(123,97,255,0.3)" : p.Timeframe == "1H" ? "rgba(255,255,255,0.08)" : "rgba(0,200,200,0.15)";
                                    }
                                    <span style="padding: 0px 4px; border-radius: 2px; background: @tfBg;">@p.Timeframe</span>
                                </div>

                                @if (isSelected)
                                {
                                    <div style="display: flex; gap: 8px; margin-top: 4px; font-size: 0.55rem; font-family: 'JetBrains Mono', monospace;">
                                        <span style="color: #3b82f6;">E: @p.SuggestedEntry.ToString("F2")</span>
                                        <span style="color: #ef4444;">S: @p.SuggestedStop.ToString("F2")</span>
                                        <span style="color: #10b981;">T: @p.SuggestedTarget.ToString("F2")</span>
                                    </div>
                                }
                            </div>
                        }
                    </div>

                    <!-- Chart -->
                    <div id="patternChartContainer" style="width: 100%; height: 480px;"></div>
                </div>

                <!-- Legend -->
                <div style="display: flex; gap: 16px; padding: 8px 16px; border-top: 1px solid var(--border); font-size: 0.65rem; color: var(--text-muted);">
                    <span><span style="display:inline-block; width:12px; height:12px; background:#06b6d4; border-radius:2px; margin-right:4px; vertical-align:middle;"></span>Pattern Candles</span>
                    <span><span style="display:inline-block; width:12px; height:2px; background:#3b82f6; margin-right:4px; vertical-align:middle;"></span>Entry</span>
                    <span><span style="display:inline-block; width:12px; height:2px; background:#ef4444; margin-right:4px; vertical-align:middle;"></span>Stop</span>
                    <span><span style="display:inline-block; width:12px; height:2px; background:#10b981; margin-right:4px; vertical-align:middle;"></span>Target</span>
                    <span><span style="display:inline-block; width:12px; height:2px; background:rgba(16,185,129,0.25); margin-right:4px; vertical-align:middle; border-top:1px dashed rgba(16,185,129,0.4);"></span>Support/Resistance</span>
                </div>
            </div>
        }

        <!-- ═══ PATTERN CARDS ═══ -->
        @if (_result.Patterns.Any(p => p.Timeframe == _chartTimeframe))
        {
            var tfFiltered = _result.Patterns.Where(p => p.Timeframe == _chartTimeframe).ToList();
            <div class="stats-row" style="margin-bottom: 20px;">
                <div class="stat-card">
                    <div class="stat-label"><i class="ph-light ph-trend-up" style="margin-right: 4px;"></i>Bullish</div>
                    <div class="stat-value positive">@tfFiltered.Count(p => p.Direction == "Bullish")</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label"><i class="ph-light ph-trend-down" style="margin-right: 4px;"></i>Bearish</div>
                    <div class="stat-value negative">@tfFiltered.Count(p => p.Direction == "Bearish")</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label"><i class="ph-light ph-minus" style="margin-right: 4px;"></i>Neutral</div>
                    <div class="stat-value">@tfFiltered.Count(p => p.Direction == "Neutral")</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label"><i class="ph-light ph-star" style="margin-right: 4px;"></i>Avg Confidence</div>
                    <div class="stat-value" style="color: var(--accent-cyan);">@(tfFiltered.Average(p => p.Confidence).ToString("F0"))%</div>
                </div>
            </div>

            <div class="pattern-grid">
                @foreach (var p in tfFiltered)
                {
                    var dirColor = p.Direction switch
                    {
                                        "Bullish" => "var(--accent-green)",
                                        "Bearish" => "var(--accent-red)",
                        _ => "var(--accent-amber)"
                    };
                    var dirIcon = p.Direction switch
                    {
                                        "Bullish" => "ph-trend-up",
                                        "Bearish" => "ph-trend-down",
                        _ => "ph-minus"
                    };
                    var dirBadgeClass = p.Direction switch
                    {
                                        "Bullish" => "override-accepted",
                                        "Bearish" => "override-rejected",
                        _ => "override-modified"
                    };
                    var confLevel = p.Confidence >= 75 ? "high" : p.Confidence >= 60 ? "medium" : "low";
                    var gradeColor = p.AIGrade switch
                    {
                                        "A+" or "A" => "var(--accent-green)",
                                        "B+" or "B" => "var(--accent-cyan)",
                                        "C" => "var(--accent-amber)",
                        _ => "var(--accent-red)"
                    };
                    var tfBadgeBg = p.Timeframe == "Weekly" ? "rgba(123,97,255,0.3)" : p.Timeframe == "1H" ? "rgba(255,255,255,0.08)" : "rgba(0,200,200,0.15)";

                    <div class="card pattern-card" style="border-left: 3px solid @dirColor; @(!p.AIValid ? "opacity: 0.5;" : "")">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
                            <div>
                                <div style="font-size: 0.95rem; font-weight: 700; color: var(--text-heading); margin-bottom: 4px;">
                                    <i class="ph-bold @dirIcon" style="color: @dirColor; margin-right: 4px;"></i>@p.PatternName
                                </div>
                                <div style="display: flex; gap: 6px; align-items: center;">
                                    <span style="font-size: 0.6rem; padding: 1px 6px; border-radius: 3px; background: @tfBadgeBg; font-weight: 600;">@p.Timeframe</span>
                                    <span class="override-badge @dirBadgeClass" style="font-size: 0.6rem;">@p.Direction</span>
                                    @if (!string.IsNullOrEmpty(p.AIGrade))
                                    {
                                        <span style="font-family: 'JetBrains Mono', monospace; font-size: 0.65rem; font-weight: 700; color: @gradeColor; background: rgba(0,0,0,0.3); padding: 1px 6px; border-radius: 4px;">
                                            AI: @p.AIGrade
                                        </span>
                                    }
                                    @if (!p.AIValid)
                                    {
                                        <span style="font-size: 0.6rem; color: var(--accent-red);">
                                            <i class="ph-bold ph-x-circle"></i> AI Rejected
                                        </span>
                                    }
                                </div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-family: 'JetBrains Mono', monospace; font-size: 1.1rem; font-weight: 700; color: @dirColor;">@p.Confidence%</div>
                                <div style="font-size: 0.6rem; color: var(--text-muted);">confidence</div>
                            </div>
                        </div>

                        <div class="score-bar" style="margin-bottom: 10px;">
                            <div class="score-bar-fill @confLevel" style="width: @(p.Confidence)%"></div>
                        </div>

                        <p style="font-size: 0.78rem; color: var(--text-secondary); line-height: 1.5; margin-bottom: 8px;">@p.Description</p>

                        @if (!string.IsNullOrEmpty(p.AIReason))
                        {
                            <p style="font-size: 0.75rem; color: var(--accent-cyan); line-height: 1.4; margin-bottom: 12px; font-style: italic;">
                                <i class="ph ph-robot" style="margin-right: 4px;"></i>@p.AIReason
                            </p>
                        }

                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 8px;">
                            <div class="pattern-level">
                                <div class="pattern-level-label">Win Rate</div>
                                <div class="pattern-level-value" style="color: var(--accent-cyan);">@p.HistoricalWinRate%</div>
                            </div>
                            <div class="pattern-level">
                                <div class="pattern-level-label">Entry</div>
                                <div class="pattern-level-value" style="color: var(--accent-blue);">@p.SuggestedEntry.ToString("C")</div>
                            </div>
                            <div class="pattern-level">
                                <div class="pattern-level-label">Stop</div>
                                <div class="pattern-level-value" style="color: var(--accent-red);">@p.SuggestedStop.ToString("C")</div>
                            </div>
                            <div class="pattern-level">
                                <div class="pattern-level-label">Target</div>
                                <div class="pattern-level-value" style="color: var(--accent-green);">@p.SuggestedTarget.ToString("C")</div>
                            </div>
                        </div>
                    </div>
                }
            </div>
        }
        else
        {
            <div class="card" style="text-align: center; padding: 40px;">
                <i class="ph-thin ph-binoculars" style="font-size: 2.5rem; color: var(--text-muted);"></i>
                <p style="color: var(--text-muted); margin-top: 12px;">No patterns match your filters. Try lowering the confidence threshold.</p>
            </div>
        }
    }
    else if (!_scanning && !_hasScanned)
    {
        <div class="card" style="text-align: center; padding: 48px;">
            <i class="ph-thin ph-crosshair" style="font-size: 3rem; color: var(--text-muted);"></i>
            <p style="color: var(--text-muted); font-size: 1.1rem; margin-top: 12px;">Enter a symbol and scan for patterns.</p>
            <p style="color: var(--text-muted); font-size: 0.85rem; margin-top: 4px;">Scans 1H, 4H, Daily, and Weekly timeframes simultaneously. AI synthesizes patterns with weighted regime detection and context layers.</p>
        </div>
    }
</div>

@code {
    private string _symbol = "";
    private decimal _minConfidence = 0;
    private string _direction = "All";
    private string _enableAI = "true";
    private bool _scanning;
    private bool _hasScanned;
    private bool _showDetail;
    private string? _error;
    private ScanResultData? _result;
    private string _chartTimeframe = "Daily";
    private bool _loaded;
    private bool _chartPending;
    private HashSet<int> _selectedPatterns = new();

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender && !_chartPending) return;

        if (firstRender && !_loaded)
        {
            _loaded = true;
            var state = await AuthState.GetAuthenticationStateAsync();
            if (!state.User.Identity?.IsAuthenticated ?? true)
                Nav.NavigateTo("/login");
            return;
        }

        if (_chartPending)
        {
            _chartPending = false;
            // Default to first timeframe that actually has patterns
            if (_result?.Patterns?.Any() == true)
            {
                var preferred = new[] { "Daily", "4H", "Weekly", "1H" };
                _chartTimeframe = preferred.FirstOrDefault(tf => _result.Patterns.Any(p => p.Timeframe == tf)) ?? "Daily";
            }
            await RenderPatternChart();
            AutoSelectMostRecentPattern();
            await UpdateChartSelection();
            StateHasChanged();
        }
    }

    private async Task RunScan()
    {
        _error = null;
        _result = null;
        _showDetail = false;
        _chartTimeframe = "Daily";
        _selectedPatterns.Clear();

        if (string.IsNullOrWhiteSpace(_symbol))
        {
            _error = "Please enter a symbol.";
            return;
        }

        _scanning = true;
        _hasScanned = true;
        StateHasChanged();

        try
        {
            _result = await ScannerApi.ScanSymbolAsync(
                _symbol.Trim().ToUpper(),
                _minConfidence,
                _direction,
                "Daily",
                _enableAI == "true");

            if (_result is null)
                _error = "Failed to scan. Please try again.";
        }
        catch (Exception ex)
        {
            _error = $"Error: {ex.Message}";
        }

        _scanning = false;
        if (_result is not null && _result.ChartCandles.Any())
            _chartPending = true;
        StateHasChanged();
    }

    private async Task QuickScan(string ticker)
    {
        _symbol = ticker;
        await RunScan();
    }

    private async Task HandleKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
            await RunScan();
    }

    private async Task TogglePattern(int index)
    {
        if (_selectedPatterns.Contains(index))
            _selectedPatterns.Remove(index);
        else
            _selectedPatterns.Add(index);

        await UpdateChartSelection();
        StateHasChanged();
    }

    private async Task ClearPatternSelection()
    {
        _selectedPatterns.Clear();
        await JS.InvokeVoidAsync("resetPatternChart");
        StateHasChanged();
    }

    private async Task UpdateChartSelection()
    {
        try
        {
            await JS.InvokeVoidAsync("updatePatternSelection", _selectedPatterns.ToArray());
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Chart selection error: {ex.Message}");
        }
    }

    private async Task SwitchChartTimeframe(string tf)
    {
        if (_chartTimeframe == tf || _result is null) return;
        _chartTimeframe = tf;
        _selectedPatterns.Clear();
        StateHasChanged();
        await RenderPatternChart();
        AutoSelectMostRecentPattern();
        await UpdateChartSelection();
        StateHasChanged();
    }

    /// <summary>
    /// Auto-highlight the most recent pattern for the active chart timeframe.
    /// This gives immediate visual feedback — the freshest signal is always shown.
    /// </summary>
    private void AutoSelectMostRecentPattern()
    {
        if (_result is null) return;

        // Find the pattern matching the current timeframe with the latest end date
        int bestIndex = -1;
        DateTime bestDate = DateTime.MinValue;

        for (int i = 0; i < _result.Patterns.Count; i++)
        {
            var p = _result.Patterns[i];
            if (p.Timeframe == _chartTimeframe && p.EndDate > bestDate)
            {
                bestDate = p.EndDate;
                bestIndex = i;
            }
        }

        _selectedPatterns.Clear();
        if (bestIndex >= 0)
            _selectedPatterns.Add(bestIndex);
    }

    private async Task RenderPatternChart()
    {
        if (_result is null || !_result.ChartCandles.Any()) return;

        // Select candles based on active timeframe
        var activeCandles = _chartTimeframe switch
        {
            "1H" => _result.ChartCandles1H?.Any() == true ? _result.ChartCandles1H : _result.ChartCandles,
            "4H" => _result.ChartCandles4H?.Any() == true ? _result.ChartCandles4H : _result.ChartCandles,
            "Weekly" => _result.ChartCandlesWeekly?.Any() == true ? _result.ChartCandlesWeekly : _result.ChartCandles,
            _ => _result.ChartCandles
        };

        try
        {
            var candleData = activeCandles.Select(c => new
            {
                time = c.Time,
                open = (double)c.Open,
                high = (double)c.High,
                low = (double)c.Low,
                close = (double)c.Close
            }).ToArray();

            var volumeData = activeCandles.Select(c => new
            {
                time = c.Time,
                value = (double)c.Volume,
                color = c.Close >= c.Open ? "rgba(16, 185, 129, 0.3)" : "rgba(239, 68, 68, 0.3)"
            }).ToArray();

            // Build pattern data — filter to selected timeframe for cleaner chart overlay
            var patternsForChart = _result.Patterns
                .Where(p => p.Timeframe == _chartTimeframe)
                .ToList();

            var patterns = patternsForChart.Select(p => new
            {
                startTime = new DateTimeOffset(p.StartDate).ToUnixTimeSeconds(),
                endTime = new DateTimeOffset(p.EndDate).ToUnixTimeSeconds(),
                direction = p.Direction,
                timeframe = p.Timeframe,
                label = $"{p.PatternName} ({p.Confidence:F0}%)",
                patternName = p.PatternName,
                grade = p.AIGrade ?? "",
                entry = (double)p.SuggestedEntry,
                stop = (double)p.SuggestedStop,
                target = (double)p.SuggestedTarget,
                candleCount = p.EndCandleIndex - p.StartCandleIndex + 1
            }).ToArray();

            var keyLevels = _result.Context?.KeyLevels?.Select(l => new
            {
                price = (double)l.Price,
                type = l.Type
            }).ToArray() ?? Array.Empty<object>();

            await JS.InvokeVoidAsync("createPatternChart", "patternChartContainer", candleData, volumeData, patterns, keyLevels);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Chart render error: {ex.Message}");
        }
    }
}
